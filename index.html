<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDMFPIPPDC — Tableau de bord</title>

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Persistance (Vercel) : optionnelle via /api/storage (Vercel KV/Upstash). -->
  <!-- Aucun Firebase/Firestore utilisé. -->

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0b1324;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --primary:#2563eb;
      --primary2:#60a5fa;
      --secondary:#06b6d4;
      --tertiary:#f59e0b;
      --quaternary:#22c55e;
      --danger:#ef4444;
      --warning:#f97316;
      --success:#22c55e;
      --info:#3b82f6;
      --focus: 0 0 0 4px rgba(37,99,235,.25);
    }

    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif; background: radial-gradient(1200px 800px at 10% 10%, rgba(37,99,235,.25), transparent 60%), radial-gradient(1200px 800px at 90% 20%, rgba(6,182,212,.18), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1)); color: var(--text);}

    body.light-theme{
      --bg0:#f6f7fb;
      --bg1:#eef2ff;
      --panel: rgba(255,255,255,.80);
      --panel2: rgba(255,255,255,.92);
      --stroke: rgba(15,23,42,.10);
      --stroke2: rgba(15,23,42,.16);
      --text: rgba(15,23,42,.92);
      --muted: rgba(15,23,42,.70);
      --muted2: rgba(15,23,42,.55);
      --shadow: 0 20px 50px rgba(15,23,42,.10);
      --shadow2: 0 12px 30px rgba(15,23,42,.08);
    }

    /* Utility */
    .is-hidden{display:none !important;}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}

    /* Background shapes */
    .app-container{position:relative; min-height:100vh; display:flex; width:100%; max-width:100vw; overflow-x:hidden;}
    @supports (overflow: clip){
      .app-container{ overflow-x: clip; }
    }
    /* Background shapes: en fixed pour ne jamais créer de scroll parasite */
    .bg-shape{position:fixed; inset:auto; border-radius:999px; filter: blur(40px); opacity:.45; pointer-events:none; max-width:100vw; z-index:0;}
    .shape-1{width:480px; height:480px; left:-160px; top:-120px; background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.85), transparent 60%);}
    .shape-2{width:520px; height:520px; right:-220px; top:60px; background: radial-gradient(circle at 60% 30%, rgba(6,182,212,.85), transparent 60%);}
    .shape-3{width:520px; height:520px; right:20%; bottom:-260px; background: radial-gradient(circle at 40% 50%, rgba(245,158,11,.65), transparent 60%); opacity:.25;}

    /* Sidebar */
    /* IMPORTANT: padding-right réduit pour que le bouton de repli soit visuellement collé au panneau */
    .sidebar{position:sticky; top:0; height:100vh; width:290px; padding:14px 6px 14px 14px; transition: width .25s ease, transform .25s ease; z-index:30; overflow: visible;}
    .sidebar__container{height:100%; background: var(--panel); border:1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow2); display:flex; flex-direction:column; overflow:hidden;}
    .sidebar__header{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px; border-bottom:1px solid var(--stroke);}
    .sidebar__brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px;}
    .sidebar__brand i{font-size:20px; color: var(--primary2);}
    .sidebar__toggle-mobile{display:none; width:38px; height:38px; border-radius:12px; border:1px solid var(--stroke); background:transparent; color:var(--text);}
    .sidebar__profile{padding:14px; border-bottom: 1px solid var(--stroke); display:flex; gap:12px; align-items:center;}
    .profile__avatar{position:relative; width:44px; height:44px;}
    .profile__avatar img{width:44px; height:44px; border-radius:16px; object-fit:cover; border:1px solid var(--stroke); background: var(--soft);}
    .avatar__status{position:absolute; right:-1px; bottom:-1px; width:12px; height:12px; border-radius:999px; background: var(--success); border:2px solid rgba(0,0,0,.25);}
    body.light-theme .avatar__status{border-color: rgba(255,255,255,.7)}
    .profile__details h3{font-size:13px; font-weight:900; margin:0;}
    .profile__details span{font-size:12px; color: var(--muted2);}

    .sidebar__menu{flex:1; overflow:auto; padding: 10px 10px 16px;}
    .sidebar__category{margin-top:10px;}
    .sidebar__title{font-size:11px; text-transform:uppercase; letter-spacing:.12em; color: var(--muted2); margin:10px 8px; font-weight:800;}
    .nav__list{display:flex; flex-direction:column; gap:6px;}
    .nav__item{list-style:none;}
    .nav__divider{height:1px; background: var(--stroke); margin: 10px 8px;}

    .nav__link{display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 10px 12px; border-radius: 14px; color: var(--text); text-decoration:none; border:1px solid transparent; cursor:pointer; user-select:none;}
    .nav__link:hover{background: rgba(255,255,255,.06); border-color: var(--stroke);}
    body.light-theme .nav__link:hover{background: rgba(15,23,42,.04)}
    .nav__link.active{background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(6,182,212,.12)); border-color: rgba(37,99,235,.25);}
    .nav__link-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .nav__icon{font-size:18px; color: var(--muted);}
    .nav__name{font-size:13px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .nav__badge{min-width: 26px; height: 20px; padding:0 8px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; font-size:12px; font-weight:900; background: rgba(255,255,255,.10); border:1px solid var(--stroke);}

    .sidebar--collapsed{width:88px;}
    .sidebar--collapsed .nav__name,
    .sidebar--collapsed .sidebar__title,
    .sidebar--collapsed .profile__details,
    .sidebar--collapsed .nav__badge{display:none;}
    .sidebar--collapsed .sidebar__brand span{display:none;}
    .sidebar--collapsed .sidebar__profile{justify-content:center;}
    .sidebar--collapsed .nav__link{justify-content:center;}

    /* Animation élégante lors du collapse (sans effet glass) */
    .sidebar__container{transition: border-color .25s ease, box-shadow .25s ease;}
    .sidebar__menu, .sidebar__profile{transition: opacity .22s ease, transform .22s ease;}
    .sidebar--collapsed .sidebar__menu,
    .sidebar--collapsed .sidebar__profile{
      opacity: .92;
      transform: translateX(-2px);
    }

    /* ===== Sidebar toggle rail (entre sidebar et contenu) ===== */
    .sidebar-toggle-rail{
      width: 30px;
      flex: 0 0 30px;
      position: sticky;
      top: 0;
      height: 100vh;
      z-index: 35;
      display:flex;
      /* le bouton est sticky (top:%), donc on évite de le recentrer via align-items */
      align-items: stretch;
      justify-content:center;
      pointer-events: none; /* seul le bouton est cliquable */
    }

    /* Desktop toggle: placé ENTRE le sidebar et le contenu (pas de calcul JS) */
    .sidebar-desktop-toggle{
      position: sticky;
      /* Légèrement plus haut que le centre pour un meilleur équilibre visuel */
      top: 46%;
      transform: translateY(-50%);
      z-index:110;
      width:44px;
      height:44px;
      border-radius: 18px;
      border: 1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color: var(--text);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 0;
      cursor:pointer;
      pointer-events: auto;
      transition:
        transform .22s ease,
        box-shadow .22s ease,
        background .22s ease,
        border-color .22s ease;
    }
    /* Small "edge" highlight on the left to visually attach to the sidebar */
    .sidebar-desktop-toggle::after{
      content:"";
      position:absolute;
      left:6px;
      top:12px;
      bottom:12px;
      width:3px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
      opacity:.65;
      box-shadow: 0 10px 16px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .sidebar-desktop-toggle::before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.35), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(6,182,212,.25), transparent 55%);
      opacity:.0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .sidebar-desktop-toggle:hover{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border-color: rgba(124,58,237,.35);
      box-shadow: 0 22px 52px rgba(0,0,0,.55);
      transform: translateY(-50%) scale(1.02);
    }
    /* halo plus subtil */
    .sidebar-desktop-toggle:hover::before{ opacity: .72; }
    .sidebar-desktop-toggle:active{ transform: translateY(-50%) scale(.96); }
    .sidebar-desktop-toggle i{ font-size: 20px; transition: transform .28s cubic-bezier(.2,.9,.2,1); }
    .sidebar-desktop-toggle.is-collapsed i{ transform: rotate(180deg); }

    body.light-theme .sidebar-desktop-toggle{
      background: linear-gradient(180deg, rgba(2,6,23,.05), rgba(2,6,23,.02));
      box-shadow: 0 18px 40px rgba(2,6,23,.14);
      border-color: rgba(15,23,42,.16);
    }
    body.light-theme .sidebar-desktop-toggle:hover{
      border-color: rgba(124,58,237,.28);
      box-shadow: 0 22px 52px rgba(2,6,23,.16);
    }


    /* ===== Page load animation (elegant, subtle) ===== */
    body.app-boot .sidebar__container,
    body.app-boot .header,
    body.app-boot .stats-overview,
    body.app-boot .dashboard-grid,
    body.app-boot .card,
    body.app-boot .dashboard-card{
      opacity: 0;
      transform: translateY(10px);
      filter: saturate(1.02);
    }

    body.app-boot .sidebar__container{
      transform: translateX(-10px);
    }

    body.app-boot .sidebar-desktop-toggle{
      opacity: 0;
      transform: translateY(-50%) translateX(-8px) scale(.88);
    }

    @keyframes bootIn{
      from{ opacity: 0; transform: translateY(10px); }
      to{ opacity: 1; transform: none; }
    }
    @keyframes bootInLeft{
      from{ opacity: 0; transform: translateX(-10px); }
      to{ opacity: 1; transform: none; }
    }
    @keyframes bootToggle{
      0%{ opacity: 0; transform: translateY(-50%) translateX(-10px) scale(.88); }
      65%{ opacity: 1; transform: translateY(-50%) translateX(0) scale(1.06); }
      100%{ opacity: 1; transform: translateY(-50%) translateX(0) scale(1); }
    }

    body:not(.app-boot) .sidebar__container{
      animation: bootInLeft .58s cubic-bezier(.2,.95,.2,1) both;
    }
    body:not(.app-boot) .header{
      animation: bootIn .55s cubic-bezier(.2,.95,.2,1) both;
      animation-delay: .06s;
    }
    body:not(.app-boot) .stats-overview{
      animation: bootIn .55s cubic-bezier(.2,.95,.2,1) both;
      animation-delay: .12s;
    }
    body:not(.app-boot) .dashboard-grid{
      animation: bootIn .55s cubic-bezier(.2,.95,.2,1) both;
      animation-delay: .18s;
    }
    body:not(.app-boot) .sidebar-desktop-toggle{
      animation: bootToggle .62s cubic-bezier(.16,1,.25,1) both;
      animation-delay: .20s;
    }

    /* Main content */
    .main-content{flex:1; padding: 14px 14px 24px; min-width:0; position:relative; z-index:1;}
    .header{position:sticky; top: 14px; z-index:25; background: var(--panel); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow2); display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 12px;}
    .header__left{display:flex; align-items:center; gap:12px; min-width:0; flex:1;}
    .header__right{min-width:0;}

    /* ===== Firebase / Firestore banner (diagnostic production) ===== */
    .firebase-alert{
      margin: 12px 0 0;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      overflow:hidden;
      position:relative;
    }

    /* L’utilisateur souhaite masquer le banner (trop intrusif) */
    #firebase-alert{ display:none !important; }

    /* ===== Firebase status pill (floating, premium) ===== */
    .firebase-pill{
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 120;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
      box-shadow: var(--shadow2);
      color: var(--text);
      font-weight: 950;
      font-size: 11px;
      letter-spacing: .2px;
      user-select: none;
      cursor: pointer;
      overflow: hidden;
      /* compact by default to avoid blocking UI */
      max-width: 56px;
      transition: max-width .28s cubic-bezier(.16,1,.25,1), border-color .22s ease, box-shadow .22s ease, transform .22s ease;
      --pill-accent: rgba(34,197,94,1);
      --pill-bg: rgba(34,197,94,.12);
      --pill-glow: rgba(34,197,94,.20);
    }
    .firebase-pill::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(280px 120px at 12% 10%, var(--pill-glow), transparent 60%),
        radial-gradient(220px 100px at 90% 0%, rgba(124,58,237,.10), transparent 62%);
      opacity: .85;
      pointer-events:none;
    }
    .firebase-pill__dot{
      width:9px;
      height:9px;
      border-radius: 999px;
      background: var(--pill-accent);
      box-shadow: 0 0 0 4px var(--pill-bg);
      position: relative;
      z-index:1;
      animation: pillPulse 1.9s ease-in-out infinite;
    }
    @keyframes pillPulse{
      0%,100%{ transform: scale(1); opacity: .92; }
      50%{ transform: scale(1.08); opacity: 1; }
    }
    .firebase-pill i{ font-size: 16px; color: var(--pill-accent); position:relative; z-index:1; }
    .firebase-pill span{ position:relative; z-index:1; white-space:nowrap; }

    /* Smoothly reveal text on hover/focus without taking space when compact */
    #firebase-pill-text{
      max-width: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-width .28s cubic-bezier(.16,1,.25,1), opacity .20s ease;
    }
    .firebase-pill:hover,
    .firebase-pill:focus,
    .firebase-pill:focus-within{
      max-width: 260px;
    }
    .firebase-pill:hover #firebase-pill-text,
    .firebase-pill:focus #firebase-pill-text,
    .firebase-pill:focus-within #firebase-pill-text{
      max-width: 220px;
      opacity: 1;
    }

    .firebase-pill.ok{ --pill-accent: rgba(34,197,94,1); --pill-bg: rgba(34,197,94,.12); --pill-glow: rgba(34,197,94,.22); }
    .firebase-pill.warn{ --pill-accent: rgba(249,115,22,1); --pill-bg: rgba(249,115,22,.12); --pill-glow: rgba(249,115,22,.20); }
    .firebase-pill.off{ --pill-accent: rgba(148,163,184,1); --pill-bg: rgba(148,163,184,.12); --pill-glow: rgba(148,163,184,.16); }

    .firebase-pill:hover{ border-color: var(--stroke2); box-shadow: var(--shadow); }
    .firebase-pill:active{ transform: translateY(1px); }
    .firebase-pill:focus{ outline: none; box-shadow: var(--shadow), var(--focus); }

    @media (max-width: 880px){
      .firebase-pill{ left: 12px; bottom: 12px; padding: 8px 9px; max-width: 52px; }
      .firebase-pill:hover, .firebase-pill:focus, .firebase-pill:focus-within{ max-width: 220px; }
    }
    .firebase-alert::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(420px 200px at 10% 10%, rgba(239,68,68,.16), transparent 60%),
        radial-gradient(420px 200px at 90% 0%, rgba(6,182,212,.10), transparent 62%);
      opacity:.9;
      pointer-events:none;
    }
    .firebase-alert__left{display:flex; gap:10px; align-items:flex-start; min-width:0; position:relative; z-index:1;}
    .firebase-alert__icon{
      width:42px;
      height:42px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(239,68,68,.12);
      color: rgba(239,68,68,1);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 42px;
    }
    .firebase-alert__icon i{font-size:20px;}
    .firebase-alert__title{margin:0; font-weight:950; font-size: 13px; letter-spacing:.2px;}
    .firebase-alert__msg{margin:4px 0 0; color: var(--muted2); font-size:12px; font-weight:900; line-height:1.45; overflow-wrap:anywhere;}
    .firebase-alert__actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; position:relative; z-index:1;}
    .firebase-alert__hint{color: var(--muted2); font-size: 12px; font-weight:900; margin-top:6px;}
    .firebase-alert__code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 11px; color: var(--muted); background: rgba(255,255,255,.03); border:1px solid var(--stroke); padding: 6px 8px; border-radius: 12px; margin-top: 8px; overflow:auto; max-width: 100%;}

    body.light-theme .firebase-alert::before{
      background:
        radial-gradient(420px 200px at 10% 10%, rgba(239,68,68,.10), transparent 60%),
        radial-gradient(420px 200px at 90% 0%, rgba(6,182,212,.07), transparent 62%);
    }
    .header__menu-toggle{width:40px; height:40px; border-radius: 14px; border:1px solid var(--stroke); background:transparent; color: var(--text); display:none;}

    .header__search{display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 16px; border: 1px solid var(--stroke); background: rgba(255,255,255,.05); flex:1; max-width: min(520px, 50vw); min-width: 0;}
    body.light-theme .header__search{background: rgba(15,23,42,.03)}
    .header__search i{color: var(--muted2);}
    .header__search input{background:transparent; outline:none; border:none; width:100%; font-size:13px; color: var(--text);}
    .header__search input::placeholder{color: var(--muted2)}

    .header__right{display:flex; align-items:center; gap:12px;}

    /* Notifications */
    .header__notifications{position:relative;}
    .notifications__trigger{width:44px; height:44px; border-radius: 16px; border:1px solid var(--stroke); display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.05); cursor:pointer; position:relative;}
    body.light-theme .notifications__trigger{background: rgba(15,23,42,.03)}
    .notifications__badge{position:absolute; right:8px; top:8px; width:18px; height:18px; border-radius:999px; background: var(--danger); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; border:2px solid rgba(0,0,0,.20);}
    body.light-theme .notifications__badge{border-color: rgba(255,255,255,.6)}

    .notifications__dropdown{position:absolute; right:0; top:54px; width: min(360px, calc(100vw - 20px)); max-width: calc(100vw - 20px); max-height: min(520px, calc(100vh - 140px)); background: var(--panel2); border:1px solid var(--stroke); border-radius: 18px; box-shadow: var(--shadow); overflow:hidden; display:none; z-index: 250; transform-origin: top right; contain: layout paint;}
    .notifications__dropdown.open{display:flex; flex-direction:column; min-height:0; animation: dropdownIn .16s cubic-bezier(.16,1,.25,1) both;}
    .dropdown__header{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--stroke);}
    .dropdown__header h3{margin:0; font-weight:900; font-size:14px;}
    .mark-read{background:transparent; border:none; color: var(--primary2); font-weight:900; font-size:12px; cursor:pointer;}
    .dropdown__items{flex:1; min-height:0; overflow:auto;}
    .notification__item{display:flex; gap:10px; padding:12px; border-bottom:1px solid var(--stroke); cursor:pointer; user-select:none;}
    .notification__item:hover{background: rgba(255,255,255,.04)}
    body.light-theme .notification__item:hover{background: rgba(15,23,42,.03)}
    .notification__item.unread{background: rgba(37,99,235,.08)}
    .notification__icon{width:36px; height:36px; border-radius: 14px; display:flex; align-items:center; justify-content:center; border:1px solid var(--stroke); background: rgba(255,255,255,.06);}
    .notification__icon.mail{color: var(--secondary)}
    .notification__icon.contract{color: var(--tertiary)}
    .notification__icon.alert{color: var(--danger)}
    .notification__icon.info{color: var(--info)}
    .notification__content p{margin:0; font-weight:800; font-size:13px;}
    .notification__content span{color: var(--muted2); font-size:12px;}
    .dropdown__footer{padding:10px 12px;}
    .dropdown__footer a{color: var(--primary2); text-decoration:none; font-weight:900; font-size:12px;}

    /* Profile dropdown */
    .header__profile{position:relative; display:flex; align-items:center; gap:10px; padding: 8px 10px; border-radius: 16px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); cursor:pointer; user-select:none;}
    body.light-theme .header__profile{background: rgba(15,23,42,.03)}
    .header__profile img{width:34px; height:34px; border-radius: 14px; object-fit:cover; border:1px solid var(--stroke);}
    .header__profile span{font-size:13px; font-weight:900; max-width: 140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .profile__dropdown{position:absolute; right:0; top:54px; width: min(320px, calc(100vw - 20px)); max-width: calc(100vw - 20px); max-height: min(520px, calc(100vh - 140px)); background: var(--panel2); border:1px solid var(--stroke); border-radius: 18px; box-shadow: var(--shadow); overflow:hidden; display:none; z-index: 250; transform-origin: top right; contain: layout paint;}
    .profile__dropdown.open{display:flex; flex-direction:column; min-height:0; animation: dropdownIn .16s cubic-bezier(.16,1,.25,1) both;}
    .profile__dropdown .dropdown__header{gap:10px;}
    .header__avatar img{width:42px; height:42px; border-radius: 16px; border: 1px solid var(--stroke); object-fit:cover;}
    .header__info h3{margin:0; font-weight:900; font-size:14px;}
    .header__info span{color: var(--muted2); font-size:12px;}
    .notifications__dropdown .dropdown__items{padding: 0;}
    .profile__dropdown .dropdown__items{padding: 8px;}
    .dropdown__link{display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius: 14px; text-decoration:none; color: var(--text); border:1px solid transparent;}
    .dropdown__link:hover{background: rgba(255,255,255,.06); border-color: var(--stroke)}
    body.light-theme .dropdown__link:hover{background: rgba(15,23,42,.04)}
    .dropdown__divider{height:1px; background: var(--stroke); margin: 8px 6px;}

    /* Content */
    .content-wrapper{padding-top: 16px;}
    .section{display:none;}
    .active-section{display:block;}

    .section__header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;}
    .section__title{font-size: 20px; font-weight: 950; letter-spacing:.2px; margin: 0;}
    .section__subtitle{margin: 4px 0 0; color: var(--muted2); font-size: 13px;}

    .section__actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}

    /* Cards */
    .card, .dashboard-card{background: var(--panel); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow2); overflow:hidden;}
    .card__header, .dashboard-card__header{display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom:1px solid var(--stroke);}
    .card__title, .dashboard-card__title{display:flex; align-items:center; gap:10px; font-weight:950; font-size:14px; margin:0;}
    .card__title i, .dashboard-card__title i{color: var(--primary2)}
    .card__content, .dashboard-card__content{padding: 14px;}
    .dashboard-card__footer{padding: 12px 14px; border-top:1px solid var(--stroke);}

    .dashboard-grid{display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;}
    .activity-summary{grid-column: span 7;}
    .agent-performance{grid-column: span 5;}
    .recent-imputations{grid-column: span 6;}
    .recent-arrivals{grid-column: span 6;}
    .conventions-overview{grid-column: span 7;}
    .commission-dashboard-card{grid-column: span 5;}

    /* Stats */
    .stats-overview{display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-bottom: 14px; align-items: start;}
    .stats-card{grid-column: span 3; align-self: start; min-height: 132px; background: var(--panel); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow2); position:relative; overflow:hidden; display:flex; gap:12px; padding: 12px 14px;}
    .stats-card__icon{width:44px; height:44px; border-radius: 16px; border:1px solid var(--stroke); display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.06);}
    .stats-card__icon i{font-size:20px;}
    .stats-card__content{flex:1; min-width:0;}
    .stats-card__title{margin: 2px 0 6px; font-weight:900; font-size: 12px; color: var(--muted)}
    .stats-card__number{font-size: 22px; font-weight: 950; letter-spacing:.2px;}
    .stats-card__trend{display:flex; gap:8px; align-items:center; font-size:11px; margin-top: 6px; color: var(--muted2); flex-wrap:wrap}
    .stats-card__trend i{color: var(--primary2)}
    .stats-card__trend.positive i{color: var(--success)}
    .stats-card__trend.negative i{color: var(--danger)}
    .trend-pill{display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); color: var(--muted); font-weight:900;}
    .trend-pill b{color: var(--text); font-weight:950;}
    body.light-theme .trend-pill{background: rgba(2,6,23,.03);}
    .stats-card__chart{width: 90px; height: 56px; display:flex; align-items:center; justify-content:flex-end; opacity:.9;}
    .stats-card__chart canvas{width: 90px !important; height: 56px !important;}

    .stats-card--primary .stats-card__icon{background: rgba(37,99,235,.16)}
    .stats-card--primary .stats-card__icon i{color: var(--primary2)}
    .stats-card--secondary .stats-card__icon{background: rgba(6,182,212,.16)}
    .stats-card--secondary .stats-card__icon i{color: var(--secondary)}
    .stats-card--tertiary .stats-card__icon{background: rgba(245,158,11,.16)}
    .stats-card--tertiary .stats-card__icon i{color: var(--tertiary)}
    .stats-card--quaternary .stats-card__icon{background: rgba(34,197,94,.16)}
    .stats-card--quaternary .stats-card__icon i{color: var(--quaternary)}

    .stats-card--document-types{grid-column: span 3;}
    .stats-card--contentieux{grid-column: span 3;}
    .stats-card--mobilisation{grid-column: span 3;}

    /* ===== Mobilisation (nouvelle carte élégante) ===== */
    .mobilisation-wrap{display:flex; flex-direction:column; gap:10px; margin-top: 10px;}
    .mobilisation-head{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .mobilisation-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .mobilisation-icon{width:40px; height:40px; border-radius: 16px; border:1px solid var(--stroke); background: rgba(6,182,212,.12); color: var(--secondary); display:flex; align-items:center; justify-content:center;}
    .mobilisation-icon i{font-size:18px;}
    .mobilisation-label{font-size:12px; color: var(--muted2); font-weight:900;}
    .mobilisation-value{font-size: 18px; font-weight: 950;}
    .mobilisation-chip{display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border:1px solid var(--stroke); background: rgba(6,182,212,.10); color: var(--secondary); font-weight: 950; font-size: 11px; white-space:nowrap;}

    .mobilisation-bar{height:12px; border-radius:999px; border:1px solid var(--stroke); background: var(--soft); overflow:hidden;}
    .mobilisation-fill{height:100%; border-radius:999px; width:0%; transition: width .45s ease; background: linear-gradient(90deg, rgba(6,182,212,.95), rgba(56,189,248,.75));}

    .mobilisation-footer{display:flex; gap:8px; flex-wrap:wrap;}

    /* ===== Références (Arrivées) — carte premium (mieux disposée) ===== */
    .stats-card--refs{grid-column: span 3; align-self: start; flex-direction:column; gap:10px;}
    .stats-card--refs .stats-card__icon{ width:42px; height:42px; border-radius:16px; }
    .stats-card--refs .stats-card__content{min-height:0; width:100%;}

    /* Grid layout (2 colonnes) pour une meilleure densité visuelle */
    .refs-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top: 10px;
    }

    .ref-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      min-width: 0;
      transition: border-color .18s ease, transform .18s ease, background .18s ease;
    }
    .ref-pill:hover{ border-color: var(--stroke2); transform: translateY(-1px); background: rgba(255,255,255,.05); }
    body.light-theme .ref-pill{ background: rgba(2,6,23,.02); }
    body.light-theme .ref-pill:hover{ background: rgba(2,6,23,.03); }

    .ref-pill__icon{
      width:36px;
      height:36px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--soft);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 36px;
      box-shadow: 0 12px 22px rgba(0,0,0,.16);
    }
    body.light-theme .ref-pill__icon{ box-shadow: 0 12px 22px rgba(15,23,42,.10); }
    .ref-pill__icon i{ font-size: 18px; }

    .ref-pill__meta{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .ref-pill__label{font-size:10.5px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; color: var(--muted2);}
    .ref-pill__value{font-size: 16px; font-weight: 950; color: var(--text); line-height:1.1;}

    /* Accent colors per reference */
    .ref-pill.cab .ref-pill__icon{ background: rgba(6,182,212,.10); color: var(--secondary); }
    .ref-pill.dudu .ref-pill__icon{ background: rgba(37,99,235,.12); color: var(--primary2); }
    .ref-pill.dguf .ref-pill__icon{ background: rgba(34,197,94,.12); color: var(--success); }
    .ref-pill.ddu .ref-pill__icon{ background: rgba(245,158,11,.12); color: var(--tertiary); }
    .ref-pill.pce .ref-pill__icon{ background: rgba(59,130,246,.12); color: var(--info); }

    /* Full width rows */
    .ref-pill--wide{ grid-column: 1 / -1; }
    .refs-footer{ grid-column: 1 / -1; display:flex; gap:8px; flex-wrap:wrap; }

    @media (max-width: 420px){
      .refs-grid{ grid-template-columns: 1fr; }
      .ref-pill--wide{ grid-column: auto; }
      .refs-footer{ grid-column: auto; }
    }

    /* ===== Types de documents (premium) ===== */
    .doc-types{display:flex; flex-direction:column; gap:10px; margin-top: 10px;}
    .doc-type-block{border:1px solid var(--stroke); border-radius: 18px; padding: 10px 10px; background: rgba(255,255,255,.03);}
    body.light-theme .doc-type-block{background: rgba(2,6,23,.02)}

    .doc-type-head{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .doc-type-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .doc-type-dot{width:10px; height:10px; border-radius:999px; box-shadow: 0 12px 16px rgba(0,0,0,.22);}    
    .doc-type-dot.etatique{background: linear-gradient(180deg, rgba(96,165,250,1), rgba(37,99,235,1));}
    .doc-type-dot.prive{background: linear-gradient(180deg, rgba(34,211,238,1), rgba(6,182,212,1));}
    .doc-type-name{font-weight:950; font-size:12px; letter-spacing:.06em;}
    .doc-type-meta{color: var(--muted2); font-size:11px; font-weight:900;}
    .doc-type-count{font-weight:950; font-size: 14px;}

    .doc-type-bar{height:10px; border-radius:999px; border:1px solid var(--stroke); overflow:hidden; background: var(--soft);}
    .doc-type-fill{height:100%; border-radius:999px; transition: width .4s ease;}
    .doc-type-fill.etatique{background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(96,165,250,.75));}
    .doc-type-fill.prive{background: linear-gradient(90deg, rgba(6,182,212,.95), rgba(56,189,248,.75));}

    .doc-types-footer{display:flex; gap:8px; flex-wrap:wrap; margin-top: 2px;}
    .doc-types-chip{display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 999px; border:1px solid var(--stroke); background: rgba(255,255,255,.03); color: var(--muted); font-weight: 950; font-size: 11px;}
    body.light-theme .doc-types-chip{background: rgba(2,6,23,.03)}
    .doc-types-chip b{color: var(--text); font-weight: 950;}

    /* ===== Contentieux (sans cercle) — simplified ===== */
    .contentieux-wrapper{display:flex; flex-direction:column; gap:10px; margin-top: 8px;}
    .contentieux-item{display:flex; align-items:center; gap:10px;}
    .contentieux-icon{width:38px; height:38px; border-radius: 16px; border:1px solid var(--stroke); display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.06); color: var(--tertiary)}
    .contentieux-label{font-size:12px; color: var(--muted2)}
    .contentieux-count{font-size: 18px; font-weight:950}

    /* ===== Deploy checklist (Firebase) ===== */
    .deploy-grid{display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:10px;}
    .deploy-item{grid-column: span 6; display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px; border:1px solid var(--stroke); border-radius: 18px; background: var(--soft); min-width:0;}
    .deploy-left{min-width:0;}
    .deploy-label{font-weight:950; font-size: 13px; letter-spacing:.2px;}
    .deploy-hint{margin-top:4px; color: var(--muted2); font-size: 12px; font-weight:900;}
    .deploy-status{flex:0 0 auto; padding: 7px 10px; border-radius: 999px; border:1px solid var(--stroke); font-weight:950; font-size: 11px; letter-spacing:.08em; text-transform:uppercase; color: var(--muted); background: rgba(255,255,255,.03);}
    .deploy-status.ok{ color: rgba(34,197,94,1); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .deploy-status.warn{ color: rgba(249,115,22,1); border-color: rgba(249,115,22,.35); background: rgba(249,115,22,.10); }
    .deploy-status.err{ color: rgba(239,68,68,1); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    @media (max-width: 880px){
      .deploy-item{grid-column: span 12;}
    }

    /* Buttons */
    .btn{display:inline-flex; align-items:center; gap:8px; padding: 10px 12px; border-radius: 14px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); color: var(--text); font-weight:900; font-size:13px; cursor:pointer; user-select:none;}
    body.light-theme .btn{background: rgba(15,23,42,.03)}
    .btn:hover{border-color: var(--stroke2);}
    .btn:focus{outline:none; box-shadow: var(--focus)}
    .btn--primary{background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(96,165,250,.75)); border-color: rgba(37,99,235,.35)}
    .btn--primary:hover{filter: brightness(1.05)}
    .btn--outline{background: transparent;}
    .btn--danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .btn--link{background: transparent; border: none; padding: 0; color: var(--primary2);}
    .btn--sm{padding: 8px 10px; border-radius: 12px; font-size:12px;}

    .btn-icon{width:38px; height:38px; border-radius: 14px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); color: var(--text); display:flex; align-items:center; justify-content:center; cursor:pointer;}
    body.light-theme .btn-icon{background: rgba(15,23,42,.03)}
    .btn-icon:hover{border-color: var(--stroke2)}

    /* Date picker chip */
    .date-picker{display:flex; align-items:center; gap:8px; padding: 10px 12px; border-radius: 14px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); color: var(--muted); font-weight:900; font-size:12px; cursor:pointer; user-select:none;}
    body.light-theme .date-picker{background: rgba(15,23,42,.03)}
    .date-picker:hover{border-color: var(--stroke2)}

    /* Dashboard range dropdown */
    .range-menu{
      position: fixed;
      z-index: 520;
      width: 260px;
      max-width: calc(100vw - 20px);
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 8px;
      display:none;
      transform-origin: top right;
      contain: layout paint;
    }
    .range-menu.open{display:block; animation: dropdownIn .14s cubic-bezier(.16,1,.25,1) both;}
    .range-menu__title{font-size:11px; letter-spacing:.12em; text-transform:uppercase; color: var(--muted2); font-weight:950; padding: 8px 10px 6px;}
    .range-option{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      font-weight:950;
      font-size: 13px;
      cursor:pointer;
      text-align:left;
    }
    .range-option:hover{ background: var(--soft2); border-color: var(--stroke); }
    .range-option.is-active{
      background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(6,182,212,.12));
      border-color: rgba(124,58,237,.25);
    }
    .range-option.is-active::after{ content:"\eb7b"; font-family:'remixicon' !important; color: var(--primary2); }

    /* Forms */
    .form__grid{display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px;}
    .form__group{grid-column: span 6; display:flex; flex-direction:column; gap:8px;}
    .form__group--full{grid-column: span 12;}
    .form__label{font-size:12px; font-weight:900; color: var(--muted)}
    .form__input-group{display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 14px; border: 1px solid var(--stroke); background: rgba(255,255,255,.05);}
    body.light-theme .form__input-group{background: rgba(15,23,42,.03)}
    .input-icon{color: var(--muted2)}
    .form__control{width:100%; background:transparent; border:none; outline:none; color: var(--text); font-size:13px;}
    .form__control::placeholder{color: var(--muted2)}

    /* Selects (premium + theme-friendly) */
    select.form__control{appearance:none; cursor:pointer; padding-right: 28px;}
    select.form__control option{background: var(--panel2); color: var(--text);}
    select.form__control optgroup{background: var(--panel2); color: var(--muted);}
    body.light-theme select.form__control option{background: #ffffff; color: rgba(2,6,23,.92);}
    body.light-theme select.form__control optgroup{background: #ffffff; color: rgba(2,6,23,.68);}

    .form__input-group:focus-within{border-color: rgba(6,182,212,.35); box-shadow: var(--focus)}

    /* Add a consistent chevron for selects inside input-groups */
    .form__input-group.select-group{position:relative; padding-right: 44px;}
    .select-chevron{position:absolute; right: 12px; top:50%; transform: translateY(-50%); color: var(--muted2); pointer-events:none;}
    .select-chevron i{font-size:18px;}

    /* ===== Custom Select (ultra stylé) ===== */
    /* IMPORTANT: ne pas casser les formulaires si le JS n'initialise pas le custom select.
       On ne cache le <select> natif que lorsque le groupe est réellement “enhanced”. */
    .select-group.is-enhanced select.form__control{ 
      /* keep for value + form submit, but hide native UI */
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
    }
    .select-ui{ 
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding-right: 26px; /* room before chevron */
      user-select:none;
      cursor:pointer;
    }
    .select-ui__value{ 
      font-weight:950;
      font-size:13px;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .select-ui__placeholder{ color: var(--muted2); font-weight:900; }

    .select-menu{
      position: fixed;
      z-index: 500;
      width: min(420px, calc(100vw - 16px));
      max-height: min(360px, calc(100vh - 120px));
      overflow:auto;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: var(--panel2);
      box-shadow: var(--shadow);
      padding: 8px;
      display:none;
      transform-origin: top left;
      contain: layout paint;
    }
    .select-menu.open{ display:block; animation: dropdownIn .14s cubic-bezier(.16,1,.25,1) both; }

    .select-option{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid transparent;
      color: var(--text);
      font-weight:900;
      font-size: 13px;
      cursor:pointer;
    }
    .select-option:hover{ background: var(--soft2); border-color: var(--stroke); }
    .select-option.is-selected{ 
      background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(6,182,212,.12));
      border-color: rgba(124,58,237,.25);
    }
    .select-option.is-selected::after{ content:"\eb7b"; font-family:'remixicon' !important; color: var(--primary2); }

    .select-option__meta{ color: var(--muted2); font-weight:900; font-size: 12px; }

    .select-search{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--soft);
      margin-bottom: 8px;
    }
    .select-search i{ color: var(--muted2); }
    .select-search input{ width:100%; background: transparent; border:none; outline:none; color: var(--text); font-weight:900; font-size: 13px; }
    .select-search input::placeholder{ color: var(--muted2); font-weight:900; }

    /* Mobile: menu behaves like sheet */
    @media (max-width: 880px){
      .select-menu{
        left: 8px !important;
        right: 8px !important;
        width: auto !important;
        bottom: 8px !important;
        top: auto !important;
        max-height: calc(100vh - 16px) !important;
        border-radius: 22px;
        transform-origin: bottom left;
      }
    }

    textarea.form__control{resize: vertical; min-height: 92px;}

    .form__actions{display:flex; gap:10px; justify-content:flex-end; padding-top: 14px; border-top: 1px solid var(--stroke); margin-top: 14px;}


    /* Tables */
    .table-container{overflow:auto;}
    .data-table{width:100%; border-collapse:separate; border-spacing:0; min-width: 720px;}

    /* Small screens: avoid forcing huge min widths; keep table scroll inside container */
    @media (max-width: 640px){
      .data-table{ min-width: 620px; }
    }
    .data-table thead th{position:sticky; top:0; background: var(--panel2); border-bottom: 1px solid var(--stroke); color: var(--muted); text-align:left; font-size:12px; font-weight:950; padding: 12px 12px;}
    .data-table tbody td{border-bottom: 1px solid var(--stroke); padding: 12px 12px; font-size:13px; color: var(--text); vertical-align:top;}
    .data-table tbody tr:hover{background: rgba(255,255,255,.04)}
    body.light-theme .data-table tbody tr:hover{background: rgba(15,23,42,.03)}

    .pagination{padding: 12px 14px; color: var(--muted2); font-size:12px;}

    /* Search/filter */
    .search-container{display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 14px; border: 1px solid var(--stroke); background: rgba(255,255,255,.05);}
    body.light-theme .search-container{background: rgba(15,23,42,.03)}
    .search-container input{background:transparent; border:none; outline:none; color: var(--text); font-size:13px; width:220px;}
    .search-container i{color: var(--muted2)}

    .filter-container{display:flex; align-items:center; position:relative;}
    .filter-select{padding: 10px 40px 10px 12px; border-radius: 14px; border: 1px solid var(--stroke); background: rgba(255,255,255,.05); color: var(--text); font-size:13px; font-weight:900; outline:none; appearance:none; cursor:pointer;}
    body.light-theme .filter-select{background: rgba(15,23,42,.03)}

    /* Chevron for filter selects */
    .filter-container--select::after{
      content:"\ea4e"; /* ri-arrow-down-s-line */
      font-family: 'remixicon' !important;
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted2);
      pointer-events:none;
      font-size: 18px;
    }

    /* Dashboard blocks */
    .activity-chart-wrapper{
      height: 320px;
      max-width:100%;
      padding: 6px 6px 2px;
      border: 1px solid var(--stroke);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 62%);
    }
    body.light-theme .activity-chart-wrapper{
      background: linear-gradient(180deg, rgba(2,6,23,.035), transparent 62%);
      border-color: rgba(15,23,42,.14);
    }
    .activity-chart-wrapper canvas{width: 100% !important; height: 320px !important; max-width:100% !important;}
    canvas{max-width:100% !important;}

    /* Activity summary: legend (stylé + différencié par liste) */
    .activity-legend{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: var(--soft);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      min-width: 160px;
      flex: 1 1 180px;
    }
    body.light-theme .legend-item{ background: rgba(2,6,23,.02); }
    .legend-swatch{
      width:10px;
      height:10px;
      border-radius:999px;
      box-shadow: 0 10px 16px rgba(0,0,0,.20);
    }
    .swatch-imp{ background: linear-gradient(180deg, rgba(167,139,250,1), rgba(124,58,237,1)); }
    .swatch-arr{ background: linear-gradient(180deg, rgba(34,211,238,1), rgba(6,182,212,1)); }
    .swatch-conv{ background: linear-gradient(180deg, rgba(252,211,77,1), rgba(245,158,11,1)); }
    .swatch-comm{ background: linear-gradient(180deg, rgba(74,222,128,1), rgba(34,197,94,1)); }

    .legend-name{font-weight:950; font-size:12px; color: var(--muted);}
    .legend-value{margin-left:auto; font-weight:950; font-size:12px; color: var(--text);}
    .legend-hint{margin-left:auto; color: var(--muted2); font-weight:900; font-size:11px; padding: 6px 10px; border-radius: 999px; border:1px dashed var(--stroke);}

    /* Extra polish: subtle emphasis per dataset */
    .legend-item{transition: transform .18s ease, border-color .18s ease, background .18s ease;}
    .legend-item:hover{transform: translateY(-1px); border-color: rgba(124,58,237,.28);}
    body.light-theme .legend-item:hover{border-color: rgba(124,58,237,.22);}

    @media (max-width: 640px){
      .legend-item{ min-width: 0; flex: 1 1 100%; }
      .legend-hint{ width: 100%; text-align:center; }
    }

    .agent-list{display:flex; flex-direction:column; gap:10px;}

    /* Dashboard: afficher ~5 agents puis scroll pour le reste */
    #agent-performance-list{
      max-height: 330px; /* ~5 lignes visibles */
      overflow: auto;
      padding-right: 6px; /* espace pour la scrollbar */
    }
    /* scrollbar encore plus fine dans cette zone */
    #agent-performance-list::-webkit-scrollbar{ width:3px; }
    #agent-performance-list::-webkit-scrollbar-thumb{ border-radius: 999px; }

    /* Dashboard: afficher seulement les 4 plus récents (pas de scroll) */
    /* (Les listes sont volontairement limitées à 4 éléments via JS) */
    #recent-imputations,
    #recent-arrivals,
    #dashboard-commission-list{
      overflow: visible;
    }

    /* Conventions: garder la grille, mais scroller verticalement */
    #conventionScroller{
      max-height: 360px; /* ~4 cartes (selon grille) */
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 6px;
    }

    /* Scrollbars ultra fines pour ces zones */
    #conventionScroller::-webkit-scrollbar{ width:3px; height:3px; }
    #conventionScroller::-webkit-scrollbar-thumb{ border-radius: 999px; }

    .agent-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); border-radius: 16px;}
    body.light-theme .agent-row{background: rgba(15,23,42,.03)}
    .agent-meta{display:flex; flex-direction:column; gap:2px; min-width:0;}

    /* Agent name with icon */
    .agent-name-row{display:flex; align-items:center; gap:10px; min-width:0;}
    .agent-name{font-weight:950; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .agent-sub{color: var(--muted2); font-size:12px;}
    .agent-score{font-weight:950; font-size:13px;}

    .agent-avatar{
      width:30px;
      height:30px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--soft);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 30px;
      position:relative;
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      overflow:hidden;
    }
    /* Prefer real "person" silhouettes (inline SVG) */
    .agent-avatar svg{
      width: 18px;
      height: 18px;
      display:block;
      flex: 0 0 auto;
    }
    /* Backward compatibility (if any icon tags remain) */
    .agent-avatar i{font-size:16px; line-height:1; }

    /* Fallback: si une police d'icône ne charge pas, on affiche une lettre */
    .agent-avatar::after{
      content:"";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: 12px;
      color: currentColor;
      opacity: 0;
      pointer-events:none;
    }
    /* si l'icône est absente/vidée, le fallback reste discret (ne gêne pas) */
    .agent-avatar--male::after{ content:"M"; }
    .agent-avatar--female::after{ content:"F"; }
    .agent-avatar--secretariat::after{ content:"S"; }

    .agent-avatar--male{
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(96,165,250,.10));
      color: var(--primary2);
    }
    .agent-avatar--female{
      background: linear-gradient(135deg, rgba(6,182,212,.16), rgba(56,189,248,.10));
      color: var(--secondary);
    }
    .agent-avatar--secretariat{
      background: linear-gradient(135deg, rgba(245,158,11,.14), rgba(34,197,94,.10));
      /* a bit more contrast for 3 silhouettes */
      color: rgba(245,158,11,.98);
    }
    /* SECRETARIAT uses stacked SVG silhouettes (no icon font dependency) */
    .agent-avatar--secretariat span{
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.18));
    }

    body.light-theme .agent-avatar{ box-shadow: 0 14px 26px rgba(15,23,42,.12); }

    .recent-item{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); border-radius: 16px; margin-bottom: 10px;}
    body.light-theme .recent-item{background: rgba(15,23,42,.03)}
    .recent-main{display:flex; flex-direction:column; gap:4px;}
    .recent-title{font-weight:950; font-size:13px;}
    .recent-sub{color: var(--muted2); font-size:12px;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border:1px solid var(--stroke); font-size:11px; font-weight:950; color: var(--muted);}
    .pill.etatique{background: rgba(124,58,237,.16); color: var(--primary2)}
    .pill.prive{background: rgba(6,182,212,.12); color: var(--secondary)}
    .pill.contentieux{background: rgba(249,115,22,.12); color: var(--warning)}

    .dashboard-card__tabs{display:flex; gap:8px;}
    .tab-btn{padding: 8px 10px; border-radius: 12px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); color: var(--muted); font-weight:950; font-size:12px; cursor:pointer;}
    body.light-theme .tab-btn{background: rgba(15,23,42,.03)}
    .tab-btn.active{background: rgba(124,58,237,.18); color: var(--primary2); border-color: rgba(124,58,237,.25)}

    /* Dashboard: pas de scroll horizontal sur les conventions */
    .conventions-wrapper{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      overflow: hidden; /* retire le scroll */
      padding-bottom: 0;
    }
    @media (max-width: 1100px){
      .conventions-wrapper{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .conventions-wrapper{ grid-template-columns: 1fr; }
    }

    .convention-card{min-width: 0; border:1px solid var(--stroke); border-radius: 18px; background: rgba(255,255,255,.05); padding: 12px;}
    body.light-theme .convention-card{background: rgba(15,23,42,.03)}
    .convention-card h4{margin:0; font-weight:950; font-size:13px;}
    .convention-card p{margin:6px 0 0; color: var(--muted2); font-size:12px;}

    .convention-stats{display:flex; gap:12px; flex-wrap:wrap; color: var(--muted2); font-size:12px;}
    .stat-item .stat-value{color: var(--text); font-weight:950;}

    .commission-dashboard-summary{display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px;}
    .commission-stat{flex: 1; min-width: 180px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); border-radius: 16px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center;}
    body.light-theme .commission-stat{background: rgba(15,23,42,.03)}
    .commission-stat .label{color: var(--muted2); font-size:12px; font-weight:900;}
    .commission-stat .value{font-size:13px; font-weight:950;}

    .commission-dashboard-list{display:flex; flex-direction:column; gap:10px;}

    /* Theme switch */
    .theme-switch{width:44px; height:24px; border-radius: 999px; position:relative; cursor:pointer; border:1px solid var(--stroke); background: rgba(255,255,255,.06);}
    body.light-theme .theme-switch{background: rgba(15,23,42,.03)}
    .switch-track{position:absolute; inset:0; border-radius:999px;}
    .switch-thumb{position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:999px; background: rgba(255,255,255,.92); transition: transform .2s ease, background .2s ease; box-shadow: 0 6px 16px rgba(0,0,0,.25);}
    body.light-theme .switch-thumb{background: rgba(15,23,42,.84); box-shadow: 0 6px 16px rgba(15,23,42,.18)}
    .theme-switch.is-on .switch-thumb{transform: translateX(20px)}

    /* ===== Welcome screen (boot) ===== */
    body.welcome-active{ overflow: hidden; }
    body.welcome-active .app-container{ opacity: 0; pointer-events:none; }
    body.welcome-active .loading-overlay{ opacity: 0; pointer-events:none; }

    .welcome-screen{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(37,99,235,.26), transparent 60%),
        radial-gradient(860px 520px at 86% 18%, rgba(6,182,212,.18), transparent 60%),
        radial-gradient(900px 520px at 55% 95%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.72), rgba(2,6,23,.86));
      overflow:hidden;
      user-select:none;
      cursor: pointer;
      opacity: 1;
      transform: none;
      transition: opacity .42s ease, transform .42s ease;
    }

    .welcome-screen.is-hidden{
      opacity: 0;
      pointer-events:none;
      transform: scale(1.02);
    }

    .welcome-glow{
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(closest-side at 35% 35%, rgba(37,99,235,.28), transparent 60%),
        radial-gradient(closest-side at 70% 55%, rgba(6,182,212,.22), transparent 62%),
        radial-gradient(closest-side at 50% 85%, rgba(245,158,11,.16), transparent 60%);
      filter: blur(28px);
      opacity: .95;
      animation: welcomeGlow 7.5s ease-in-out infinite;
      pointer-events:none;
    }

    @keyframes welcomeGlow{
      0%,100%{ transform: translate3d(0,0,0) scale(1) rotate(0deg); }
      50%{ transform: translate3d(-2%, -1%, 0) scale(1.06) rotate(8deg); }
    }

    .welcome-card{
      position:relative;
      z-index:1;
      width: min(720px, 100%);
      border-radius: 26px;
      border: 1px solid transparent;
      padding: 18px 18px 16px;
      background:
        linear-gradient(var(--panel2), var(--panel2)) padding-box,
        linear-gradient(135deg, rgba(37,99,235,.92), rgba(6,182,212,.70), rgba(245,158,11,.35)) border-box;
      box-shadow: 0 30px 90px rgba(0,0,0,.62);
      overflow:hidden;
      text-align:center;
      animation: welcomeIn .85s cubic-bezier(.16,1,.25,1) both;
    }

    @keyframes welcomeIn{
      0%{ opacity:0; transform: translateY(18px) scale(.985); filter: blur(2px); }
      70%{ opacity:1; transform: translateY(0) scale(1.01); filter: blur(0); }
      100%{ opacity:1; transform: none; }
    }

    .welcome-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(600px 260px at 20% 0%, rgba(37,99,235,.20), transparent 60%),
        radial-gradient(520px 260px at 90% 30%, rgba(6,182,212,.14), transparent 62%);
      opacity: .85;
      pointer-events:none;
    }

    .welcome-card::after{
      content:"";
      position:absolute;
      top:-70%;
      left:-40%;
      width: 60%;
      height: 240%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.24), transparent);
      transform: rotate(18deg) translateX(-120%);
      animation: welcomeShine 3.2s cubic-bezier(.16,1,.25,1) infinite;
      pointer-events:none;
      opacity:.85;
    }

    @keyframes welcomeShine{
      0%{ transform: rotate(18deg) translateX(-140%); opacity: .0; }
      18%{ opacity: .85; }
      55%{ opacity: .85; }
      100%{ transform: rotate(18deg) translateX(260%); opacity: .0; }
    }

    .welcome-mark{
      width: 56px;
      height: 56px;
      border-radius: 20px;
      margin: 4px auto 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37,99,235,.20), rgba(6,182,212,.12));
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
      z-index:2;
      animation: welcomeMark 1.8s ease-in-out infinite;
    }

    .welcome-mark i{ font-size: 24px; color: var(--primary2); }

    @keyframes welcomeMark{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }

    .welcome-title{
      position:relative;
      z-index:2;
      font-weight: 1000;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: clamp(14px, 2.2vw, 18px);
      color: var(--text);
      opacity: 0;
      transform: translateY(6px);
      animation: welcomeText .70s cubic-bezier(.16,1,.25,1) .25s both;
    }

    .welcome-sub{
      position:relative;
      z-index:2;
      margin-top: 10px;
      font-size: clamp(16px, 3.2vw, 26px);
      font-weight: 1000;
      letter-spacing: .04em;
      color: var(--text);
      opacity: 0;
      transform: translateY(6px);
      animation: welcomeText .70s cubic-bezier(.16,1,.25,1) .42s both;
    }

    .welcome-sub b{ color: var(--primary2); }

    @keyframes welcomeText{ to{ opacity: 1; transform: none; } }

    .welcome-line{
      position:relative;
      z-index:2;
      height: 3px;
      width: min(360px, 72%);
      margin: 14px auto 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(6,182,212,.90));
      box-shadow: 0 12px 22px rgba(0,0,0,.28);
      opacity: 0;
      transform: scaleX(.72);
      animation: welcomeLine .72s cubic-bezier(.16,1,.25,1) .55s both;
    }

    @keyframes welcomeLine{ to{ opacity: 1; transform: none; } }

    .welcome-hint{
      position:relative;
      z-index:2;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 950;
      color: var(--muted2);
      opacity: 0;
      animation: welcomeHint .75s cubic-bezier(.16,1,.25,1) .85s both;
    }

    @keyframes welcomeHint{ to{ opacity: 1; } }

    @media (prefers-reduced-motion: reduce){
      .welcome-glow, .welcome-card, .welcome-card::after, .welcome-title, .welcome-sub, .welcome-line, .welcome-hint, .welcome-mark{ animation: none !important; }
    }

    /* Login (premium, animé) */
    body.modal-open{ overflow: hidden; }

    .login-screen{
      position:fixed;
      inset:0;
      z-index:100;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      overflow:hidden;
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(860px 520px at 86% 18%, rgba(6,182,212,.18), transparent 60%),
        radial-gradient(900px 520px at 55% 95%, rgba(245,158,11,.14), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.78));
    }

    /* animated backdrop sheen */
    .login-screen{
      background-size: 120% 120%, 120% 120%, 120% 120%, 100% 100%;
      animation: loginBackdrop 9s ease-in-out infinite;
    }
    @keyframes loginBackdrop{
      0%,100%{ background-position: 0% 0%, 100% 0%, 50% 100%, 0% 0%; }
      50%{ background-position: 10% 6%, 92% 10%, 55% 94%, 0% 0%; }
    }

    /* subtle particles */
    .login-screen .login-particles{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.22;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.16) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 75%, rgba(255,255,255,.10) 0 1px, transparent 2px);
      background-size: 220px 220px;
      animation: particlesMove 12s linear infinite;
      z-index:0;
    }
    @keyframes particlesMove{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(-220px,-220px,0); }
    }

    /* Animated blobs */
    .login-screen::before,
    .login-screen::after{
      content:"";
      position:absolute;
      inset:auto;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(42px);
      opacity: .45;
      pointer-events:none;
      z-index:0;
      animation: loginFloat 10s ease-in-out infinite;
    }
    .login-screen::before{
      left: -180px;
      top: -160px;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.85), transparent 60%);
      animation-duration: 12s;
    }
    .login-screen::after{
      right: -220px;
      bottom: -240px;
      background: radial-gradient(circle at 60% 30%, rgba(6,182,212,.75), transparent 60%);
      animation-duration: 14s;
      animation-delay: -2s;
    }

    @keyframes loginFloat{
      0%,100%{ transform: translate3d(0,0,0) scale(1) rotate(0deg); }
      50%{ transform: translate3d(0,-22px,0) scale(1.06) rotate(10deg); }
    }

    /* Soft shimmer layer */
    .login-screen .login-card::after{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      background: radial-gradient(240px 120px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(220px 120px at 80% 30%, rgba(255,255,255,.08), transparent 62%),
                  radial-gradient(260px 160px at 60% 90%, rgba(255,255,255,.06), transparent 60%);
      opacity:.40;
      mix-blend-mode: overlay;
      animation: loginShimmer 6s ease-in-out infinite;
    }
    @keyframes loginShimmer{
      0%,100%{ opacity:.28; transform: translateY(0); }
      50%{ opacity:.46; transform: translateY(-4px); }
    }

    .login-card{
      position:relative;
      z-index:1;
      width: min(460px, 100%);
      border-radius: 24px;
      border: 1px solid transparent;
      background:
        linear-gradient(var(--panel2), var(--panel2)) padding-box,
        linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.78), rgba(245,158,11,.40)) border-box;
      /* animated border via background-position in keyframes */
      background-size: 100% 100%, 220% 220%;
      background-position: 0 0, 0% 50%;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      padding: 18px;
      overflow:hidden;
      will-change: transform;
    }

    .login-card::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(600px 240px at 20% 0%, rgba(124,58,237,.22), transparent 60%),
                  radial-gradient(520px 260px at 90% 20%, rgba(6,182,212,.14), transparent 62%);
      opacity: .75;
      pointer-events:none;
    }

    .login-screen:not(.is-hidden) .login-card{
      animation: loginIn .58s cubic-bezier(.16,1,.25,1) both;
    }

    /* Subtle continuous polish when login is visible */
    .login-screen:not(.is-hidden) .login-card{
      animation:
        loginIn .58s cubic-bezier(.16,1,.25,1) both,
        loginBreathe 4.6s ease-in-out .65s infinite,
        loginBorder 5.8s ease-in-out .65s infinite;
    }

    @keyframes loginIn{
      0%{ opacity:0; transform: translateY(16px) scale(.98); }
      70%{ opacity:1; transform: translateY(0) scale(1.01); }
      100%{ opacity:1; transform: none; }
    }

    @keyframes loginBreathe{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-2px) scale(1.01); }
    }

    @keyframes loginBorder{
      0%,100%{ background-position: 0 0, 0% 50%; }
      50%{ background-position: 0 0, 100% 50%; }
    }

    .login-card.shake{ animation: loginShake .44s cubic-bezier(.2,.9,.2,1) both; }
    @keyframes loginShake{
      0%{ transform: translateX(0); }
      20%{ transform: translateX(-10px); }
      40%{ transform: translateX(9px); }
      60%{ transform: translateX(-7px); }
      80%{ transform: translateX(5px); }
      100%{ transform: translateX(0); }
    }

    .login-card__brand{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 18px;
      background: var(--soft);
      margin-bottom: 12px;
    }
    .brand-mark{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(124,58,237,.25), rgba(6,182,212,.14));
      box-shadow: 0 16px 30px rgba(0,0,0,.25);
    }
    .brand-mark i{ font-size: 20px; color: var(--primary2); }
    .brand-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .brand-name{ font-weight: 950; letter-spacing:.3px; font-size: 13px; }
    .brand-sub{ font-weight: 900; font-size: 12px; color: var(--muted2); }
    .brand-chip{
      margin-left:auto;
      font-size: 11px;
      font-weight: 950;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }

    .login-card__title{position:relative; z-index:2; font-weight: 950; font-size: 22px; margin: 0; letter-spacing:.2px;}
    .login-card__subtitle{position:relative; z-index:2; margin: 6px 0 14px; color: var(--muted2); font-size: 13px;}

    .login-card__error{position:relative; z-index:2; min-height: 18px; color: #fecaca; font-weight: 900; font-size: 12px; margin: 10px 2px 0;}
    body.light-theme .login-card__error{color:#b91c1c}

    .login-card__actions{position:relative; z-index:2; display:flex; justify-content:flex-end; gap:10px; margin-top: 14px;}

    /* Smaller inputs in login for a premium look */
    #login-screen .form__input-group{ border-radius: 16px; padding: 12px 12px; }
    #login-screen .form__control{ font-weight: 900; }

    /* === Creator badge (Mr.JMK) — premium + animated === */
    .creator-badge{
      position: relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      background:
        linear-gradient(var(--soft), var(--soft)) padding-box,
        linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.70), rgba(245,158,11,.40)) border-box;
      color: var(--text);
      font-weight: 950;
      font-size: 12px;
      letter-spacing: .2px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow:hidden;
      user-select:none;
      white-space:nowrap;
      will-change: transform;
      animation: creatorFloat 3.8s ease-in-out infinite;
    }

    .creator-badge i{
      font-size: 16px;
      color: var(--primary2);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      animation: creatorSpark 1.6s ease-in-out infinite;
    }

    .creator-badge b{ color: var(--text); font-weight: 950; }

    /* subtle moving shine */
    .creator-badge::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-50%;
      width: 55%;
      height: 220%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.30), transparent);
      transform: rotate(18deg) translateX(-120%);
      animation: creatorShine 3.2s cubic-bezier(.16,1,.25,1) infinite;
      pointer-events:none;
      opacity:.75;
    }

    .creator-badge--login{
      margin-top: 12px;
      justify-content:center;
      width: fit-content;
      max-width: 100%;
    }

    .creator-badge--dash{
      padding: 9px 12px;
      font-size: 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }

    body.light-theme .creator-badge{
      background:
        linear-gradient(#ffffff, #ffffff) padding-box,
        linear-gradient(135deg, rgba(124,58,237,.80), rgba(6,182,212,.55), rgba(245,158,11,.35)) border-box;
      box-shadow: 0 16px 44px rgba(15,23,42,.12);
    }

    @keyframes creatorFloat{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-2px); }
    }
    @keyframes creatorSpark{
      0%,100%{ transform: rotate(0deg) scale(1); opacity: .95; }
      50%{ transform: rotate(12deg) scale(1.06); opacity: 1; }
    }
    @keyframes creatorShine{
      0%{ transform: rotate(18deg) translateX(-140%); opacity: .0; }
      15%{ opacity: .85; }
      55%{ opacity: .85; }
      100%{ transform: rotate(18deg) translateX(260%); opacity: .0; }
    }

    /* Responsive: avoid crowding dashboard header */
    @media (max-width: 880px){
      .creator-badge--dash{ display:none; }
    }

    /* Premium button shine (login primary only) */
    #login-screen .btn--primary{ position: relative; overflow: hidden; }
    #login-screen .btn--primary::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width: 60%;
      height: 220%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      transform: rotate(18deg) translateX(-120%);
      transition: transform .6s cubic-bezier(.16,1,.25,1);
      pointer-events:none;
    }
    #login-screen .btn--primary:hover::after{ transform: rotate(18deg) translateX(240%); }

    /* Light theme tuning */
    body.light-theme .login-screen{
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(124,58,237,.16), transparent 60%),
        radial-gradient(860px 520px at 86% 18%, rgba(6,182,212,.12), transparent 60%),
        radial-gradient(900px 520px at 55% 95%, rgba(245,158,11,.10), transparent 60%),
        rgba(15,23,42,.25);
    }
    body.light-theme .login-card{ box-shadow: 0 22px 70px rgba(15,23,42,.16); }

    /* Loading (premium) */
    .loading-overlay{
      position:fixed;
      inset:0;
      z-index:90;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.52);
      transition: opacity .28s ease, transform .28s ease;
    }
    .loading-overlay.is-hidden{
      opacity: 0;
      pointer-events: none;
      transform: scale(1.01);
    }

    .loading-content{
      background: var(--panel2);
      border: 1px solid transparent;
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      width: 420px;
      max-width: calc(100vw - 24px);
      position: relative;
      overflow: hidden;
      background:
        linear-gradient(var(--panel2), var(--panel2)) padding-box,
        linear-gradient(135deg, rgba(124,58,237,.85), rgba(6,182,212,.55), rgba(245,158,11,.25)) border-box;
    }

    .loading-content::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(520px 240px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(520px 260px at 90% 20%, rgba(6,182,212,.12), transparent 62%);
      opacity: .70;
      pointer-events:none;
    }

    .loading-logo{position:relative; z-index:1; display:flex; align-items:center; gap:10px; font-weight:950; margin-bottom: 12px;}
    .loading-logo i{color: var(--primary2)}

    .loading-ring{
      position:relative;
      z-index:1;
      width: 64px;
      height: 64px;
      margin: 8px auto 12px;
      border-radius: 999px;
      background:
        conic-gradient(from 0deg, rgba(124,58,237,1), rgba(6,182,212,1), rgba(245,158,11,.95), rgba(124,58,237,1));
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
      animation: spin 1.2s linear infinite;
    }
    .loading-ring::after{
      content:"";
      position:absolute;
      inset: 7px;
      border-radius: 999px;
      background: var(--panel2);
      border: 1px solid var(--stroke);
    }

    .loading-bar{position:relative; z-index:1; height: 10px; border-radius: 999px; border:1px solid var(--stroke); background: var(--soft); overflow:hidden;}
    .loading-bar__fill{
      position:absolute;
      top:0; left:0; bottom:0;
      width: 40%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
      animation: indeterminate 1.25s ease-in-out infinite;
    }

    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes indeterminate{
      0%{ transform: translateX(-120%); opacity:.85; }
      50%{ opacity: 1; }
      100%{ transform: translateX(220%); opacity:.85; }
    }

    @keyframes dropdownIn{from{opacity:0; transform: translateY(-6px) scale(.98);} to{opacity:1; transform: translateY(0) scale(1);}}

    .loading-text{position:relative; z-index:1; margin: 12px 0 0; color: var(--muted2); font-size: 13px; text-align:center; font-weight: 900;}

    /* Backdrop for sidebar */
    .sidebar-backdrop{position:fixed; inset:0; background: rgba(0,0,0,.45); z-index:20; display:none;}
    .sidebar-backdrop.open{display:block;}

    /* Backdrop for dropdowns (profile/notifications) */
    .dropdown-backdrop{position:fixed; inset:0; z-index:190; background: rgba(2,6,23,.55); display:none;}
    body.light-theme .dropdown-backdrop{background: rgba(15,23,42,.18)}
    .dropdown-backdrop.open{display:block;}

    /* Dropdown “sheet” mode (mobile) */
    .dropdown-sheet{
      position: fixed !important;
      left: 8px !important;
      right: 8px !important;
      top: auto !important;
      bottom: 8px !important;
      width: auto !important;
      max-width: none !important;
      /* Full viewport height (no arbitrary 640px cap) */
      max-height: calc(100vh - 16px) !important;
      border-radius: 22px !important;
      transform-origin: bottom right !important;
      overflow: hidden;
    }
    /* Improve spacing in sheet mode (handle overlaps otherwise) */
    .dropdown-sheet .dropdown__header{ padding-top: 26px; }
    .dropdown-sheet .dropdown__items{ min-height: 0; }
    /* Add a small handle for better mobile affordance */
    .dropdown-sheet::after{
      content:"";
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 46px;
      height: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
    }
    body.light-theme .dropdown-sheet::after{ background: rgba(2,6,23,.14); }

    .dropdown-sheet.open{ animation: sheetIn .18s cubic-bezier(.16,1,.25,1) both; }
    @keyframes sheetIn{from{opacity:0; transform: translateY(12px) scale(.985);} to{opacity:1; transform: translateY(0) scale(1);} }

    /* Modals */
    .detail-modal-backdrop, .confirm-modal-backdrop{position:fixed; inset:0; z-index:80; background: rgba(0,0,0,.55); backdrop-filter: blur(8px); display:none; align-items:center; justify-content:center; padding: 16px;}
    .detail-modal-backdrop.open, .confirm-modal-backdrop.open{display:flex;}

    @keyframes detailIn{from{opacity:0; transform: translateY(10px) scale(.99);} to{opacity:1; transform:none;}}
    .detail-modal-backdrop.open .detail-modal{animation: detailIn .18s cubic-bezier(.16,1,.25,1) both;}
    .detail-modal, .confirm-modal{width: 720px; max-width: 100%; background: var(--panel2); border:1px solid var(--stroke); border-radius: 22px; box-shadow: var(--shadow); overflow:hidden;}
    .detail-modal{ max-height: min(86vh, 820px); display:flex; flex-direction:column; }
    .confirm-modal{width: 520px; display:flex; gap:0;}
    .detail-modal__header{display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom:1px solid var(--stroke); position:relative;}
    .detail-modal__header::before{content:""; position:absolute; inset:0; background: radial-gradient(520px 240px at 20% 0%, rgba(124,58,237,.14), transparent 60%), radial-gradient(520px 260px at 90% 20%, rgba(6,182,212,.10), transparent 62%); opacity:.9; pointer-events:none;}
    .detail-modal__title{margin:0; font-weight:950; position:relative; z-index:1;}
    .detail-modal__close{width:38px; height:38px; border-radius: 14px; border:1px solid var(--stroke); background: transparent; color: var(--text); position:relative; z-index:1;}
    .detail-modal__content{padding: 14px; color: var(--text); overflow:auto; min-height:0;}
    .detail-modal__footer{padding: 12px 14px; border-top:1px solid var(--stroke); display:flex; justify-content:flex-end; gap:10px;}

    /* Detail modal content (premium, structured) */
    .detail-hero{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding: 12px; border:1px solid var(--stroke); border-radius: 18px; background: var(--soft); margin-bottom: 12px;}
    .detail-hero__kicker{font-size:11px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; color: var(--muted2);}
    .detail-hero__title{font-size:16px; font-weight:950; letter-spacing:.2px; margin-top: 2px;}
    .detail-hero__sub{margin-top: 6px; color: var(--muted2); font-size:12px; font-weight:900;}
    .detail-hero__chips{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;}

    .detail-chip{display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border:1px solid var(--stroke); font-size:11px; font-weight:950; background: rgba(255,255,255,.03); color: var(--muted); white-space:nowrap;}
    .detail-chip b{color: var(--text); font-weight:950;}
    .detail-chip.imp{background: rgba(124,58,237,.14); color: var(--primary2); border-color: rgba(124,58,237,.22)}
    .detail-chip.arr{background: rgba(6,182,212,.12); color: var(--secondary); border-color: rgba(6,182,212,.22)}
    .detail-chip.conv{background: rgba(245,158,11,.12); color: var(--tertiary); border-color: rgba(245,158,11,.22)}
    .detail-chip.comm{background: rgba(34,197,94,.12); color: var(--quaternary); border-color: rgba(34,197,94,.22)}

    .detail-grid{display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:10px;}
    .detail-item{grid-column: span 6; padding: 10px 12px; border:1px solid var(--stroke); border-radius: 16px; background: rgba(255,255,255,.03);}
    body.light-theme .detail-item{background: rgba(2,6,23,.02)}
    .detail-item--full{grid-column: span 12;}
    .detail-label{font-weight:950; color: var(--muted2); font-size:11px; text-transform:uppercase; letter-spacing:.09em;}
    .detail-value{margin-top: 6px; font-weight:950; font-size:13px; color: var(--text); overflow-wrap:anywhere; word-break: break-word; line-height:1.35;}

    @media (max-width: 760px){
      .detail-item{grid-column: span 12;}
      .detail-hero{flex-direction:column;}
      .detail-hero__chips{justify-content:flex-start;}
    }

    .confirm-modal__icon{width:80px; display:flex; align-items:center; justify-content:center; border-right:1px solid var(--stroke); color: var(--danger); font-size: 28px;}
    .confirm-modal__body{padding: 14px;}
    .confirm-modal__title{margin: 0; font-weight: 950;}
    .confirm-modal__message{margin: 8px 0 12px; color: var(--muted2); font-size: 13px;}
    .confirm-modal__actions{display:flex; justify-content:flex-end; gap:10px;}

    /* Toast (premium + action icons) */
    .toast-notification{
      position:fixed;
      right: 16px;
      bottom: 16px;
      z-index:95;
      width: 380px;
      max-width: calc(100vw - 32px);
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px 12px 14px;
      display:none;
      gap:10px;
      align-items:flex-start;
      overflow:hidden;
      /* theme-able accents */
      --toast-accent: rgba(124,58,237,1);
      --toast-icon-bg: rgba(124,58,237,.18);
      --toast-glow: rgba(124,58,237,.18);
    }

    .toast-notification::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(360px 160px at 12% 10%, var(--toast-glow), transparent 60%),
        radial-gradient(300px 140px at 80% 0%, rgba(6,182,212,.12), transparent 62%);
      opacity:.85;
      pointer-events:none;
    }

    .toast-notification.show{
      display:flex;
      animation: toastIn .22s cubic-bezier(.16,1,.25,1) both;
    }

    @keyframes toastIn{from{opacity:0; transform: translateY(10px) scale(.985);} to{opacity:1; transform:none;}}

    .toast__icon{
      width:42px;
      height:42px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--toast-icon-bg);
      position:relative;
      flex: 0 0 42px;
    }

    .toast__icon::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, var(--toast-glow), transparent 60%);
      opacity: .0;
      transition: opacity .22s ease;
      pointer-events:none;
    }

    .toast-notification.show .toast__icon::after{ opacity: .75; }

    .toast__icon i{
      font-size: 20px;
      color: var(--toast-accent);
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.20));
    }

    .toast__content{flex:1; position:relative; z-index:1; min-width:0;}
    .toast__title{margin:0; font-weight: 950; font-size: 13px; letter-spacing:.2px;}
    .toast__message{margin: 4px 0 0; color: var(--muted2); font-size: 12px; font-weight: 900; overflow-wrap:anywhere;}

    .toast__close{
      width:34px;
      height:34px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: transparent;
      color: var(--text);
      position:relative;
      z-index:1;
    }

    .toast__bar{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:4px;
      background: rgba(255,255,255,.04);
      border-top: 1px solid rgba(255,255,255,.06);
    }
    body.light-theme .toast__bar{
      background: rgba(2,6,23,.05);
      border-top-color: rgba(15,23,42,.06);
    }

    .toast__bar-fill{
      height:100%;
      width:100%;
      transform: translateX(-100%);
      background: linear-gradient(90deg, var(--toast-accent), rgba(6,182,212,.85));
    }

    .toast-notification.show .toast__bar-fill{
      animation: toastBar 3.8s linear both;
    }
    @keyframes toastBar{to{ transform: translateX(0); }}

    /* Action variants */
    .toast--save{ --toast-accent: rgba(34,197,94,1); --toast-icon-bg: rgba(34,197,94,.16); --toast-glow: rgba(34,197,94,.22); }
    .toast--delete{ --toast-accent: rgba(239,68,68,1); --toast-icon-bg: rgba(239,68,68,.14); --toast-glow: rgba(239,68,68,.20); }
    .toast--update{ --toast-accent: rgba(6,182,212,1); --toast-icon-bg: rgba(6,182,212,.14); --toast-glow: rgba(6,182,212,.20); }

    .toast--success{ --toast-accent: rgba(34,197,94,1); --toast-icon-bg: rgba(34,197,94,.16); --toast-glow: rgba(34,197,94,.22); }
    .toast--error{ --toast-accent: rgba(239,68,68,1); --toast-icon-bg: rgba(239,68,68,.14); --toast-glow: rgba(239,68,68,.20); }
    .toast--info{ --toast-accent: rgba(59,130,246,1); --toast-icon-bg: rgba(59,130,246,.14); --toast-glow: rgba(59,130,246,.18); }
    .toast--warn{ --toast-accent: rgba(249,115,22,1); --toast-icon-bg: rgba(249,115,22,.14); --toast-glow: rgba(249,115,22,.18); }

    /* Icon animations */
    .toast--save.show #toast-icon{ animation: thumbPop .55s cubic-bezier(.16,1,.25,1) both; }
    @keyframes thumbPop{ 0%{ transform: scale(.75) rotate(-10deg); } 60%{ transform: scale(1.12) rotate(8deg); } 100%{ transform: scale(1) rotate(0deg); } }

    .toast--delete.show #toast-icon{ animation: trashWobble .62s cubic-bezier(.16,1,.25,1) both; }
    @keyframes trashWobble{ 0%{ transform: translateY(0) rotate(0deg); } 25%{ transform: translateY(-2px) rotate(-10deg); } 55%{ transform: translateY(0) rotate(10deg); } 100%{ transform: translateY(0) rotate(0deg); } }

    .toast--update.show #toast-icon{ animation: editSpin .9s cubic-bezier(.16,1,.25,1) both; }
    @keyframes editSpin{ 0%{ transform: rotate(-8deg) scale(.92); } 60%{ transform: rotate(14deg) scale(1.06); } 100%{ transform: rotate(0deg) scale(1); } }

    /* Activity feed */
    .activity-feed{position:fixed; right: 16px; top: 88px; bottom: 16px; width: 380px; max-width: calc(100vw - 32px); background: var(--panel2); border:1px solid var(--stroke); border-radius: 22px; box-shadow: var(--shadow); backdrop-filter: blur(14px); display:none; flex-direction:column; z-index:70; overflow:hidden;}
    .activity-feed.open{display:flex;}
    .activity-feed__header{display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom:1px solid var(--stroke);}
    .activity-feed__close{width:38px; height:38px; border-radius: 14px; border:1px solid var(--stroke); background: transparent; color: var(--text)}
    .activity-feed__content{padding: 14px; overflow:auto; display:flex; flex-direction:column; gap:10px;}
    .activity-item{border:1px solid var(--stroke); border-radius: 16px; background: rgba(255,255,255,.05); padding: 10px 12px; cursor:pointer; user-select:none;}
    body.light-theme .activity-item{background: rgba(15,23,42,.03)}
    .activity-item.unread{background: rgba(124,58,237,.10);}
    body.light-theme .activity-item.unread{background: rgba(124,58,237,.08);}
    .activity-item:hover{background: rgba(255,255,255,.06)}
    body.light-theme .activity-item:hover{background: rgba(15,23,42,.04)}
    .activity-item h4{margin:0; font-weight: 950; font-size: 12px;}
    .activity-item p{margin: 4px 0 0; color: var(--muted2); font-size: 12px;}
    .activity-feed__footer{padding: 12px 14px; border-top:1px solid var(--stroke);}

    .activity-feed__trigger{position:fixed; right: 18px; bottom: 92px; width: 52px; height: 52px; border-radius: 18px; border:1px solid var(--stroke); background: var(--panel); backdrop-filter: blur(14px); box-shadow: var(--shadow2); color: var(--text); display:flex; align-items:center; justify-content:center; z-index:60;}
    .activity-feed__trigger i{font-size: 20px;}
    .activity-count{position:absolute; right: -6px; top: -6px; width: 22px; height: 22px; border-radius: 999px; background: var(--primary); display:flex; align-items:center; justify-content:center; font-size: 12px; font-weight: 950; border:2px solid rgba(0,0,0,.20)}
    body.light-theme .activity-count{border-color: rgba(255,255,255,.6)}

    /* ===== Theme v2: solid + modern (no glass) ===== */
    :root{
      /* Surfaces (dark) */
      --bg0:#070a12;
      --bg1:#0b1324;
      --panel:#0f1b2d;
      --panel2:#12233b;
      --soft:#0b1628;
      --soft2:#0d1a2f;

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow2: 0 10px 26px rgba(0,0,0,.40);
      --focus: 0 0 0 4px rgba(6,182,212,.22);
    }

    body{
      background:
        radial-gradient(900px 600px at 12% 8%, rgba(124,58,237,.28), transparent 55%),
        radial-gradient(900px 600px at 88% 18%, rgba(6,182,212,.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      /* Hint browsers to render native form popups/pickers in dark mode */
      color-scheme: dark;
    }

    /* Prevent global horizontal scroll (dashboard incl.) */
    html, body{ width:100%; max-width:100%; overflow-x:hidden; overscroll-behavior-x: none; }

    /* Lock scroll when dropdown sheet is open (mobile) */
    body.dropdown-open{ overflow: hidden; }
    @supports (overflow: clip){
      html, body{ overflow-x: clip; }
    }
    *, *::before, *::after{ box-sizing: border-box; }

    /* Hard lock for dashboard: jamais de scroll horizontal */
    #dashboard-section,
    #dashboard-section .stats-overview,
    #dashboard-section .dashboard-grid,
    #dashboard-section .dashboard-card,
    #dashboard-section .dashboard-card__content,
    #dashboard-section .dashboard-card__header,
    #dashboard-section .dashboard-card__footer{
      max-width: 100%;
      min-width: 0;
      overflow-x: hidden;
    }

    /* flex children can force overflow if min-width isn't 0 */
    .dashboard-card__header, .dashboard-card__content, .dashboard-card__footer,
    .section__header, .header__left, .header__right,
    .header__search{ min-width:0; }

    .main-content{ overflow-x:hidden; max-width:100%; }
    .content-wrapper{ overflow-x:hidden; max-width:100%; }
    .dashboard-grid, .stats-overview{ min-width:0; }
    .card, .dashboard-card, .stats-card{ min-width:0; }
    .convention-card, .recent-item, .agent-row{ min-width:0; }
    .convention-card h4, .convention-card p{ overflow-wrap:anywhere; word-break: break-word; }

    /* Canvas can overflow in some cases */
    canvas{ max-width:100% !important; }

    /* Tables: keep horizontal scroll inside container only */
    .table-container{ max-width:100%; overflow:auto; }
    .data-table{ width:100%; }

    body.light-theme{
      /* Light theme premium (less flat, more depth) */
      --bg0:#f7f8ff;
      --bg1:#eef2ff;
      --panel:#ffffff;
      --panel2:#ffffff;
      --soft:#f6f7fb;
      --soft2:#eef2ff;

      --stroke: rgba(15,23,42,.10);
      --stroke2: rgba(15,23,42,.18);
      --shadow: 0 18px 46px rgba(15,23,42,.10);
      --shadow2: 0 10px 20px rgba(15,23,42,.08);
      --focus: 0 0 0 4px rgba(6,182,212,.22);

      /* text colors (override earlier light vars) */
      --text: rgba(2,6,23,.92);
      --muted: rgba(2,6,23,.68);
      --muted2: rgba(2,6,23,.52);

      background:
        radial-gradient(900px 600px at 10% 0%, rgba(124,58,237,.16), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(6,182,212,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));

      /* Hint browsers to render native form popups/pickers in light mode */
      color-scheme: light;
    }

    /* Scrollbar (ultra-thin & premium) */
    *{ scrollbar-width: thin; scrollbar-color: rgba(124,58,237,.55) transparent; }
    *::-webkit-scrollbar{ width:4px; height:4px; }
    *::-webkit-scrollbar-track{ background: transparent; }
    *::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
      border-radius: 999px;
    }
    *::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(180deg, rgba(124,58,237,1), rgba(6,182,212,1));
    }
    /* Make horizontal scrollbars (tables / scrollers) even subtler */
    .table-container::-webkit-scrollbar,
    .conventions-wrapper::-webkit-scrollbar{ height:3px; }

    body.light-theme *{ scrollbar-color: rgba(124,58,237,.45) transparent; }
    body.light-theme *::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(124,58,237,.70), rgba(6,182,212,.55));
    }

    /* ===== Scrollbars auto-hide (appear on hover) =====
      But: on ne l'applique qu'aux zones scrollables internes (pas au body)
      pour éviter une scrollbar visible dès qu'on survole la page.
    */
    .sidebar__menu,
    .table-container,
    #agent-performance-list,
    #conventionScroller,
    .dropdown__items,
    .activity-feed__content,
    .detail-modal__content,
    .select-menu{
      scrollbar-width: none; /* Firefox */
      scrollbar-color: transparent transparent;
    }

    .sidebar__menu:hover,
    .table-container:hover,
    #agent-performance-list:hover,
    #conventionScroller:hover,
    .dropdown__items:hover,
    .activity-feed__content:hover,
    .detail-modal__content:hover,
    .select-menu:hover{
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: rgba(124,58,237,.55) transparent;
    }

    body.light-theme .sidebar__menu:hover,
    body.light-theme .table-container:hover,
    body.light-theme #agent-performance-list:hover,
    body.light-theme #conventionScroller:hover,
    body.light-theme .dropdown__items:hover,
    body.light-theme .activity-feed__content:hover,
    body.light-theme .detail-modal__content:hover,
    body.light-theme .select-menu:hover{
      scrollbar-color: rgba(124,58,237,.45) transparent;
    }

    /* WebKit: hide by default */
    .sidebar__menu::-webkit-scrollbar,
    .table-container::-webkit-scrollbar,
    #agent-performance-list::-webkit-scrollbar,
    #conventionScroller::-webkit-scrollbar,
    .dropdown__items::-webkit-scrollbar,
    .activity-feed__content::-webkit-scrollbar,
    .detail-modal__content::-webkit-scrollbar,
    .select-menu::-webkit-scrollbar{
      width: 0;
      height: 0;
    }

    /* WebKit: show on hover */
    .sidebar__menu:hover::-webkit-scrollbar,
    .table-container:hover::-webkit-scrollbar,
    .dropdown__items:hover::-webkit-scrollbar,
    .activity-feed__content:hover::-webkit-scrollbar,
    .detail-modal__content:hover::-webkit-scrollbar,
    .select-menu:hover::-webkit-scrollbar{
      width: 4px;
      height: 4px;
    }

    /* Slightly smaller in some compact lists */
    #agent-performance-list:hover::-webkit-scrollbar,
    #conventionScroller:hover::-webkit-scrollbar{
      width: 3px;
      height: 3px;
    }

    .sidebar__menu::-webkit-scrollbar-thumb,
    .table-container::-webkit-scrollbar-thumb,
    #agent-performance-list::-webkit-scrollbar-thumb,
    #conventionScroller::-webkit-scrollbar-thumb,
    .dropdown__items::-webkit-scrollbar-thumb,
    .activity-feed__content::-webkit-scrollbar-thumb,
    .detail-modal__content::-webkit-scrollbar-thumb,
    .select-menu::-webkit-scrollbar-thumb{
      background: transparent;
      border-radius: 999px;
    }

    .sidebar__menu:hover::-webkit-scrollbar-thumb,
    .table-container:hover::-webkit-scrollbar-thumb,
    #agent-performance-list:hover::-webkit-scrollbar-thumb,
    #conventionScroller:hover::-webkit-scrollbar-thumb,
    .dropdown__items:hover::-webkit-scrollbar-thumb,
    .activity-feed__content:hover::-webkit-scrollbar-thumb,
    .detail-modal__content:hover::-webkit-scrollbar-thumb,
    .select-menu:hover::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
    }

    body.light-theme .sidebar__menu:hover::-webkit-scrollbar-thumb,
    body.light-theme .table-container:hover::-webkit-scrollbar-thumb,
    body.light-theme #agent-performance-list:hover::-webkit-scrollbar-thumb,
    body.light-theme #conventionScroller:hover::-webkit-scrollbar-thumb,
    body.light-theme .dropdown__items:hover::-webkit-scrollbar-thumb,
    body.light-theme .activity-feed__content:hover::-webkit-scrollbar-thumb,
    body.light-theme .detail-modal__content:hover::-webkit-scrollbar-thumb,
    body.light-theme .select-menu:hover::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(124,58,237,.70), rgba(6,182,212,.55));
    }

    /* Mobile / touch devices: no hover -> keep scrollbars usable */
    @media (hover: none) and (pointer: coarse){
      .sidebar__menu,
      .table-container,
      #agent-performance-list,
      #conventionScroller,
      .dropdown__items,
      .activity-feed__content,
      .detail-modal__content,
      .select-menu{
        scrollbar-width: thin;
        scrollbar-color: rgba(124,58,237,.55) transparent;
      }
      .sidebar__menu::-webkit-scrollbar,
      .table-container::-webkit-scrollbar,
      .dropdown__items::-webkit-scrollbar,
      .activity-feed__content::-webkit-scrollbar,
      .detail-modal__content::-webkit-scrollbar,
      .select-menu::-webkit-scrollbar{ width:4px; height:4px; }

      #agent-performance-list::-webkit-scrollbar,
      #conventionScroller::-webkit-scrollbar{ width:3px; height:3px; }

      .sidebar__menu::-webkit-scrollbar-thumb,
      .table-container::-webkit-scrollbar-thumb,
      #agent-performance-list::-webkit-scrollbar-thumb,
      #conventionScroller::-webkit-scrollbar-thumb,
      .dropdown__items::-webkit-scrollbar-thumb,
      .activity-feed__content::-webkit-scrollbar-thumb,
      .detail-modal__content::-webkit-scrollbar-thumb,
      .select-menu::-webkit-scrollbar-thumb{
        background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(6,182,212,.85));
      }

      body.light-theme .sidebar__menu,
      body.light-theme .table-container,
      body.light-theme #agent-performance-list,
      body.light-theme #conventionScroller,
      body.light-theme .dropdown__items,
      body.light-theme .activity-feed__content,
      body.light-theme .detail-modal__content,
      body.light-theme .select-menu{
        scrollbar-color: rgba(124,58,237,.45) transparent;
      }
      body.light-theme .sidebar__menu::-webkit-scrollbar-thumb,
      body.light-theme .table-container::-webkit-scrollbar-thumb,
      body.light-theme #agent-performance-list::-webkit-scrollbar-thumb,
      body.light-theme #conventionScroller::-webkit-scrollbar-thumb,
      body.light-theme .dropdown__items::-webkit-scrollbar-thumb,
      body.light-theme .activity-feed__content::-webkit-scrollbar-thumb,
      body.light-theme .detail-modal__content::-webkit-scrollbar-thumb,
      body.light-theme .select-menu::-webkit-scrollbar-thumb{
        background: linear-gradient(180deg, rgba(124,58,237,.70), rgba(6,182,212,.55));
      }
    }

    /* Remove glass blur */
    .sidebar__container,
    .sidebar-desktop-toggle,
    .header,
    .card, .dashboard-card, .stats-card,
    .notifications__dropdown,
    .profile__dropdown,
    .toast-notification,
    .activity-feed,
    .login-screen,
    .loading-overlay,
    .detail-modal-backdrop, .confirm-modal-backdrop,
    .detail-modal, .confirm-modal{
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Solid sub-surfaces (remove transparency “glass” feel) */
    .header__search,
    .notifications__trigger,
    .header__profile,
    .agent-row,
    .recent-item,
    .convention-card,
    .commission-stat,
    .activity-item,
    .notification__icon,
    .stats-card__icon,
    .contentieux-icon,
    .toast__icon,
    .form__input-group,
    .search-container,
    .filter-select,
    .progress-bar{
      background: var(--soft) !important;
    }
    .btn-icon{ background: var(--soft) !important; }
    .btn:not(.btn--primary):not(.btn--danger):not(.btn--link):not(.btn--outline){ background: var(--soft) !important; }

    /* Surface polish: subtle highlight */
    .sidebar__container,
    .sidebar-desktop-toggle,
    .header,
    .card, .dashboard-card, .stats-card,
    .notifications__dropdown,
    .profile__dropdown,
    .detail-modal, .confirm-modal{
      position: relative;
    }

    .sidebar__container::before,
    .header::before,
    .card::before, .dashboard-card::before, .stats-card::before,
    .notifications__dropdown::before,
    .profile__dropdown::before,
    .detail-modal::before, .confirm-modal::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.12), transparent 42%);
      opacity:.22;
      pointer-events:none;
    }

    body.light-theme .sidebar__container::before,
    body.light-theme .header::before,
    body.light-theme .card::before, body.light-theme .dashboard-card::before, body.light-theme .stats-card::before,
    body.light-theme .notifications__dropdown::before,
    body.light-theme .profile__dropdown::before,
    body.light-theme .detail-modal::before, body.light-theme .confirm-modal::before{
      background: linear-gradient(180deg, rgba(15,23,42,.06), transparent 46%);
      opacity:.35;
    }

    /* Make overlays clean (less “glass”) */
    .login-screen, .detail-modal-backdrop, .confirm-modal-backdrop, .loading-overlay{ background: rgba(2,6,23,.72); }
    body.light-theme .login-screen,
    body.light-theme .detail-modal-backdrop,
    body.light-theme .confirm-modal-backdrop,
    body.light-theme .loading-overlay{ background: rgba(15,23,42,.25); }

    /* Hover polish */
    .nav__link:hover{ background: var(--soft2); }

    /* Light theme polish (more contrast, less "washed") */
    body.light-theme .nav__link.active{ background: linear-gradient(135deg, rgba(124,58,237,.16), rgba(6,182,212,.10)); border-color: rgba(124,58,237,.22); }
    body.light-theme .nav__badge{ background: rgba(2,6,23,.04); }
    body.light-theme .btn--outline{ background: transparent; border-color: rgba(15,23,42,.14); }
    body.light-theme .btn--outline:hover{ background: rgba(124,58,237,.06); border-color: rgba(124,58,237,.22); }
    body.light-theme .btn-icon:hover{ background: rgba(124,58,237,.06) !important; }
    body.light-theme .pill{ background: rgba(2,6,23,.04); color: rgba(2,6,23,.70); }
    body.light-theme .pill.etatique{ background: rgba(124,58,237,.12); color: rgba(88,28,135,.95); }
    body.light-theme .pill.prive{ background: rgba(6,182,212,.10); color: rgba(12,74,110,.95); }
    body.light-theme .pill.contentieux{ background: rgba(249,115,22,.10); color: rgba(124,45,18,.95); }
    body.light-theme .tab-btn{ color: rgba(2,6,23,.62); }
    body.light-theme .tab-btn.active{ background: rgba(124,58,237,.14); color: rgba(88,28,135,.95); border-color: rgba(124,58,237,.22); }

    /* Responsive */
    @media (max-width: 1100px){
      .stats-card{grid-column: span 6;}
      .stats-card--document-types{grid-column: span 6;}
      .stats-card--contentieux{grid-column: span 6;}
      .activity-summary{grid-column: span 12;}
      .agent-performance{grid-column: span 12;}
      .recent-imputations{grid-column: span 12;}
      .recent-arrivals{grid-column: span 12;}
      .conventions-overview{grid-column: span 12;}
      .commission-dashboard-card{grid-column: span 12;}
    }

    @media (max-width: 880px){
      .header__menu-toggle{display:flex; align-items:center; justify-content:center;}
      .sidebar{position:fixed; left:0; top:0; transform: translateX(-105%); width: 290px;}
      .sidebar.open{transform: translateX(0);}
      .sidebar__toggle-mobile{display:flex; align-items:center; justify-content:center;}
      .sidebar-toggle-rail{display:none !important;}
      .sidebar-desktop-toggle{display:none !important;}
      .header__search{min-width: 0; width: 52vw;}
      .form__group{grid-column: span 12;}

      /* ===== Dashboard (mobile): 8 premières cartes (stats) en une colonne ===== */
      .stats-overview{ grid-template-columns: repeat(12, 1fr); }
      .stats-card{ grid-column: span 12 !important; min-height: unset; }
      .stats-card--document-types,
      .stats-card--contentieux,
      .stats-card--mobilisation,
      .stats-card--refs{ grid-column: span 12 !important; }

      /* Make sparklines fit nicely */
      .stats-card__chart{ width: 80px; height: 48px; }
      .stats-card__chart canvas{ width: 80px !important; height: 48px !important; }

      /* Reduce pill size a bit for small screens */
      .stats-card__trend{ gap:6px; }
      .trend-pill{ padding: 4px 8px; }

      /* Avoid nested scrolls on mobile for refs card */
      .refs-grid{ max-height: none; overflow: visible; padding-right: 0; }

      /* Dropdowns: mobile-friendly sizing */
      .notifications__dropdown,
      .profile__dropdown{
        width: calc(100vw - 16px) !important;
        max-width: calc(100vw - 16px) !important;
        max-height: calc(100vh - 16px) !important;
      }
      /* In mobile we rely on flex + overflow for proper scrolling */
      .dropdown__items{ max-height: none !important; }
    }


    /* ===== Primary color override (BLUE) — remove remaining violet accents ===== */
    :root{
      --accent-strong: rgba(37,99,235,1);  /* #2563eb */
      --accent-soft: rgba(96,165,250,1);   /* #60a5fa */
    }

    /* Global backgrounds (remove violet glow) */
    body{
      background:
        radial-gradient(900px 600px at 12% 8%, rgba(37,99,235,.28), transparent 55%),
        radial-gradient(900px 600px at 88% 18%, rgba(6,182,212,.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body.light-theme{
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(37,99,235,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(6,182,212,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Sidebar toggle accents */
    .sidebar-desktop-toggle::after{
      background: linear-gradient(180deg, rgba(37,99,235,.98), rgba(6,182,212,.85));
    }
    .sidebar-desktop-toggle::before{
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.28), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(6,182,212,.22), transparent 55%);
    }
    .sidebar-desktop-toggle:hover{ border-color: rgba(37,99,235,.35); }
    body.light-theme .sidebar-desktop-toggle:hover{ border-color: rgba(37,99,235,.28); }

    /* Active/selected backgrounds (menus, selects) */
    .range-option.is-active,
    .select-option.is-selected{
      background: linear-gradient(135deg, rgba(37,99,235,.20), rgba(6,182,212,.12));
      border-color: rgba(37,99,235,.22);
    }

    /* Remove remaining violet-only accents by overriding common legacy gradients */
    .range-option.is-active::after,
    .select-option.is-selected::after{ color: var(--primary2) !important; }

    /* Legend (Imputations swatch) */
    .swatch-imp{ background: linear-gradient(180deg, rgba(96,165,250,1), rgba(37,99,235,1)); }

    /* Legend hover border (was violet) */
    .legend-item:hover{ border-color: rgba(37,99,235,.28); }
    body.light-theme .legend-item:hover{ border-color: rgba(37,99,235,.22); }

    /* Activity unread (blue) */
    .activity-item.unread{ background: rgba(37,99,235,.10); }
    body.light-theme .activity-item.unread{ background: rgba(37,99,235,.08); }

    /* Detail chips (Imputation) (was violet) */
    .detail-chip.imp{ background: rgba(37,99,235,.14); color: var(--primary2); border-color: rgba(37,99,235,.22); }

    /* Pills (ETATIQUE) + tabs active (dark) (was violet) */
    .pill.etatique{ background: rgba(37,99,235,.16); color: var(--primary2); }
    .tab-btn.active{ background: rgba(37,99,235,.16); color: var(--primary2); border-color: rgba(37,99,235,.25); }

    /* Agent avatar (Mr) */
    .agent-avatar--male{
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(96,165,250,.10));
      color: var(--primary2);
    }

    /* Refs card: DUDU accent (was violet) */
    .ref-pill.dudu .ref-pill__icon{ background: rgba(37,99,235,.12); color: var(--primary2); }

    /* Pills/tabs (light theme accents) */
    body.light-theme .nav__link.active{ background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(6,182,212,.10)); border-color: rgba(37,99,235,.22); }
    body.light-theme .tab-btn.active{ background: rgba(37,99,235,.12); color: rgba(30,58,138,.95); border-color: rgba(37,99,235,.22); }
    body.light-theme .btn--outline:hover{ background: rgba(37,99,235,.06); border-color: rgba(37,99,235,.22); }
    body.light-theme .btn-icon:hover{ background: rgba(37,99,235,.06) !important; }
    body.light-theme .pill.etatique{ background: rgba(37,99,235,.12); color: rgba(30,58,138,.95); }

    /* Toast default accent (was violet) */
    .toast-notification{ --toast-accent: rgba(37,99,235,1); --toast-icon-bg: rgba(37,99,235,.14); --toast-glow: rgba(37,99,235,.18); }

    /* Scrollbars (was violet) */
    *{ scrollbar-color: rgba(37,99,235,.55) transparent; }
    *::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(37,99,235,.95), rgba(6,182,212,.85));
    }
    *::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(180deg, rgba(37,99,235,1), rgba(6,182,212,1));
    }
    body.light-theme *{ scrollbar-color: rgba(37,99,235,.45) transparent; }
    body.light-theme *::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(37,99,235,.70), rgba(6,182,212,.55));
    }

    /* Loading ring + bar (remove violet) */
    .loading-ring{
      background:
        conic-gradient(from 0deg, rgba(37,99,235,1), rgba(6,182,212,1), rgba(245,158,11,.95), rgba(37,99,235,1));
    }
    .loading-bar__fill{
      background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(6,182,212,.85));
    }

    /* Login (remove violet accents) */
    .login-screen{
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(860px 520px at 86% 18%, rgba(6,182,212,.18), transparent 60%),
        radial-gradient(900px 520px at 55% 95%, rgba(245,158,11,.14), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.78));
    }
    .login-screen::before{ background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.85), transparent 60%); }
    .login-card{
      background:
        linear-gradient(var(--panel2), var(--panel2)) padding-box,
        linear-gradient(135deg, rgba(37,99,235,.95), rgba(6,182,212,.78), rgba(245,158,11,.40)) border-box;
    }
    .brand-mark{ background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(6,182,212,.14)); }

    .creator-badge{
      background:
        linear-gradient(var(--soft), var(--soft)) padding-box,
        linear-gradient(135deg, rgba(37,99,235,.95), rgba(6,182,212,.70), rgba(245,158,11,.40)) border-box;
    }
    body.light-theme .creator-badge{
      background:
        linear-gradient(#ffffff, #ffffff) padding-box,
        linear-gradient(135deg, rgba(37,99,235,.80), rgba(6,182,212,.55), rgba(245,158,11,.35)) border-box;
    }

    @media print{
      .sidebar, .header, .sidebar-desktop-toggle, .bg-shape, .activity-feed__trigger, .activity-feed, .toast-notification, .loading-overlay, .login-screen {display:none !important;}
      .section{display:block !important;}
      .card, .dashboard-card{box-shadow:none;}
      body{background:white !important; color:black !important;}
    }
  </style>
</head>

<body class="dark-theme app-boot">
    <!-- Welcome (before app appears) -->
    <div class="welcome-screen" id="welcome-screen" aria-label="Bienvenue" role="dialog" aria-modal="true">
      <div class="welcome-glow" aria-hidden="true"></div>
      <div class="welcome-card" role="status" aria-live="polite">
        <div class="welcome-mark" aria-hidden="true"><i class="ri-mail-fill"></i></div>
        <div class="welcome-title">BIENVENUE SUR LA PLATEFORME</div>
        <div class="welcome-sub">DU SCE COURRIER <b>SDMFPIPPDC</b></div>
        <div class="welcome-line" aria-hidden="true"></div>
        <div class="welcome-hint">Cliquez pour continuer</div>
      </div>
    </div>

    <div class="login-screen is-hidden" id="login-screen">
        <div class="login-particles" aria-hidden="true"></div>
        <div class="login-card">
            <div class="login-card__brand" aria-hidden="true">
              <div class="brand-mark"><i class="ri-shield-keyhole-fill"></i></div>
              <div class="brand-text">
                <div class="brand-name">SDMFPIPPDC</div>
                <div class="brand-sub">Accès administrateur</div>
              </div>
              <div class="brand-chip">Sécurisé</div>
            </div>

            <h1 class="login-card__title">Connexion</h1>
            <p class="login-card__subtitle">Accès réservé à l'administrateur du SDMFPIPPDC</p>
            <form id="login-form" class="form">
                <div class="login-card__field form__group">
                    <label class="form__label" for="login-username">Identifiant</label>
                    <div class="form__input-group">
                        <span class="input-icon"><i class="ri-user-line"></i></span>
                        <input type="text" id="login-username" class="form__control" placeholder="Utilisateur" autocomplete="username">
                    </div>
                </div>
                <div class="login-card__field form__group">
                    <label class="form__label" for="login-password">Mot de passe</label>
                    <div class="form__input-group">
                        <span class="input-icon"><i class="ri-lock-password-line"></i></span>
                        <input type="password" id="login-password" class="form__control" placeholder="Mot de passe" autocomplete="current-password">
                    </div>
                    <div class="text-xs" id="caps-hint" style="color: var(--muted2); font-weight:900; display:none; margin-top:6px;">
                      <i class="ri-alert-line"></i>
                      <span>Verr. Maj activé</span>
                    </div>
                </div>
                <div class="login-card__error" id="login-error"></div>
                <div class="login-card__actions">
                    <button type="button" class="btn btn--outline" id="login-cancel">
                        <i class="ri-close-line"></i>
                        <span>Annuler</span>
                    </button>
                    <button type="submit" class="btn btn--primary">
                        <i class="ri-login-circle-line"></i>
                        <span>Se connecter</span>
                    </button>
                </div>
            </form>
            <div class="creator-badge creator-badge--login" aria-label="Crédit">
              <i class="ri-sparkling-2-fill" aria-hidden="true"></i>
              <span>créer par <b>Mr.JMK</b></span>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Background shapes -->
        <div class="bg-shape shape-1"></div>
        <div class="bg-shape shape-2"></div>
        <div class="bg-shape shape-3"></div>

        <!-- Sidebar backdrop (mobile) -->
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

        <!-- Dropdown backdrop (notifications / profil) -->
        <div class="dropdown-backdrop" id="dropdown-backdrop" aria-hidden="true"></div>

        <!-- Loading overlay -->
        <div class="loading-overlay is-hidden" id="loadingOverlay" aria-live="polite" aria-busy="true">
            <div class="loading-content">
                <div class="loading-logo">
                    <i class="ri-mail-fill"></i>
                    <span>SDMFPIPPDC</span>
                </div>

                <div class="loading-ring" aria-hidden="true"></div>

                <div class="loading-bar" aria-hidden="true">
                  <div class="loading-bar__fill"></div>
                </div>

                <p class="loading-text" id="loadingText">Initialisation…</p>
            </div>
        </div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__container">
                <div class="sidebar__header">
                    <div class="sidebar__brand">
                        <i class="ri-mail-fill"></i>
                        <span>SDMFPIPPDC</span>
                    </div>

                    <button class="sidebar__toggle-mobile" id="sidebar-toggle-mobile" aria-label="Fermer le menu">
                        <i class="ri-close-line"></i>
                    </button>
                </div>

                <div class="sidebar__profile">
                    <div class="profile__avatar">
                        <img src="https://images.unsplash.com/photo-1565464027194-7957a2295fb7?w=400&auto=format&fit=crop&q=60" alt="admin" id="user-avatar">
                        <div class="avatar__status"></div>
                    </div>

                    <div class="profile__details">
                        <h3 id="user-role">Invité</h3>
                        <span id="user-email">invite@sdmfpippdc.gov</span>
                    </div>
                </div>

                <nav class="sidebar__menu">
                    <div class="sidebar__category">
                        <h3 class="sidebar__title">Menu principal</h3>
                        <ul class="nav__list">
                            <li class="nav__item">
                                <a href="#" class="nav__link active" data-section="dashboard">
                                    <span class="nav__link-left">
                                        <i class="ri-dashboard-fill nav__icon"></i>
                                        <span class="nav__name">Tableau de bord</span>
                                    </span>
                                </a>
                            </li>
                            <li class="nav__item nav__divider" aria-hidden="true"></li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="imputation-form">
                                    <span class="nav__link-left">
                                        <i class="ri-edit-box-fill nav__icon"></i>
                                        <span class="nav__name">Imputation courrier</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="imputation-list">
                                    <span class="nav__link-left">
                                        <i class="ri-file-list-3-line nav__icon"></i>
                                        <span class="nav__name">Liste imputations</span>
                                    </span>
                                    <span class="nav__badge" id="badge-imputations">0</span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="arrival-form">
                                    <span class="nav__link-left">
                                        <i class="ri-mail-add-fill nav__icon"></i>
                                        <span class="nav__name">Courrier arrivée</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="arrival-list">
                                    <span class="nav__link-left">
                                        <i class="ri-mail-open-fill nav__icon"></i>
                                        <span class="nav__name">Liste arrivées</span>
                                    </span>
                                    <span class="nav__badge" id="badge-arrivals">0</span>
                                </a>
                            </li>

                            <li class="nav__item nav__divider" aria-hidden="true"></li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="convention-form">
                                    <span class="nav__link-left">
                                        <i class="ri-contracts-fill nav__icon"></i>
                                        <span class="nav__name">Convention signée</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="convention-list">
                                    <span class="nav__link-left">
                                        <i class="ri-article-fill nav__icon"></i>
                                        <span class="nav__name">Liste conventions</span>
                                    </span>
                                    <span class="nav__badge" id="badge-conventions">0</span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="commission-form">
                                    <span class="nav__link-left">
                                        <i class="ri-community-fill nav__icon"></i>
                                        <span class="nav__name">Commission admin</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="commission-list">
                                    <span class="nav__link-left">
                                        <i class="ri-organization-chart nav__icon"></i>
                                        <span class="nav__name">Liste commissions</span>
                                    </span>
                                    <span class="nav__badge" id="badge-commissions">0</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar__category">
                        <h3 class="sidebar__title">Paramètres</h3>
                        <ul class="nav__list">
                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="settings">
                                    <span class="nav__link-left">
                                        <i class="ri-settings-3-fill nav__icon"></i>
                                        <span class="nav__name">Paramètres</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <a href="#" class="nav__link" data-section="profile">
                                    <span class="nav__link-left">
                                        <i class="ri-user-3-fill nav__icon"></i>
                                        <span class="nav__name">Profil</span>
                                    </span>
                                </a>
                            </li>

                            <li class="nav__item">
                                <div class="nav__link" id="theme-toggle" role="button" tabindex="0">
                                    <span class="nav__link-left">
                                        <i class="ri-moon-clear-fill nav__icon" id="theme-button"></i>
                                        <span class="nav__name">Thème</span>
                                    </span>
                                    <div class="theme-switch" id="sidebar-theme-switch" aria-label="Basculer le thème">
                                        <div class="switch-track"></div>
                                        <div class="switch-thumb"></div>
                                    </div>
                                </div>
                            </li>

                            <li class="nav__item">
                                <div class="nav__link" id="auth-toggle-btn" role="button" tabindex="0">
                                    <span class="nav__link-left">
                                        <i class="ri-login-box-line nav__icon" id="auth-toggle-icon"></i>
                                        <span class="nav__name" id="auth-toggle-label">Connexion administrateur</span>
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- Toggle rail: placé ENTRE le sidebar et le contenu -->
        <div class="sidebar-toggle-rail" id="sidebar-toggle-rail">
          <button class="sidebar-desktop-toggle" id="sidebar-desktop-toggle" aria-label="Afficher ou masquer le menu">
              <i class="ri-arrow-left-s-line"></i>
          </button>
        </div>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- HEADER -->
            <header class="header">
                <div class="header__left">
                    <button class="header__menu-toggle" id="menu-toggle" aria-label="Ouvrir le menu">
                        <i class="ri-menu-line"></i>
                    </button>

                    <div class="header__search">
                        <i class="ri-search-line"></i>
                        <input type="text" placeholder="Rechercher..." id="global-search" />
                    </div>
                </div>

                <div class="header__right">
                    <div class="header__notifications">
                        <div class="notifications__trigger" id="notifications-trigger" role="button" tabindex="0" aria-label="Notifications">
                            <i class="ri-notification-3-fill"></i>
                            <div class="notifications__badge" id="notifications-badge">0</div>
                        </div>

                        <div class="notifications__dropdown" id="notifications-dropdown" aria-label="Liste des notifications">
                            <div class="dropdown__header">
                                <h3>Notifications</h3>
                                <button class="mark-read" id="mark-notifications-read">Tout marquer comme lu</button>
                            </div>
                            <div class="dropdown__items" id="notifications-list">
                                <!-- Notifications alimentées dynamiquement (aucun exemple en production) -->
                            </div>
                            <div class="dropdown__footer">
                                <a href="#">Voir toutes les notifications</a>
                            </div>
                        </div>
                    </div>

                    <div class="header__profile" id="header-profile" role="button" tabindex="0" aria-label="Profil">
                        <img src="https://images.unsplash.com/photo-1565464027194-7957a2295fb7?w=400&auto=format&fit=crop&q=60" alt="Admin" id="header-avatar">
                        <span id="header-name">Invité</span>
                        <i class="ri-arrow-down-s-line"></i>

                        <div class="profile__dropdown" id="profile-dropdown">
                            <div class="dropdown__header">
                                <div class="header__avatar">
                                    <img src="https://images.unsplash.com/photo-1565464027194-7957a2295fb7?w=400&auto=format&fit=crop&q=60" alt="Avatar" id="dropdown-avatar">
                                </div>
                                <div class="header__info">
                                    <h3>Administrateur SDMFPIPPDC</h3>
                                    <span>admin@sdmfpippdc.gov</span>
                                </div>
                            </div>
                            <div class="dropdown__items">
                                <a href="#" class="dropdown__link" data-section="profile">
                                    <i class="ri-user-settings-line"></i>
                                    <span>Mon profil</span>
                                </a>
                                <a href="#" class="dropdown__link" data-section="settings">
                                    <i class="ri-settings-4-line"></i>
                                    <span>Paramètres</span>
                                </a>
                                <div class="dropdown__divider"></div>
                                <a href="#" class="dropdown__link" id="dropdown-login" style="display:none">
                                    <i class="ri-login-circle-line"></i>
                                    <span>Connexion administrateur</span>
                                </a>
                                <a href="#" class="dropdown__link" id="dropdown-logout">
                                    <i class="ri-logout-box-r-line"></i>
                                    <span>Déconnexion</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- CONTENT WRAPPER -->
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <section class="section active-section" id="dashboard-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Tableau de bord</h1>
                            <p class="section__subtitle">Vue d'ensemble du système de gestion documentaire</p>
                        </div>

                        <div class="section__actions">
                            <div class="date-picker" id="dash-range-trigger" role="button" tabindex="0" aria-label="Choisir la période du tableau de bord">
                                <i class="ri-calendar-2-fill"></i>
                                <span id="dash-range">Période: 30 derniers jours</span>
                                <i class="ri-arrow-down-s-line"></i>
                            </div>

                            <div class="range-menu" id="dash-range-menu" aria-label="Sélection de période">
                              <div class="range-menu__title">Période</div>
                              <button class="range-option" type="button" data-days="7"><span>7 derniers jours</span><span style="color:var(--muted2); font-weight:900; font-size:12px;">1 semaine</span></button>
                              <button class="range-option" type="button" data-days="14"><span>14 derniers jours</span><span style="color:var(--muted2); font-weight:900; font-size:12px;">2 semaines</span></button>
                              <button class="range-option" type="button" data-days="30"><span>30 derniers jours</span><span style="color:var(--muted2); font-weight:900; font-size:12px;">1 mois</span></button>
                              <button class="range-option" type="button" data-days="90"><span>90 derniers jours</span><span style="color:var(--muted2); font-weight:900; font-size:12px;">3 mois</span></button>
                            </div>

                            <button class="btn btn--outline" id="btn-refresh-dashboard">
                                <i class="ri-refresh-line"></i>
                                <span>Actualiser</span>
                            </button>

                            <button class="btn btn--primary" id="btn-new">
                                <i class="ri-add-line"></i>
                                <span>Nouveau</span>
                            </button>

                            <div class="creator-badge creator-badge--dash" title="Crédit">
                              <i class="ri-sparkling-2-fill" aria-hidden="true"></i>
                              <span>créer par <b>Mr.JMK</b></span>
                            </div>
                        </div>
                    </div>


                    <div class="stats-overview">
                        <div class="stats-card stats-card--primary">
                            <div class="stats-card__icon"><i class="ri-mail-send-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Courriers imputés</h3>
                                <div class="stats-card__number" id="total-imputations">0</div>
                                <div class="stats-card__trend"><i class="ri-bar-chart-2-line"></i>
                                  <span class="trend-pill">Aujourd’hui: <b id="imp-day">0</b></span>
                                  <span class="trend-pill">Ce mois: <b id="imp-month">0</b></span>
                                </div>
                            </div>
                            <div class="stats-card__chart"><canvas id="imputationsChart"></canvas></div>
                        </div>

                        <div class="stats-card stats-card--secondary">
                            <div class="stats-card__icon"><i class="ri-mail-download-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Courriers arrivés</h3>
                                <div class="stats-card__number" id="total-arrivals">0</div>
                                <div class="stats-card__trend"><i class="ri-bar-chart-2-line"></i>
                                  <span class="trend-pill">Aujourd’hui: <b id="arr-day">0</b></span>
                                  <span class="trend-pill">Ce mois: <b id="arr-month">0</b></span>
                                </div>
                            </div>
                            <div class="stats-card__chart"><canvas id="arrivalsChart"></canvas></div>
                        </div>

                        <div class="stats-card stats-card--tertiary">
                            <div class="stats-card__icon"><i class="ri-contract-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Conventions signées</h3>
                                <div class="stats-card__number" id="total-conventions">0</div>
                                <div class="stats-card__trend"><i class="ri-bar-chart-2-line"></i>
                                  <span class="trend-pill">Aujourd’hui: <b id="conv-day">0</b></span>
                                  <span class="trend-pill">Ce mois: <b id="conv-month">0</b></span>
                                </div>
                            </div>
                            <div class="stats-card__chart"><canvas id="conventionsChart"></canvas></div>
                        </div>

                        <div class="stats-card stats-card--quaternary">
                            <div class="stats-card__icon"><i class="ri-group-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Commissions</h3>
                                <div class="stats-card__number" id="total-commissions">0</div>
                                <div class="stats-card__trend"><i class="ri-bar-chart-2-line"></i>
                                  <span class="trend-pill">Aujourd’hui: <b id="comm-day">0</b></span>
                                  <span class="trend-pill">Ce mois: <b id="comm-month">0</b></span>
                                </div>
                            </div>
                            <div class="stats-card__chart"><canvas id="commissionsChart"></canvas></div>
                        </div>

                        <div class="stats-card stats-card--document-types">
                            <div class="stats-card__icon"><i class="ri-bookmark-3-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Types de documents</h3>

                                <div class="doc-types">
                                  <div class="doc-type-block">
                                    <div class="doc-type-head">
                                      <div class="doc-type-left">
                                        <span class="doc-type-dot etatique"></span>
                                        <div>
                                          <div class="doc-type-name">ÉTATIQUE</div>
                                          <div class="doc-type-meta"><span id="pct-etatique">0%</span> du total</div>
                                        </div>
                                      </div>
                                      <div class="doc-type-count" id="total-etatique">0</div>
                                    </div>
                                    <div class="doc-type-bar"><div class="doc-type-fill etatique" id="progress-etatique" style="width: 0%"></div></div>
                                  </div>

                                  <div class="doc-type-block">
                                    <div class="doc-type-head">
                                      <div class="doc-type-left">
                                        <span class="doc-type-dot prive"></span>
                                        <div>
                                          <div class="doc-type-name">PRIVÉ</div>
                                          <div class="doc-type-meta"><span id="pct-prive">0%</span> du total</div>
                                        </div>
                                      </div>
                                      <div class="doc-type-count" id="total-prive">0</div>
                                    </div>
                                    <div class="doc-type-bar"><div class="doc-type-fill prive" id="progress-prive" style="width: 0%"></div></div>
                                  </div>

                                  <div class="doc-types-footer">
                                    <span class="doc-types-chip"><i class="ri-file-list-3-line"></i><span>Total imputations: <b id="doc-total">0</b></span></span>
                                    <span class="doc-types-chip"><i class="ri-pie-chart-2-line"></i><span>Répartition automatique</span></span>
                                  </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card stats-card--contentieux">
                            <div class="stats-card__icon"><i class="ri-scales-3-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Contentieux</h3>
                                <div class="contentieux-wrapper">
                                    <div class="contentieux-item">
                                        <div class="contentieux-icon"><i class="ri-file-list-3-fill"></i></div>
                                        <div class="contentieux-details">
                                            <div class="contentieux-label">Total contentieux</div>
                                            <div class="contentieux-count" id="total-contentieux">0</div>
                                        </div>
                                    </div>

                                    <div style="color:var(--muted2); font-size:12px; font-weight:900; padding: 6px 2px 0;">
                                      Basé sur les imputations de type <b style="color:var(--text)">CONTENTIEUX</b>.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card stats-card--mobilisation">
                            <div class="stats-card__icon"><i class="ri-megaphone-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Mobilisation</h3>
                                <div class="mobilisation-wrap">
                                  <div class="mobilisation-head">
                                    <div class="mobilisation-left">
                                      <div class="mobilisation-icon"><i class="ri-megaphone-fill"></i></div>
                                      <div>
                                        <div class="mobilisation-label">Total mobilisation</div>
                                        <div class="mobilisation-value" id="total-mobilisation">0</div>
                                      </div>
                                    </div>
                                    <span class="mobilisation-chip"><i class="ri-pulse-line"></i><span id="mobilisation-pct">0%</span></span>
                                  </div>

                                  <div class="mobilisation-bar">
                                    <div class="mobilisation-fill" id="mobilisation-bar" style="width:0%"></div>
                                  </div>

                                  <div class="mobilisation-footer">
                                    <span class="doc-types-chip"><i class="ri-megaphone-fill"></i><span>Mobilisation</span></span>
                                  </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-card stats-card--refs">
                            <div class="stats-card__icon"><i class="ri-barcode-box-fill"></i></div>
                            <div class="stats-card__content">
                                <h3 class="stats-card__title">Références (Arrivées)</h3>

                                <div class="refs-grid" aria-label="Totaux des références">
                                  <div class="ref-pill cab">
                                    <div class="ref-pill__icon"><i class="ri-inbox-archive-line"></i></div>
                                    <div class="ref-pill__meta">
                                      <div class="ref-pill__label">Total CAB</div>
                                      <div class="ref-pill__value" id="total-cab">0</div>
                                    </div>
                                  </div>

                                  <div class="ref-pill dudu">
                                    <div class="ref-pill__icon"><i class="ri-file-copy-2-line"></i></div>
                                    <div class="ref-pill__meta">
                                      <div class="ref-pill__label">Total DUDU</div>
                                      <div class="ref-pill__value" id="total-dudu">0</div>
                                    </div>
                                  </div>

                                  <div class="ref-pill dguf">
                                    <div class="ref-pill__icon"><i class="ri-shield-check-line"></i></div>
                                    <div class="ref-pill__meta">
                                      <div class="ref-pill__label">Total DGUF/</div>
                                      <div class="ref-pill__value" id="total-dguf">0</div>
                                    </div>
                                  </div>

                                  <div class="ref-pill ddu">
                                    <div class="ref-pill__icon"><i class="ri-file-shield-2-line"></i></div>
                                    <div class="ref-pill__meta">
                                      <div class="ref-pill__label">Total DDU/</div>
                                      <div class="ref-pill__value" id="total-ddu">0</div>
                                    </div>
                                  </div>

                                  <div class="ref-pill pce ref-pill--wide">
                                    <div class="ref-pill__icon"><i class="ri-file-search-line"></i></div>
                                    <div class="ref-pill__meta">
                                      <div class="ref-pill__label">Total PCE</div>
                                      <div class="ref-pill__value" id="total-pce">0</div>
                                    </div>
                                  </div>

                                  <div class="refs-footer">
                                    <span class="doc-types-chip"><i class="ri-mail-open-fill"></i><span>Synchronisé avec la liste des arrivées</span></span>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-card activity-summary">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-file-chart-line"></i><span>Résumé des activités</span></h2>
                                <div class="dashboard-card__actions"><button class="btn-icon" id="open-activity-feed" title="Ouvrir le journal"><i class="ri-more-2-fill"></i></button></div>
                            </div>
                            <div class="dashboard-card__content">
                              <div class="activity-legend" aria-label="Légende des activités">
                                <div class="legend-item"><span class="legend-swatch swatch-imp"></span><span class="legend-name">Imputations</span><span class="legend-value" id="legend-imp">0</span></div>
                                <div class="legend-item"><span class="legend-swatch swatch-arr"></span><span class="legend-name">Arrivées</span><span class="legend-value" id="legend-arr">0</span></div>
                                <div class="legend-item"><span class="legend-swatch swatch-conv"></span><span class="legend-name">Conventions</span><span class="legend-value" id="legend-conv">0</span></div>
                                <div class="legend-item"><span class="legend-swatch swatch-comm"></span><span class="legend-name">Commissions</span><span class="legend-value" id="legend-comm">0</span></div>
                                <div class="legend-hint" id="legend-hint">Total global • Graph: 14 jours</div>
                              </div>
                              <div class="activity-chart-wrapper"><canvas id="activityChart"></canvas></div>
                            </div>
                        </div>

                        <div class="dashboard-card agent-performance">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-team-fill"></i><span>Performance des agents</span></h2>
                                <div class="dashboard-card__actions"><button class="btn btn--sm btn--outline active" id="agents-scope">Tous les agents</button></div>
                            </div>
                            <div class="dashboard-card__content"><div class="agent-list" id="agent-performance-list"></div></div>
                        </div>

                        <div class="dashboard-card recent-imputations">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-file-list-3-fill"></i><span>Dernières imputations</span></h2>
                                <div class="dashboard-card__actions">
                                    <button class="btn-icon" id="refresh-recent-imputations"><i class="ri-refresh-line"></i></button>
                                    <button class="btn-icon" id="more-imputations"><i class="ri-more-2-fill"></i></button>
                                </div>
                            </div>
                            <div class="dashboard-card__content" id="recent-imputations"></div>
                            <div class="dashboard-card__footer">
                                <a href="#" class="btn btn--link" data-section="imputation-list"><span>Voir toutes les imputations</span><i class="ri-arrow-right-line"></i></a>
                            </div>
                        </div>

                        <div class="dashboard-card recent-arrivals">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-mail-open-fill"></i><span>Derniers courriers arrivés</span></h2>
                                <div class="dashboard-card__actions">
                                    <button class="btn-icon" id="refresh-recent-arrivals"><i class="ri-refresh-line"></i></button>
                                    <button class="btn-icon" id="more-arrivals"><i class="ri-more-2-fill"></i></button>
                                </div>
                            </div>
                            <div class="dashboard-card__content" id="recent-arrivals"></div>
                            <div class="dashboard-card__footer">
                                <a href="#" class="btn btn--link" data-section="arrival-list"><span>Voir tous les courriers arrivés</span><i class="ri-arrow-right-line"></i></a>
                            </div>
                        </div>

                        <div class="dashboard-card conventions-overview">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-contract-fill"></i><span>Conventions récentes</span></h2>
                                <div class="dashboard-card__tabs">
                                    <button class="tab-btn active" data-type="all">Toutes</button>
                                    <button class="tab-btn" data-type="prive">Privées</button>
                                    <button class="tab-btn" data-type="etatique">Étatiques</button>
                                </div>
                            </div>
                            <div class="dashboard-card__content">
                                <div class="conventions-wrapper" id="conventionScroller"></div>
                            </div>
                            <div class="dashboard-card__footer convention-stats">
                                <div class="stat-item"><span class="stat-label">Total:</span> <span class="stat-value" id="convention-stats-total">0 conventions</span></div>
                                <div class="stat-item"><span class="stat-label">Privées:</span> <span class="stat-value" id="convention-stats-prive">0</span></div>
                                <div class="stat-item"><span class="stat-label">Étatiques:</span> <span class="stat-value" id="convention-stats-etatique">0</span></div>
                            </div>
                        </div>

                        <div class="dashboard-card commission-dashboard-card">
                            <div class="dashboard-card__header">
                                <h2 class="dashboard-card__title"><i class="ri-organization-chart"></i><span>Commission administrative</span></h2>
                                <div class="dashboard-card__actions"><button class="btn-icon" id="refresh-dashboard-commissions"><i class="ri-refresh-line"></i></button></div>
                            </div>
                            <div class="dashboard-card__content">
                                <div class="commission-dashboard-summary">
                                    <div class="commission-stat"><span class="label">Total commissions</span><span class="value" id="dashboard-commission-total">0</span></div>
                                    <div class="commission-stat"><span class="label">Prochaine commission</span><span class="value" id="dashboard-commission-next">-</span></div>
                                </div>
                                <div class="commission-dashboard-list" id="dashboard-commission-list"></div>
                            </div>
                            <div class="dashboard-card__footer">
                                <a href="#" class="btn btn--link" data-section="commission-list"><span>Voir toutes les commissions</span><i class="ri-arrow-right-line"></i></a>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Imputation form section -->
                <section class="section" id="imputation-form-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Formulaire d'imputation</h1>
                            <p class="section__subtitle">Enregistrer une nouvelle imputation de courrier</p>
                        </div>
                        <div class="section__actions">
                            <button type="button" class="btn btn--outline" id="reset-imputation-form"><i class="ri-refresh-line"></i><span>Réinitialiser</span></button>
                            <button type="button" class="btn btn--primary" id="submit-imputation-form"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <form class="form" id="imputation-form" novalidate>
                            <input type="hidden" id="imputation-edit-id" value="" />
                            <div class="card__content">
                              <div class="form__grid">
                                  <div class="form__group">
                                      <label class="form__label" for="imputation-number">Numéro d'imputation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-hashtag"></i></span>
                                          <input type="text" id="imputation-number" class="form__control" placeholder="IMP-2025-001">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="imputation-date">Date d'imputation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="imputation-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="mail-number">Numéro du courrier</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-mail-line"></i></span>
                                          <input type="text" id="mail-number" class="form__control" placeholder="Ex: SDM-001-25">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="arrival-date">Date d'arrivée</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="arrival-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="mail-object">Objet du courrier</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-chat-1-line"></i></span>
                                          <input type="text" id="mail-object" class="form__control" placeholder="Saisissez l'objet du courrier">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="imputation-object">Objet de l'imputation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-file-text-line"></i></span>
                                          <textarea id="imputation-object" class="form__control" rows="3" placeholder="Saisissez l'objet de l'imputation"></textarea>
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="structure">Structure destinataire</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-government-line"></i></span>
                                          <input type="text" id="structure" class="form__control" placeholder="Nom de la structure">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="imputation-type">Type d'imputation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-list-check"></i></span>
                                          <select id="imputation-type" class="form__control">
                                              <option value="">Sélectionnez un type</option>
                                              <option value="ETATIQUE">ETATIQUE</option>
                                              <option value="PRIVE">PRIVE</option>
                                              <option value="CONTENTIEUX">CONTENTIEUX</option>
                                              <option value="MOBILISATION">MOBILISATION</option>
                                          </select>
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="agent">Agent responsable</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-user-line"></i></span>
                                          <select id="agent" class="form__control">
                                              <option value="">Sélectionnez un agent</option>
                                              <option value="Mr KONE">Mr KONE</option>
                                              <option value="Mme TRAORE">Mme TRAORE</option>
                                              <option value="Mr OUATTARA">Mr OUATTARA</option>
                                              <option value="Mr BONI">Mr BONI</option>
                                              <option value="Mr BECHO">Mr BECHO</option>
                                              <option value="Mme KOUAME">Mme KOUAME</option>
                                              <option value="Mr BRIZOUA">Mr BRIZOUA</option>
                                              <option value="Mme MESSOU">Mme MESSOU</option>
                                              <option value="Mr TIEMELE">Mr TIEMELE</option>
                                              <option value="Mr AMON">Mr AMON</option>
                                              <option value="Mr SISSOKO">Mr SISSOKO</option>
                                              <option value="Mme LATH">Mme LATH</option>
                                              <option value="SECRETARIAT">SECRETARIAT</option>
                                          </select>
                                      </div>
                                  </div>

                              </div>

                              <div class="form__actions">
                                  <button type="reset" class="btn btn--outline"><i class="ri-close-line"></i><span>Annuler</span></button>
                                  <button type="submit" class="btn btn--primary"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                              </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Imputation list section -->
                <section class="section" id="imputation-list-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Liste des imputations</h1>
                            <p class="section__subtitle">Gestion des imputations de courriers</p>
                        </div>
                        <div class="section__actions">
                            <div class="search-container"><i class="ri-search-line"></i><input type="text" placeholder="Rechercher..." id="imputation-search"></div>
                            <div class="filter-container">
                                <select id="imputation-filter" class="filter-select">
                                    <option value="all">Tous les types</option>
                                    <option value="ETATIQUE">ETATIQUE</option>
                                    <option value="PRIVE">PRIVE</option>
                                    <option value="CONTENTIEUX">CONTENTIEUX</option>
                                    <option value="MOBILISATION">MOBILISATION</option>
                                </select>
                            </div>
                            <button class="btn btn--outline" id="refresh-imputations"><i class="ri-refresh-line"></i><span>Actualiser</span></button>
                            <button class="btn btn--primary" id="print-imputations"><i class="ri-printer-line"></i><span>Imprimer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="data-table" id="imputations-table">
                                <thead>
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Date</th>
                                        <th>Objet</th>
                                        <th>Structure</th>
                                        <th>Type</th>
                                        <th>Agent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="imputations-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="imputations-pagination">Aucune donnée pour le moment.</div>
                    </div>
                </section>

                <!-- Arrival form section -->
                <section class="section" id="arrival-form-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Courrier arrivée</h1>
                            <p class="section__subtitle">Enregistrer un nouveau courrier arrivé</p>
                        </div>
                        <div class="section__actions">
                            <button type="button" class="btn btn--outline" id="reset-arrival-form"><i class="ri-refresh-line"></i><span>Réinitialiser</span></button>
                            <button type="button" class="btn btn--primary" id="submit-arrival-form"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <form class="form" id="arrival-form" novalidate>
                            <input type="hidden" id="arrival-edit-id" value="" />
                            <div class="card__content">
                              <div class="form__grid">
                                  <div class="form__group">
                                      <label class="form__label" for="arrival-number">Numéro d'arrivée</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-mail-download-line"></i></span>
                                          <input type="text" id="arrival-number" class="form__control" placeholder="ARR-2025-001">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="arrival-date-input">Date d'arrivée</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="arrival-date-input" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="cab-number">Numéro CAB</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-numbers-line"></i></span>
                                          <input type="text" id="cab-number" class="form__control" placeholder="Ex: CAB-001">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="cab-date">Date CAB</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="cab-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="dudu-number">Numéro DUDU</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-numbers-line"></i></span>
                                          <input type="text" id="dudu-number" class="form__control" placeholder="Ex: DUDU-001">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="dudu-date">Date DUDU</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="dudu-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="pce-number">Numéro PCE</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-numbers-line"></i></span>
                                          <input type="text" id="pce-number" class="form__control" placeholder="Ex: PCE-001">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="pce-date">Date PCE</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="pce-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="sender">Expéditeur</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-user-3-line"></i></span>
                                          <input type="text" id="sender" class="form__control" placeholder="Nom de l'expéditeur">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="arrival-object">Objet du courrier</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-chat-1-line"></i></span>
                                          <textarea id="arrival-object" class="form__control" rows="3" placeholder="Saisissez l'objet du courrier"></textarea>
                                      </div>
                                  </div>

                              </div>

                              <div class="form__actions">
                                  <button type="reset" class="btn btn--outline"><i class="ri-close-line"></i><span>Annuler</span></button>
                                  <button type="submit" class="btn btn--primary"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                              </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Arrival list section -->
                <section class="section" id="arrival-list-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Liste des courriers arrivés</h1>
                            <p class="section__subtitle">Gestion des courriers arrivés</p>
                        </div>
                        <div class="section__actions">
                            <div class="search-container"><i class="ri-search-line"></i><input type="text" placeholder="Rechercher..." id="arrival-search"></div>
                            <button class="btn btn--outline" id="refresh-arrivals"><i class="ri-refresh-line"></i><span>Actualiser</span></button>
                            <button class="btn btn--primary" id="print-arrivals"><i class="ri-printer-line"></i><span>Imprimer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="data-table" id="arrivals-table">
                                <thead>
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Date</th>
                                        <th>Expéditeur</th>
                                        <th>Objet</th>
                                        <th>N° CAB</th>
                                        <th>N° DUDU</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="arrivals-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="arrivals-pagination">Aucune donnée pour le moment.</div>
                    </div>
                </section>

                <!-- Convention form section -->
                <section class="section" id="convention-form-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Convention signée</h1>
                            <p class="section__subtitle">Enregistrer une nouvelle convention signée</p>
                        </div>
                        <div class="section__actions">
                            <button type="button" class="btn btn--outline" id="reset-convention-form"><i class="ri-refresh-line"></i><span>Réinitialiser</span></button>
                            <button type="button" class="btn btn--primary" id="submit-convention-form"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <form class="form" id="convention-form" novalidate>
                            <input type="hidden" id="convention-edit-id" value="" />
                            <div class="card__content">
                              <div class="form__grid">
                                  <div class="form__group">
                                      <label class="form__label" for="convention-number">Numéro de convention</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-file-text-line"></i></span>
                                          <input type="text" id="convention-number" class="form__control" placeholder="CONV-2025-001">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="designation">Désignation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-chat-1-line"></i></span>
                                          <input type="text" id="designation" class="form__control" placeholder="Titre de la convention">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="ville">Ville</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-building-line"></i></span>
                                          <input type="text" id="ville" class="form__control" placeholder="Ville concernée">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="village">Village</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-home-line"></i></span>
                                          <input type="text" id="village" class="form__control" placeholder="Village concerné">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="superficie">Superficie (ha)</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-ruler-line"></i></span>
                                          <input type="number" id="superficie" class="form__control" placeholder="Superficie en hectares">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="convention-type">Type</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-list-check"></i></span>
                                          <select id="convention-type" class="form__control">
                                              <option value="">Sélectionnez un type</option>
                                              <option value="ETATIQUE">ETATIQUE</option>
                                              <option value="PRIVE">PRIVE</option>
                                          </select>
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="projet">Projet</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-projector-line"></i></span>
                                          <textarea id="projet" class="form__control" rows="3" placeholder="Détails du projet"></textarea>
                                      </div>
                                  </div>

                              </div>

                              <div class="form__actions">
                                  <button type="reset" class="btn btn--outline"><i class="ri-close-line"></i><span>Annuler</span></button>
                                  <button type="submit" class="btn btn--primary"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                              </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Convention list section -->
                <section class="section" id="convention-list-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Liste des conventions</h1>
                            <p class="section__subtitle">Gestion des conventions signées</p>
                        </div>
                        <div class="section__actions">
                            <div class="search-container"><i class="ri-search-line"></i><input type="text" placeholder="Rechercher..." id="convention-search"></div>
                            <div class="filter-container">
                                <select id="convention-filter" class="filter-select">
                                    <option value="all">Tous les types</option>
                                    <option value="ETATIQUE">ETATIQUE</option>
                                    <option value="PRIVE">PRIVE</option>
                                </select>
                            </div>
                            <button class="btn btn--outline" id="refresh-conventions"><i class="ri-refresh-line"></i><span>Actualiser</span></button>
                            <button class="btn btn--primary" id="print-conventions"><i class="ri-printer-line"></i><span>Imprimer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="data-table" id="conventions-table">
                                <thead>
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Désignation</th>
                                        <th>Ville</th>
                                        <th>Village</th>
                                        <th>Superficie</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="conventions-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="conventions-pagination">Aucune donnée pour le moment.</div>
                    </div>
                </section>

                <!-- Commission form section -->
                <section class="section" id="commission-form-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Commission administrative</h1>
                            <p class="section__subtitle">Enregistrer une nouvelle commission administrative</p>
                        </div>
                        <div class="section__actions">
                            <button type="button" class="btn btn--outline" id="reset-commission-form"><i class="ri-refresh-line"></i><span>Réinitialiser</span></button>
                            <button type="button" class="btn btn--primary" id="submit-commission-form"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <form class="form" id="commission-form" novalidate>
                            <input type="hidden" id="commission-edit-id" value="" />
                            <div class="card__content">
                              <div class="form__grid">
                                  <div class="form__group">
                                      <label class="form__label" for="commission-number">Numéro de commission</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-government-line"></i></span>
                                          <input type="text" id="commission-number" class="form__control" placeholder="COMM-2025-001">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="commission-designation">Désignation</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-chat-1-line"></i></span>
                                          <input type="text" id="commission-designation" class="form__control" placeholder="Titre de la commission">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="commission-locality">Localité</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-map-pin-line"></i></span>
                                          <input type="text" id="commission-locality" class="form__control" placeholder="Localité concernée">
                                      </div>
                                  </div>

                                  <div class="form__group">
                                      <label class="form__label" for="commission-date">Date de la commission</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-calendar-line"></i></span>
                                          <input type="date" id="commission-date" class="form__control">
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="commission-description">Description</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-file-text-line"></i></span>
                                          <textarea id="commission-description" class="form__control" rows="3" placeholder="Description de la commission"></textarea>
                                      </div>
                                  </div>

                                  <div class="form__group form__group--full">
                                      <label class="form__label" for="members">Membres</label>
                                      <div class="form__input-group"><span class="input-icon"><i class="ri-team-line"></i></span>
                                          <textarea id="members" class="form__control" rows="3" placeholder="Liste des membres de la commission"></textarea>
                                      </div>
                                  </div>

                              </div>

                              <div class="form__actions">
                                  <button type="reset" class="btn btn--outline"><i class="ri-close-line"></i><span>Annuler</span></button>
                                  <button type="submit" class="btn btn--primary"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                              </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Commission list section -->
                <section class="section" id="commission-list-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Liste des commissions</h1>
                            <p class="section__subtitle">Gestion des commissions administratives</p>
                        </div>
                        <div class="section__actions">
                            <div class="search-container"><i class="ri-search-line"></i><input type="text" placeholder="Rechercher..." id="commission-search"></div>
                            <button class="btn btn--outline" id="refresh-commissions"><i class="ri-refresh-line"></i><span>Actualiser</span></button>
                            <button class="btn btn--primary" id="print-commissions"><i class="ri-printer-line"></i><span>Imprimer</span></button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="data-table" id="commissions-table">
                                <thead>
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Désignation</th>
                                        <th>Localité</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="commissions-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="commissions-pagination">Aucune donnée pour le moment.</div>
                    </div>
                </section>

                <!-- Settings section -->
                <section class="section" id="settings-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Paramètres</h1>
                            <p class="section__subtitle">Configuration du système</p>
                        </div>
                    </div>

                    <div class="dashboard-grid" style="grid-template-columns: repeat(12,1fr)">
                        <div class="card" style="grid-column: span 6;">
                            <div class="card__header">
                                <h2 class="card__title"><i class="ri-settings-3-line"></i><span>Paramètres généraux</span></h2>
                            </div>
                            <div class="card__content">
                                <div class="settings-group" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 10px; border:1px solid var(--stroke); border-radius: 14px; background: rgba(255,255,255,.06);">
                                  <div>
                                    <div class="settings-label" style="font-weight:900; font-size: 13px;">Interface</div>
                                    <div style="color: var(--muted2); font-size: 12px;">Mode sombre / clair</div>
                                  </div>
                                  <div class="theme-switch" id="dark-mode-toggle"><div class="switch-track"></div><div class="switch-thumb"></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="grid-column: span 6;">
                            <div class="card__header">
                                <h2 class="card__title"><i class="ri-database-2-line"></i><span>Données</span></h2>
                            </div>
                            <div class="card__content" style="display:flex; flex-direction:column; gap:10px;">
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button class="btn btn--outline" id="export-data"><i class="ri-download-line"></i><span>Exporter les données</span></button>
                                    <button class="btn btn--outline" id="import-data"><i class="ri-upload-line"></i><span>Importer des données</span></button>
                                    <input type="file" id="import-file" accept="application/json" class="is-hidden" />
                                </div>
                                <button class="btn btn--danger" id="reset-data"><i class="ri-delete-bin-line"></i><span>Effacer toutes les données</span></button>
                                <p style="color: var(--muted2); font-size: 12px; margin: 0;">Les données sont stockées dans Firebase (Firestore) si configuré, sinon uniquement en mémoire (aucun stockage local).</p>
                            </div>
                        </div>

                        <div class="card" id="firebase-deploy-card" style="grid-column: span 12; display:none;">
                          <div class="card__header">
                            <h2 class="card__title"><i class="ri-cloud-line"></i><span>Préparation déploiement Firebase</span></h2>
                            <button class="btn btn--sm btn--outline" id="deploy-check-refresh" type="button"><i class="ri-refresh-line"></i><span>Vérifier</span></button>
                          </div>
                          <div class="card__content">
                            <div class="deploy-grid" aria-label="Checklist de déploiement">
                              <div class="deploy-item">
                                <div class="deploy-left">
                                  <div class="deploy-label">Configuration Firebase</div>
                                  <div class="deploy-hint">Renseignez FIREBASE_CONFIG dans le script</div>
                                </div>
                                <span class="deploy-status" id="deploy-firebase-config">—</span>
                              </div>

                              <div class="deploy-item">
                                <div class="deploy-left">
                                  <div class="deploy-label">Connexion Firestore</div>
                                  <div class="deploy-hint">Chargement/écriture des données</div>
                                </div>
                                <span class="deploy-status" id="deploy-firestore">—</span>
                              </div>

                              <div class="deploy-item">
                                <div class="deploy-left">
                                  <div class="deploy-label">Mode de stockage</div>
                                  <div class="deploy-hint">Aucun localStorage (OK pour Firebase Hosting)</div>
                                </div>
                                <span class="deploy-status" id="deploy-storage">—</span>
                              </div>

                              <div class="deploy-item">
                                <div class="deploy-left">
                                  <div class="deploy-label">Sécurité</div>
                                  <div class="deploy-hint">Le mot de passe admin côté client est une démo</div>
                                </div>
                                <span class="deploy-status" id="deploy-security">—</span>
                              </div>

                              <div class="deploy-item">
                                <div class="deploy-left">
                                  <div class="deploy-label">Scalabilité Firestore</div>
                                  <div class="deploy-hint">Actuellement: un document unique (limite ~1 MiB)</div>
                                </div>
                                <span class="deploy-status" id="deploy-scale">—</span>
                              </div>
                            </div>

                            <div style="margin-top:12px; color:var(--muted2); font-size:12px; font-weight:900; line-height:1.45;">
                              Conseil production: utilisez <b style="color:var(--text)">Firebase Auth</b> + des règles Firestore, et stockez les enregistrements dans des <b style="color:var(--text)">collections</b> (imputations/arrivals/conventions/commissions) plutôt qu’un document unique.
                              <br><br>
                              <span style="color:var(--muted2)">Si les données disparaissent après rechargement :</span>
                              <b style="color:var(--text)">Firestore n’est pas accessible en écriture</b> (service non activé ou règles). Vérifiez l’onglet <b style="color:var(--text)">Firestore Database</b> dans Firebase Console et autorisez les écritures (au moins temporairement pour test).
                            </div>
                          </div>
                        </div>
                    </div>
                </section>

                <!-- Profile section -->
                <section class="section" id="profile-section">
                    <div class="section__header">
                        <div class="section__title-area">
                            <h1 class="section__title">Profil</h1>
                            <p class="section__subtitle">Gestion du profil utilisateur</p>
                        </div>
                        <div class="section__actions">
                            <button type="button" class="btn btn--primary" id="save-profile"><i class="ri-save-line"></i><span>Enregistrer</span></button>
                        </div>
                    </div>

                    <div class="dashboard-grid" style="grid-template-columns: repeat(12,1fr)">
                        <div class="card" style="grid-column: span 7;">
                            <div class="card__header"><h2 class="card__title"><i class="ri-user-4-line"></i><span>Informations personnelles</span></h2></div>
                            <div class="card__content">
                                <div class="profile-image-container" style="display:flex; align-items:center; gap:12px; margin-bottom: 12px; flex-wrap:wrap;">
                                    <div class="profile-image"><img src="https://images.unsplash.com/photo-1565464027194-7957a2295fb7?w=400&auto=format&fit=crop&q=60" alt="Profile" id="profile-img" style="width: 72px; height: 72px; border-radius: 18px; object-fit: cover; border: 1px solid var(--stroke);"></div>
                                    <div class="profile-image-actions" style="display:flex; gap:10px;">
                                        <button type="button" class="btn btn--sm btn--outline" id="profile-change-photo"><i class="ri-camera-line"></i><span>Changer</span></button>
                                        <button type="button" class="btn btn--sm btn--outline" id="profile-delete-photo"><i class="ri-delete-bin-line"></i><span>Supprimer</span></button>
                                        <input type="file" id="profile-photo-input" accept="image/*" class="is-hidden" />
                                    </div>
                                </div>

                                <form class="form" id="profile-form">
                                    <div class="form__grid">
                                        <div class="form__group">
                                            <label class="form__label" for="profile-name">Nom complet</label>
                                            <div class="form__input-group"><span class="input-icon"><i class="ri-user-line"></i></span>
                                                <input type="text" id="profile-name" class="form__control" value="Administrateur SDMFPIPPDC">
                                            </div>
                                        </div>

                                        <div class="form__group">
                                            <label class="form__label" for="profile-email">Email</label>
                                            <div class="form__input-group"><span class="input-icon"><i class="ri-mail-line"></i></span>
                                                <input type="email" id="profile-email" class="form__control" value="admin@sdmfpippdc.gov">
                                            </div>
                                        </div>

                                        <div class="form__group">
                                            <label class="form__label" for="profile-phone">Téléphone</label>
                                            <div class="form__input-group"><span class="input-icon"><i class="ri-phone-line"></i></span>
                                                <input type="tel" id="profile-phone" class="form__control" placeholder="Votre numéro de téléphone">
                                            </div>
                                        </div>

                                        <div class="form__group">
                                            <label class="form__label" for="profile-role">Rôle</label>
                                            <div class="form__input-group"><span class="input-icon"><i class="ri-shield-user-line"></i></span>
                                                <input type="text" id="profile-role" class="form__control" value="Administrateur" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card" style="grid-column: span 5;">
                            <div class="card__header"><h2 class="card__title"><i class="ri-lock-line"></i><span>Sécurité</span></h2></div>
                            <div class="card__content">
                                <form class="form" id="security-form">
                                    <div class="form__group form__group--full">
                                        <label class="form__label" for="current-password">Mot de passe actuel</label>
                                        <div class="form__input-group"><span class="input-icon"><i class="ri-lock-password-line"></i></span>
                                            <input type="password" id="current-password" class="form__control" placeholder="Votre mot de passe actuel">
                                        </div>
                                    </div>

                                    <div class="form__group form__group--full">
                                        <label class="form__label" for="new-password">Nouveau mot de passe</label>
                                        <div class="form__input-group"><span class="input-icon"><i class="ri-lock-password-line"></i></span>
                                            <input type="password" id="new-password" class="form__control" placeholder="Nouveau mot de passe">
                                        </div>
                                    </div>

                                    <div class="form__group form__group--full">
                                        <label class="form__label" for="confirm-password">Confirmer le mot de passe</label>
                                        <div class="form__input-group"><span class="input-icon"><i class="ri-checkbox-circle-line"></i></span>
                                            <input type="password" id="confirm-password" class="form__control" placeholder="Confirmez le nouveau mot de passe">
                                        </div>
                                    </div>

                                    <div class="form__actions">
                                        <button type="submit" class="btn btn--primary"><i class="ri-save-line"></i><span>Mettre à jour le mot de passe</span></button>
                                    </div>
                                </form>
                                <p style="color: var(--muted2); font-size: 12px; margin: 10px 2px 0;">(Démo) Le mot de passe admin est conservé en mémoire du navigateur.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- DETAIL MODAL -->
    <div class="detail-modal-backdrop" id="detail-modal-backdrop" aria-hidden="true">
        <div class="detail-modal" id="detail-modal" role="dialog" aria-modal="true">
            <div class="detail-modal__header">
                <h3 class="detail-modal__title" id="detail-modal-title">Détails</h3>
                <button class="detail-modal__close" id="detail-modal-close" aria-label="Fermer"><i class="ri-close-line"></i></button>
            </div>
            <div class="detail-modal__content" id="detail-modal-content"></div>
            <div class="detail-modal__footer">
                <button class="btn btn--outline btn--sm" id="detail-modal-edit"><i class="ri-edit-line"></i><span>Modifier</span></button>
                <button class="btn btn--primary btn--sm" id="detail-modal-close-footer"><i class="ri-check-line"></i><span>Fermer</span></button>
            </div>
        </div>
    </div>

    <!-- CONFIRM DELETE MODAL -->
    <div class="confirm-modal-backdrop" id="confirm-modal-backdrop" aria-hidden="true">
        <div class="confirm-modal" id="confirm-modal" role="dialog" aria-modal="true">
            <div class="confirm-modal__icon"><i class="ri-delete-bin-5-line"></i></div>
            <div class="confirm-modal__body">
                <h3 class="confirm-modal__title" id="confirm-modal-title">Confirmer la suppression</h3>
                <p class="confirm-modal__message" id="confirm-modal-message">Cette action est irréversible.</p>
                <div class="confirm-modal__actions">
                    <button class="btn btn--outline btn--sm" id="confirm-cancel-btn"><i class="ri-close-line"></i><span>Annuler</span></button>
                    <button class="btn btn--danger btn--sm" id="confirm-validate-btn"><i class="ri-check-line"></i><span>Supprimer</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div class="toast-notification" id="toast-notification" aria-live="polite">
        <div class="toast__icon"><i class="ri-checkbox-circle-fill" id="toast-icon"></i></div>
        <div class="toast__content">
            <h4 class="toast__title" id="toast-title">Succès</h4>
            <p class="toast__message" id="toast-message">L'opération a été effectuée avec succès</p>
        </div>
        <button class="toast__close" id="toast-close" aria-label="Fermer"><i class="ri-close-line"></i></button>
        <div class="toast__bar" aria-hidden="true"><div class="toast__bar-fill"></div></div>
    </div>

    <!-- ACTIVITY NOTIFICATION -->
    <div class="activity-feed" id="activity-feed">
        <div class="activity-feed__header">
            <h3 style="font-weight:900">Activités récentes</h3>
            <button class="activity-feed__close" id="activity-feed-close" aria-label="Fermer"><i class="ri-close-line"></i></button>
        </div>
        <div class="activity-feed__content" id="activity-feed-content"></div>
        <div class="activity-feed__footer">
            <button class="btn btn--link" id="clear-activities">Effacer toutes les activités</button>
        </div>
    </div>

    <button class="activity-feed__trigger" id="activity-feed-trigger" aria-label="Activités">
        <i class="ri-history-line"></i>
        <span class="activity-count" id="activity-count">0</span>
    </button>

    <!-- Vercel KV / Upstash status pill (floating) -->
    <div class="firebase-pill off" id="firebase-pill" role="button" tabindex="0" aria-label="Statut du stockage">
      <span class="firebase-pill__dot" aria-hidden="true"></span>
      <i class="ri-database-2-line" aria-hidden="true"></i>
      <span id="firebase-pill-text">Stockage: non configuré</span>
    </div>


  <script>
    // --- SDMFPIPPDC Dashboard ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const STORAGE = {
      theme: 'sdmfpippdc_theme',
      auth: 'sdmfpippdc_auth',
      adminPw: 'sdmfpippdc_admin_pw',
      profile: 'sdmfpippdc_profile',
      imputations: 'sdmfpippdc_imputations',
      arrivals: 'sdmfpippdc_arrivals',
      conventions: 'sdmfpippdc_conventions',
      commissions: 'sdmfpippdc_commissions',
      activities: 'sdmfpippdc_activities',
      seeded: 'sdmfpippdc_seeded'
    };

    const AGENTS = [
      'Mr KONE',
      'Mme TRAORE',
      'Mr OUATTARA',
      'Mr BONI',
      'Mr BECHO',
      'Mme KOUAME',
      'Mr BRIZOUA',
      'Mme MESSOU',
      'Mr TIEMELE',
      'Mr AMON',
      'Mr SISSOKO',
      'Mme LATH',
      'SECRETARIAT'
    ];

    // Production: données d'exemple désactivées.
    // Laissez à false pour déployer en production avec vos propres données.
    const ENABLE_DEMO_SEED = false;

    // IMPORTANT (Production): ne pas afficher de données d'exemple.
    // Quand ENABLE_DEMO_SEED=false, on ne seed rien et on ne garde pas de flag "seeded".
    // Vos données viendront de Firebase Firestore (si configuré) ou resteront en mémoire pendant la session.

    // Sections de saisie (à cacher en mode Invité)
    const FORM_SECTIONS = ['imputation-form','arrival-form','convention-form','commission-form'];
    const FORM_TO_LIST = {
      'imputation-form': 'imputation-list',
      'arrival-form': 'arrival-list',
      'convention-form': 'convention-list',
      'commission-form': 'commission-list'
    };

    const state = {
      user: { role: 'Invité', email: 'invite@sdmfpippdc.gov', name: 'Invité', isAdmin: false },
      data: {
        imputations: [],
        arrivals: [],
        conventions: [],
        commissions: []
      },
      ui: {
        conventionTab: 'all',
        // Période du tableau de bord (utilisée par le graphe "Résumé des activités")
        dashRangeDays: 30,
        charts: {}
      },
      confirmAction: null
    };

    // Avoid accumulating window listeners when custom selects are rebuilt (theme switch, etc.)
    let __selectResizeHandler = null;

    const fmtDate = (iso) => {
      if (!iso) return '-';
      try {
        const d = new Date(iso);
        return d.toLocaleDateString('fr-FR');
      } catch (e) { return iso; }
    };

    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    // --- Storage (sans localStorage) : mémoire + Vercel KV (optionnel) ---
    // IMPORTANT: Aucune donnée n'est stockée dans localStorage.
    // Si vous déployez sur Vercel et voulez une persistance partagée entre appareils,
    // configurez Vercel KV (ou Upstash) et l’API serverless /api/storage.

    const REMOTE_API = '/api/storage';

    const __memStore = Object.create(null);
    // Remote status (Vercel KV)
    let __db = null; // unused (compat)
    let __dbReady = false;      // true when /api/storage is reachable and writable
    let __dbConn = false;       // true when remote API is configured/reachable
    let __dbWritable = false;   // same as __dbReady
    let __flushTimer = null;
    let __remoteOk = false;
    let __remoteLastError = null;
    let __authError = null;     // unused (compat)
    let __dirty = false;

    // Par sécurité, on ne persiste PAS l'état de connexion (auth) ni le mot de passe admin.
    // Seules les données métier + préférences visuelles sont persistées.
    const PERSIST_KEYS = new Set([
      STORAGE.theme,
      STORAGE.profile,
      STORAGE.imputations,
      STORAGE.arrivals,
      STORAGE.conventions,
      STORAGE.commissions,
      STORAGE.activities,
      STORAGE.seeded
    ]);

    function initRemoteStore(){
      // Remote store (Vercel KV via /api/storage)
      try{
        __db = null;
        __dbConn = false;
        __dbWritable = false;
        __dbReady = false;
        __remoteOk = false;
        __remoteLastError = null;

        // Test API availability (and whether KV is configured)
        return remoteLoad()
          .then((loaded) => {
            // Even if no data yet, API may be reachable
            return remoteSelfTest().then((ok) => {
              __dbConn = !!ok;
              __dbWritable = !!ok;
              __dbReady = !!ok;
              try{ updateRemotePill(); }catch(e){}
              return loaded || ok;
            });
          })
          .catch((e) => {
            __dbConn = false;
            __dbWritable = false;
            __dbReady = false;
            __remoteOk = false;
            __remoteLastError = e;
            try{ updateRemotePill(); }catch(_e){}
            try{ console.warn('[SDMFPIPPDC] Remote init failed:', e); }catch(_e){}
            return false;
          });
      }catch(e){
        __dbConn = false;
        __dbWritable = false;
        __dbReady = false;
        __remoteOk = false;
        __remoteLastError = e;
        try{ updateRemotePill(); }catch(_e){}
        return Promise.resolve(false);
      }
    }

    // Timeout helper (évite que l'app reste bloquée si Firestore ne répond pas)
    // Important: on encapsule la promesse dans un catch pour éviter les "unhandledrejection"
    // si le timeout gagne la course et que la promesse d'origine rejette plus tard.
    function withTimeout(promise, ms){
      // Retourne la valeur si la promesse résout.
      // Si la promesse prend trop de temps, on rejette avec { code:'timeout' }.
      // Important: on "guard" la promesse d'origine pour éviter les unhandledrejection
      // si le timeout gagne et que la promesse rejette plus tard.
      ms = Number(ms || 5000);

      const guarded = Promise.resolve(promise)
        .then((v) => ({ ok: true, v }))
        .catch((e) => ({ ok: false, e }));

      const timer = new Promise((resolve) => {
        setTimeout(() => {
          const err = new Error('timeout');
          err.code = 'timeout';
          resolve({ ok: false, e: err, timeout: true });
        }, ms);
      });

      return Promise.race([guarded, timer]).then((res) => {
        if (!res) return false;
        if (res.ok === false) throw (res.e || new Error('timeout'));
        return res.v;
      });
    }

    function remoteLoad(){
      // Load persisted kv from /api/storage
      return withTimeout(fetch(REMOTE_API, {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        cache: 'no-store'
      }), 8000)
        .then((r) => {
          const ct = (r && r.headers && r.headers.get) ? String(r.headers.get('content-type') || '') : '';
          if (ct.indexOf('application/json') === -1){
            return r.text()
              .then((txt) => {
                __remoteLastError = {
                  code: 'api_not_json',
                  status: r.status,
                  message: 'Réponse non-JSON depuis /api/storage (rewrite Vercel ou fonction absente).',
                  sample: String(txt || '').slice(0, 180)
                };
                return null;
              })
              .catch(() => {
                __remoteLastError = {
                  code: 'api_not_json',
                  status: r.status,
                  message: 'Réponse non-JSON depuis /api/storage (rewrite Vercel ou fonction absente).'
                };
                return null;
              });
          }
          return r.json().catch(() => null);
        })
        .then((payload) => {
          if (!payload || payload.ok !== true){
            __remoteOk = false;
            __remoteLastError = payload || __remoteLastError || { code: 'remote_unavailable' };
            return false;
          }
          const kv = (payload.kv && typeof payload.kv === 'object') ? payload.kv : {};
          for (const k of Object.keys(kv)){
            if (!PERSIST_KEYS.has(k)) continue;
            __memStore[k] = String(kv[k]);
          }
          __remoteOk = true;
          __remoteLastError = null;
          return true;
        })
        .catch((e) => {
          __remoteOk = false;
          __remoteLastError = e;
          try{ console.warn('[SDMFPIPPDC] Remote load failed:', e); }catch(_e){}
          return false;
        });
    }

    function remoteSelfTest(){
      // Ping remote storage (checks Postgres configured)
      return withTimeout(fetch(REMOTE_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        cache: 'no-store',
        body: JSON.stringify({ ping: true })
      }), 8000)
        .then((r) => {
          const ct = (r && r.headers && r.headers.get) ? String(r.headers.get('content-type') || '') : '';
          if (ct.indexOf('application/json') === -1){
            return r.text()
              .then((txt) => ({
                ok: false,
                error: 'api_not_json',
                status: r.status,
                message: 'Réponse non-JSON depuis /api/storage (rewrite Vercel ou fonction absente).',
                sample: String(txt || '').slice(0, 180)
              }))
              .catch(() => ({ ok:false, error:'api_not_json', status:r.status, message:'Réponse non-JSON depuis /api/storage.' }));
          }
          return r.json().catch(() => ({ ok:false, error:'json_parse_failed', status:r.status }));
        })
        .then((payload) => {
          const ok = !!(payload && payload.ok);
          __remoteOk = ok;
          __remoteLastError = ok ? null : (payload || { code: 'remote_ping_failed' });
          return ok;
        })
        .catch((e) => {
          __remoteOk = false;
          __remoteLastError = e;
          try{ console.warn('[SDMFPIPPDC] Remote ping failed:', e); }catch(_e){}
          return false;
        });
    }

    function scheduleRemoteFlush(){
      // Toujours tenter d’écrire si Firebase est configuré.
      // (si règles refusent, remoteFlush mettra __dbWritable=false et affichera une erreur claire)
      if (!__dbConn) return;
      clearTimeout(__flushTimer);
      // plus court pour éviter la perte si l’utilisateur recharge vite
      __flushTimer = setTimeout(() => { try{ remoteFlush(true); }catch(e){} }, 120);
    }

    function updateRemotePill(){
      const pill = $('#firebase-pill');
      const textEl = $('#firebase-pill-text');
      if (!pill || !textEl) return;

      pill.classList.remove('ok','warn','off');

      // __dbReady: stockage disponible + écriture OK
      if (__dbReady){
        pill.classList.add('ok');
        textEl.textContent = 'Stockage: actif';
        return;
      }

      // __dbConn: API joignable mais pas forcément writable
      if (__dbConn){
        pill.classList.add('warn');
        const msg = (__remoteLastError && (__remoteLastError.error || __remoteLastError.code || __remoteLastError.message))
          ? String(__remoteLastError.error || __remoteLastError.code || __remoteLastError.message)
          : 'écriture refusée';
        textEl.textContent = 'Stockage: ' + msg;
        return;
      }

      // Offline / not configured
      pill.classList.add('off');
      const msg = (__remoteLastError && (__remoteLastError.error || __remoteLastError.code || __remoteLastError.message))
        ? String(__remoteLastError.error || __remoteLastError.code || __remoteLastError.message)
        : 'non configuré';
      textEl.textContent = 'Stockage: ' + msg;

      // Helpful hint in console for Vercel Postgres debugging
      try{
        if (String(msg).indexOf('pg_not_configured') >= 0){
          console.warn('[SDMFPIPPDC] Postgres not configured. Try: /api/storage?diag=1 on your deployed site.');
        }
      }catch(e){}
    }

    function remoteFlush(silent){
      // silent=true -> ne pas toaster
      silent = (silent === undefined) ? true : !!silent;
      if (!__dbConn) return Promise.resolve(false);

      const kv = {};
      for (const k of Object.keys(__memStore)){
        if (!PERSIST_KEYS.has(k)) continue;
        kv[k] = __memStore[k];
      }

      return withTimeout(fetch(REMOTE_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        cache: 'no-store',
        body: JSON.stringify({ kv })
      }), 15000)
        .then((r) => {
          const ct = (r && r.headers && r.headers.get) ? String(r.headers.get('content-type') || '') : '';
          if (ct.indexOf('application/json') === -1){
            return r.text()
              .then((txt) => ({ ok:false, error:'api_not_json', status:r.status, message:'Réponse non-JSON depuis /api/storage.', sample:String(txt || '').slice(0,180) }))
              .catch(() => ({ ok:false, error:'api_not_json', status:r.status, message:'Réponse non-JSON depuis /api/storage.' }));
          }
          return r.json().catch(() => ({ ok:false, error:'json_parse_failed', status:r.status }));
        })
        .then((payload) => {
          const ok = !!(payload && payload.ok);
          if (!ok) throw (payload || new Error('remote_write_failed'));
          __remoteOk = true;
          __remoteLastError = null;
          __dbWritable = true;
          __dbReady = true;
          __dirty = false;
          try{ updateRemotePill(); }catch(e){}
          return true;
        })
        .catch((e) => {
          __remoteOk = false;
          __remoteLastError = e;
          __dbWritable = false;
          __dbReady = false;
          try{ updateRemotePill(); }catch(_e){}
          try{ console.warn('[SDMFPIPPDC] Remote save failed:', e); }catch(_e){}
          if (!silent){
            try{
              const msg = (e && (e.error || e.code || e.message)) ? String(e.error || e.code || e.message) : 'Écriture refusée';
              toast('error', 'Stockage Vercel', 'Échec de synchronisation: ' + msg);
            }catch(_e){}
          }
          return false;
        });
    }

    // Sécurité: tenter un flush quand l’onglet se ferme / passe en arrière-plan
    window.addEventListener('pagehide', () => {
      try{
        // Même si __dbWritable est false, on tente un dernier flush si on a des changements.
        if (__dbConn && __dirty) remoteFlush(true);
      }catch(e){}
    });
    document.addEventListener('visibilitychange', () => {
      try{
        if (document.visibilityState === 'hidden' && __dbConn && __dirty) remoteFlush(true);
      }catch(e){}
    });

    function lsGet(key){
      return Object.prototype.hasOwnProperty.call(__memStore, key) ? __memStore[key] : null;
    }
    function lsSet(key, value){
      __memStore[key] = String(value);
      if (PERSIST_KEYS.has(key)){
        __dirty = true;
        scheduleRemoteFlush();
      }
    }
    function lsRemove(key){
      delete __memStore[key];
      if (PERSIST_KEYS.has(key)) scheduleRemoteFlush();
    }

    function uuid(){
      // éviter ReferenceError si `crypto` n'existe pas dans l'environnement
      const c = (typeof crypto !== 'undefined' ? crypto : (typeof window !== 'undefined' ? window.crypto : null));
      if (c && typeof c.randomUUID === 'function') return c.randomUUID();
      return 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now();
    }

    function nowIso(){
      return new Date().toISOString();
    }

    // Normalise any date-like value to YYYY-MM-DD in local time.
    // Works for: 'YYYY-MM-DD', ISO with time, Date, timestamps.
    function dateKey(v){
      if (!v) return '';
      // If already YYYY-MM-DD
      const s = String(v);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(v);
      if (!Number.isFinite(d.getTime())) return s.slice(0,10);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function loadJSON(key, fallback){
      try{
        const raw = lsGet(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, value){
      try{ lsSet(key, JSON.stringify(value)); }
      catch(e){}
    }

    function toast(type, title, message, opts){
      const el = $('#toast-notification');
      const icon = $('#toast-icon');
      const t = $('#toast-title');
      const m = $('#toast-message');

      const options = (opts && typeof opts === 'object') ? opts : {};
      const variant = options.variant || options.action || null;

      t.textContent = title;
      m.textContent = message;

      // Reset previous variant classes
      ['toast--save','toast--delete','toast--update','toast--success','toast--error','toast--info','toast--warn']
        .forEach(c => el.classList.remove(c));

      // Default icon set by type unless an action variant is specified
      const typeMap = {
        success: { cls: 'ri-checkbox-circle-fill', vcls: 'toast--success' },
        error: { cls: 'ri-close-circle-fill', vcls: 'toast--error' },
        info: { cls: 'ri-information-fill', vcls: 'toast--info' },
        warn: { cls: 'ri-error-warning-fill', vcls: 'toast--warn' }
      };

      if (variant === 'save'){
        el.classList.add('toast--save');
        icon.className = 'ri-thumb-up-fill';
      } else if (variant === 'delete'){
        el.classList.add('toast--delete');
        icon.className = 'ri-delete-bin-6-fill';
      } else if (variant === 'update'){
        el.classList.add('toast--update');
        icon.className = 'ri-edit-2-fill';
      } else {
        const meta = typeMap[type] || typeMap.info;
        el.classList.add(meta.vcls);
        icon.className = meta.cls;
      }

      // Restart animation if already visible
      el.classList.remove('show');
      // Force reflow to restart CSS animations (bar + icon)
      void el.offsetWidth;
      el.classList.add('show');

      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.remove('show'), 3800);
    }

    function toastAction(action, title, message){
      // Notifications premium (icônes animées)
      // save  -> pouce (animé)
      // update-> crayon (animé)
      // delete-> poubelle (animé)
      if (action === 'save') return toast('success', title || 'Enregistré', message || 'Enregistré avec succès.', { variant:'save' });
      if (action === 'update') return toast('success', title || 'Modifié', message || 'Modification effectuée avec succès.', { variant:'update' });
      if (action === 'delete') return toast('success', title || 'Supprimé', message || 'Suppression effectuée avec succès.', { variant:'delete' });
      return toast('info', title || 'Info', message || '', {});
    }

    function addActivity(title, message){
      const activities = loadJSON(STORAGE.activities, []);
      activities.unshift({ id: uuid(), at: nowIso(), title, message, unread: true });
      const trimmed = activities.slice(0, 60);
      saveJSON(STORAGE.activities, trimmed);
      renderActivities();
    }

    function getActivities(){
      const raw = loadJSON(STORAGE.activities, []);
      const list = Array.isArray(raw) ? raw : [];
      // Default unread=true when missing (so the badge counts new/seeded activities)
      return list.map(a => ({ ...a, unread: (a.unread === undefined ? true : !!a.unread) }));
    }

    function saveActivities(list){
      saveJSON(STORAGE.activities, list);
    }

    function renderActivities(){
      const list = getActivities();
      const ctn = $('#activity-feed-content');
      const count = $('#activity-count');
      const unreadCount = list.filter(a => a.unread).length;

      if (count){
        count.textContent = String(unreadCount);
        count.style.display = unreadCount > 0 ? 'flex' : 'none';
      }

      if (!ctn) return;
      ctn.innerHTML = '';
      if (!list.length){
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.innerHTML = `<h4>Aucune activité</h4><p>Les actions importantes s’afficheront ici.</p>`;
        ctn.appendChild(div);
        return;
      }
      for (const a of list){
        const div = document.createElement('div');
        div.className = 'activity-item' + (a.unread ? ' unread' : '');
        div.setAttribute('data-id', a.id);
        div.setAttribute('role', 'button');
        div.setAttribute('tabindex', '0');
        div.innerHTML = `<h4>${escapeHtml(a.title)}</h4><p>${escapeHtml(a.message)} • <span style="color:var(--muted2)">${fmtDate(a.at)}</span></p>`;
        ctn.appendChild(div);
      }
    }

    function markAllActivitiesRead(silent=true){
      const list = getActivities().map(a => ({ ...a, unread: false }));
      saveActivities(list);
      renderActivities();
      if (!silent) toast('success', 'Activités', 'Tout est marqué comme lu.');
    }

    function markActivityRead(id){
      const list = getActivities();
      const a = list.find(x => x.id === id);
      if (!a) return;
      if (a.unread){
        a.unread = false;
        saveActivities(list);
        renderActivities();
      }
    }

    function buildActivityDetailHtml(a){
      let atLabel = '—';
      try{ if (a.at) atLabel = new Date(a.at).toLocaleString('fr-FR'); }catch(e){}
      return `
        <div class="detail-hero">
          <div style="min-width:0;">
            <div class="detail-hero__kicker">Activité</div>
            <div class="detail-hero__title">${escapeHtml(a.title || 'Activité')}</div>
            <div class="detail-hero__sub">${escapeHtml(a.message || '')}</div>
          </div>
          <div class="detail-hero__chips">
            <span class="detail-chip imp"><i class="ri-history-line"></i><b>JOURNAL</b></span>
            <span class="detail-chip imp"><i class="ri-time-line"></i><b>${escapeHtml(atLabel)}</b></span>
          </div>
        </div>
        <div class="detail-grid">
          <div class="detail-item detail-item--full">
            <div class="detail-label">Message</div>
            <div class="detail-value">${escapeHtml(a.message || '—')}</div>
          </div>
        </div>
      `;
    }

    function openActivityDetail(id){
      const list = getActivities();
      const a = list.find(x => x.id === id);
      if (!a) return;

      if (a.unread){
        a.unread = false;
        saveActivities(list);
        renderActivities();
      }

      const feed = $('#activity-feed');
      if (feed) feed.classList.remove('open');

      $('#detail-modal-title').textContent = 'Détails — Activité';
      $('#detail-modal-content').innerHTML = buildActivityDetailHtml(a);

      // Hide edit button for activities
      const editBtn = $('#detail-modal-edit');
      if (editBtn) editBtn.classList.add('is-hidden');

      $('#detail-modal-backdrop').classList.add('open');
      $('#detail-modal-backdrop').setAttribute('aria-hidden', 'false');
    }

    // --- Notifications (UI only, in-memory) ---
    // Object shape: { id, type, title, message, atLabel, unread }
    state.ui.notifications = [];

    function initNotifications(){
      // If already initialized, keep state (e.g., theme rebuild)
      if (Array.isArray(state.ui.notifications) && state.ui.notifications.length) {
        updateNotificationsBadge();
        return;
      }

      const listEl = $('#notifications-list');
      const parsed = [];
      if (listEl){
        const items = Array.from(listEl.querySelectorAll('.notification__item'));
        if (items.length){
          items.forEach((el) => {
            const pEl = el.querySelector('.notification__content p');
            const sEl = el.querySelector('.notification__content span');
            const title = ((pEl && pEl.textContent) ? pEl.textContent : '').trim();
            const atLabel = ((sEl && sEl.textContent) ? sEl.textContent : '').trim();
            const unread = el.classList.contains('unread');
            const icon = el.querySelector('.notification__icon');
            const type = (icon && icon.classList.contains('contract')) ? 'contract'
              : (icon && icon.classList.contains('alert')) ? 'alert'
              : (icon && icon.classList.contains('info')) ? 'info'
              : 'mail';

            parsed.push({
              id: uuid(),
              type,
              title: title || 'Notification',
              message: title || 'Notification',
              atLabel: atLabel || '—',
              unread
            });
          });
        }
      }

      // Production: ne pas injecter de notifications d'exemple.
      // Les notifications peuvent être alimentées par vos événements métier (à connecter si besoin).
      state.ui.notifications = parsed;
      renderNotifications();
    }

    function updateNotificationsBadge(){
      const badge = $('#notifications-badge');
      if (!badge) return;
      const unread = (state.ui.notifications || []).filter(n => n.unread).length;
      badge.textContent = String(unread);
      badge.style.display = unread > 0 ? 'flex' : 'none';
    }

    function renderNotifications(){
      const listEl = $('#notifications-list');
      if (!listEl) return;
      listEl.innerHTML = '';

      for (const n of (state.ui.notifications || [])){
        const row = document.createElement('div');
        row.className = 'notification__item' + (n.unread ? ' unread' : '');
        row.setAttribute('data-id', n.id);

        const iconClass = n.type === 'contract' ? 'contract'
          : n.type === 'alert' ? 'alert'
          : n.type === 'info' ? 'info'
          : 'mail';

        const iconGlyph = n.type === 'contract' ? 'ri-file-text-fill'
          : n.type === 'alert' ? 'ri-error-warning-fill'
          : n.type === 'info' ? 'ri-information-fill'
          : 'ri-mail-fill';

        row.innerHTML = `
          <div class="notification__icon ${iconClass}"><i class="${iconGlyph}"></i></div>
          <div class="notification__content">
            <p>${escapeHtml(n.title)}</p>
            <span>${escapeHtml(n.atLabel || '—')}</span>
          </div>
        `;

        listEl.appendChild(row);
      }

      updateNotificationsBadge();
    }

    function markNotificationRead(id){
      const n = (state.ui.notifications || []).find(x => x.id === id);
      if (!n) return;
      n.unread = false;
      renderNotifications();
    }

    function markAllNotificationsRead(){
      (state.ui.notifications || []).forEach(n => n.unread = false);
      renderNotifications();
      toast('success', 'Notifications', 'Tout est marqué comme lu.');
    }

    function buildNotificationDetailHtml(n){
      const cls = n.type === 'contract' ? 'conv'
        : n.type === 'alert' ? 'comm'
        : n.type === 'info' ? 'arr'
        : 'arr';

      const icon = n.type === 'contract' ? 'ri-file-text-fill'
        : n.type === 'alert' ? 'ri-error-warning-fill'
        : n.type === 'info' ? 'ri-information-fill'
        : 'ri-mail-fill';

      const chip = `<span class="detail-chip ${cls}"><i class="${icon}"></i><b>${escapeHtml(n.type.toUpperCase())}</b></span>`;
      const chip2 = `<span class="detail-chip ${cls}"><i class="ri-time-line"></i><b>${escapeHtml(n.atLabel || '—')}</b></span>`;

      return `
        <div class="detail-hero">
          <div style="min-width:0;">
            <div class="detail-hero__kicker">Notification</div>
            <div class="detail-hero__title">${escapeHtml(n.title)}</div>
            <div class="detail-hero__sub">Cliquez sur “Tout marquer comme lu” pour effacer les alertes non lues.</div>
          </div>
          <div class="detail-hero__chips">${chip}${chip2}</div>
        </div>
        <div class="detail-grid">
          <div class="detail-item detail-item--full">
            <div class="detail-label">Détail</div>
            <div class="detail-value">${escapeHtml(n.message || n.title)}</div>
          </div>
        </div>
      `;
    }

    function openNotificationDetail(id){
      const n = (state.ui.notifications || []).find(x => x.id === id);
      if (!n) return;

      // mark as read when opened
      if (n.unread) n.unread = false;
      renderNotifications();

      try{ closeHeaderDropdowns(); }catch(e){}

      $('#detail-modal-title').textContent = 'Détails — Notification';
      $('#detail-modal-content').innerHTML = buildNotificationDetailHtml(n);

      // Hide edit button for notifications
      const editBtn = $('#detail-modal-edit');
      if (editBtn) editBtn.classList.add('is-hidden');

      $('#detail-modal-backdrop').classList.add('open');
      $('#detail-modal-backdrop').setAttribute('aria-hidden', 'false');
    }

    function escapeHtml(str){
      const s = (str === null || str === undefined) ? '' : String(str);
      return s.replace(/[&<>"]/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;'
      }[ch]));
    }

    function syncColorSchemeToControls(){
      const isLight = document.body.classList.contains('light-theme');
      const scheme = isLight ? 'light' : 'dark';
      // Helps some browsers render native select/date popups in the right theme.
      $$('select, input[type="date"], input[type="time"], input[type="datetime-local"], textarea, input').forEach(el => {
        try{ el.style.colorScheme = scheme; } catch(e){}
      });
    }

    function enhanceSelects(){
      // Add chevrons for selects inside input groups (forms)
      $$('.form__input-group').forEach(group => {
        const sel = group.querySelector('select.form__control');
        if (!sel) return;
        group.classList.add('select-group');
        if (!group.querySelector('.select-chevron')){
          const span = document.createElement('span');
          span.className = 'select-chevron';
          span.innerHTML = '<i class="ri-arrow-down-s-line"></i>';
          group.appendChild(span);
        }
      });

      // Add a subtle chevron for filter selects via wrapper
      $$('.filter-container').forEach(fc => {
        const sel = fc.querySelector('select');
        if (!sel) return;
        fc.classList.add('filter-container--select');
      });
    }

    // Custom select UI for form selects (type/agent/etc.)
    function initCustomSelects(){
      // Cleanup existing menus (hot reload / re-init safety)
      $$('.select-menu').forEach(m => m.remove());
      $$('.select-ui').forEach(ui => ui.remove());
      $$('.form__input-group.select-group.is-enhanced').forEach(g => g.classList.remove('is-enhanced'));

      // Prevent listener accumulation
      if (__selectResizeHandler){
        try{ window.removeEventListener('resize', __selectResizeHandler); }catch(e){}
        __selectResizeHandler = null;
      }

      const selects = $$('form .form__input-group.select-group select.form__control');
      if (!selects.length) return;

      const closeAll = () => {
        $$('.select-menu.open').forEach(m => m.classList.remove('open'));
        document.removeEventListener('click', onDocClick, true);
        document.removeEventListener('keydown', onKeyDown, true);
      };

      const onDocClick = (e) => {
        const openMenu = document.querySelector('.select-menu.open');
        if (!openMenu) return;
        if (openMenu.contains(e.target)) return;
        const owner = openMenu._owner;
        if (owner && owner.contains(e.target)) return;
        closeAll();
      };

      const onKeyDown = (e) => {
        if (e.key === 'Escape') closeAll();
      };

      const openMenuFor = (group, sel, menu) => {
        closeAll();
        // mark selected
        const current = sel.value;
        $$('.select-option', menu).forEach(opt => {
          opt.classList.toggle('is-selected', opt.getAttribute('data-value') === current);
        });

        // position menu
        const vw = window.innerWidth;
        const isMobile = vw <= 880;

        // Make measurable (avoid offsetWidth=0 when closed)
        const prevDisplay = menu.style.display;
        const prevVis = menu.style.visibility;
        menu.style.display = 'block';
        menu.style.visibility = 'hidden';

        if (isMobile){
          menu.style.left = '8px';
          menu.style.right = '8px';
          menu.style.bottom = '8px';
          menu.style.top = 'auto';
          menu.style.width = '';
        } else {
          const r = group.getBoundingClientRect();
          const safe = 10;
          const maxW = Math.min(420, vw - safe*2);
          const targetW = Math.min(maxW, Math.max(260, r.width));
          menu.style.width = targetW + 'px';

          const mr = menu.getBoundingClientRect();
          let left = r.left;
          left = clamp(left, safe, vw - mr.width - safe);

          let top = r.bottom + 8;
          // if overflow bottom, open above
          const vh = window.innerHeight;
          const approxH = Math.min(360, vh - 120);
          if (top + approxH > vh - safe){
            top = Math.max(safe, r.top - approxH - 8);
          }

          menu.style.left = Math.round(left) + 'px';
          menu.style.top = Math.round(top) + 'px';
          menu.style.right = 'auto';
          menu.style.bottom = 'auto';
        }

        // show
        menu.classList.add('open');
        menu.style.visibility = '';
        // restore display to CSS-driven state (avoid inline display:block that would prevent closing)
        menu.style.display = prevDisplay;
        document.addEventListener('click', onDocClick, true);
        document.addEventListener('keydown', onKeyDown, true);

        // focus search
        const search = menu.querySelector('.select-search input');
        if (search) {
          search.value = '';
          search.dispatchEvent(new Event('input'));
          setTimeout(() => search.focus(), 0);
        }

        // restore if needed (keep open)
        try{ void prevVis; }catch(e){}
      };

      const updateUiText = (uiValueEl, sel) => {
        const opt = sel.selectedOptions && sel.selectedOptions[0];
        const txt = opt ? opt.textContent.trim() : '';
        const isPlaceholder = !sel.value;
        uiValueEl.textContent = txt || (opt ? opt.textContent.trim() : '');
        uiValueEl.classList.toggle('select-ui__placeholder', isPlaceholder);
      };

      for (const sel of selects){
        const group = sel.closest('.form__input-group');
        if (!group) continue;
        // Mark as enhanced so CSS can safely hide the native select
        group.classList.add('is-enhanced');

        // Build UI
        const ui = document.createElement('div');
        ui.className = 'select-ui';
        ui.setAttribute('role','button');
        ui.setAttribute('tabindex','0');
        const valueEl = document.createElement('div');
        valueEl.className = 'select-ui__value select-ui__placeholder';
        ui.appendChild(valueEl);
        group.insertBefore(ui, group.querySelector('.select-chevron') || null);

        // Menu
        const menu = document.createElement('div');
        menu.className = 'select-menu';
        menu._owner = group;

        // Search
        const searchWrap = document.createElement('div');
        searchWrap.className = 'select-search';
        searchWrap.innerHTML = `<i class="ri-search-line"></i><input type="text" placeholder="Rechercher...">`;
        menu.appendChild(searchWrap);

        const listWrap = document.createElement('div');
        menu.appendChild(listWrap);

        const rebuildOptions = () => {
          listWrap.innerHTML = '';
          const opts = Array.from(sel.options);
          for (const o of opts){
            const item = document.createElement('div');
            item.className = 'select-option';
            item.setAttribute('data-value', o.value);
            item.innerHTML = `<span>${escapeHtml(o.textContent.trim())}</span>`;
            item.onclick = () => {
              sel.value = o.value;
              sel.dispatchEvent(new Event('change', { bubbles:true }));
              updateUiText(valueEl, sel);
              closeAll();
            };
            listWrap.appendChild(item);
          }
        };
        rebuildOptions();

        // Filter
        const sInput = searchWrap.querySelector('input');
        sInput.addEventListener('input', () => {
          const q = (sInput.value || '').toLowerCase().trim();
          $$('.select-option', listWrap).forEach(el => {
            const t = el.textContent.toLowerCase();
            el.style.display = (!q || t.includes(q)) ? '' : 'none';
          });
        });

        document.body.appendChild(menu);

        // Initial text
        updateUiText(valueEl, sel);

        // Open handlers
        const open = () => openMenuFor(group, sel, menu);
        ui.addEventListener('click', (e) => { e.stopPropagation(); open(); });
        ui.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            open();
          }
        });

        // Keep in sync
        sel.addEventListener('change', () => updateUiText(valueEl, sel));
      }

      // Reposition open menu on resize
      __selectResizeHandler = () => {
        const openMenu = document.querySelector('.select-menu.open');
        if (!openMenu) return;
        const owner = openMenu._owner;
        const sel = owner ? owner.querySelector('select.form__control') : null;
        if (!owner || !sel) return;
        openMenuFor(owner, sel, openMenu);
      };
      window.addEventListener('resize', __selectResizeHandler);
    }

    function setTheme(theme){
      const body = document.body;
      if (theme === 'light'){
        body.classList.remove('dark-theme');
        body.classList.add('light-theme');
      } else {
        body.classList.add('dark-theme');
        body.classList.remove('light-theme');
      }
      const isLight = body.classList.contains('light-theme');
      const switchers = ['#sidebar-theme-switch', '#dark-mode-toggle'].map(s => $(s)).filter(Boolean);
      switchers.forEach(sw => sw.classList.toggle('is-on', isLight));
      const themeIcon = $('#theme-button');
      if (themeIcon) themeIcon.className = isLight ? 'ri-sun-fill nav__icon' : 'ri-moon-clear-fill nav__icon';
      saveJSON(STORAGE.theme, theme);
      syncColorSchemeToControls();
      // Rebuild custom selects (keeps menu UI consistent)
      try{ initCustomSelects(); }catch(e){}
      // refresh charts colors
      setTimeout(() => buildOrUpdateCharts(), 50);
    }

    function getTheme(){
      return loadJSON(STORAGE.theme, null) || 'dark';
    }

    function requireAdmin(actionLabel='Cette action'){
      if (state.user.isAdmin) return true;
      toast('warn', 'Connexion requise', `${actionLabel} nécessite une connexion administrateur.`);
      openLogin();
      return false;
    }

    // --- Auth ---
    function getAdminPassword(){
      // Mot de passe demo (non persisté)
      return 'sdmfpippdc';
    }

    function setAdminPassword(pw){
      // Non persisté (démo)
      return;
    }

    function loadAuth(){
      // Auth non persistée: toujours démarrer en invité
      state.user = { role: 'Invité', email: 'invite@sdmfpippdc.gov', name: 'Invité', isAdmin: false };
      applyAuthToUI();
    }

    function applyAuthToUI(){
      $('#user-role').textContent = state.user.isAdmin ? 'Administrateur' : 'Invité';
      $('#user-email').textContent = state.user.isAdmin ? (state.user.email || 'admin@sdmfpippdc.gov') : 'invite@sdmfpippdc.gov';
      $('#header-name').textContent = state.user.isAdmin ? (state.user.name || 'Administrateur') : 'Invité';

      const label = $('#auth-toggle-label');
      const icon = $('#auth-toggle-icon');
      if (state.user.isAdmin){
        label.textContent = 'Déconnexion';
        icon.className = 'ri-logout-box-line nav__icon';
      } else {
        label.textContent = 'Connexion administrateur';
        icon.className = 'ri-login-box-line nav__icon';
      }

      // Profile default values (kept for name/email/phone)
      const profile = loadJSON(STORAGE.profile, {
        name: 'Administrateur SDMFPIPPDC',
        email: 'admin@sdmfpippdc.gov',
        phone: '',
        avatar: ''
      });

      // --- Avatars as logos (Invité/Admin) ---
      const svgToDataUri = (svg) => {
        // Encode safely for data URI
        return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg)
          .replace(/%0A/g,'')
          .replace(/%20/g,' ');
      };

      const guestLogo = svgToDataUri(`
        <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#06b6d4"/>
              <stop offset="1" stop-color="#2563eb"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="84" height="84" rx="26" fill="#0b1628"/>
          <rect x="6" y="6" width="84" height="84" rx="26" fill="url(#g)" opacity=".20"/>
          <circle cx="48" cy="40" r="14" fill="url(#g)"/>
          <path d="M22 78c5-14 18-22 26-22s21 8 26 22" fill="none" stroke="url(#g)" stroke-width="8" stroke-linecap="round"/>
          <path d="M32 28l6-6m26 6l-6-6" stroke="#60a5fa" stroke-width="4" stroke-linecap="round" opacity=".55"/>
        </svg>
      `);

      const adminLogo = svgToDataUri(`
        <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
          <defs>
            <linearGradient id="p" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#60a5fa"/>
              <stop offset="1" stop-color="#2563eb"/>
            </linearGradient>
            <linearGradient id="c" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#22c55e"/>
              <stop offset="1" stop-color="#06b6d4"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="84" height="84" rx="26" fill="#0b1628"/>
          <rect x="6" y="6" width="84" height="84" rx="26" fill="url(#p)" opacity=".22"/>
          <path d="M48 18l10 10 14 2-8 12 2 14-18-6-18 6 2-14-8-12 14-2 10-10z" fill="url(#p)"/>
          <path d="M30 72h36" stroke="url(#c)" stroke-width="8" stroke-linecap="round"/>
          <path d="M36 62h24" stroke="url(#c)" stroke-width="6" stroke-linecap="round" opacity=".85"/>
          <circle cx="48" cy="44" r="8" fill="#0f1b2d" opacity=".55"/>
        </svg>
      `);

      const logoSrc = state.user.isAdmin ? adminLogo : guestLogo;
      const avatarEls = ['#user-avatar', '#header-avatar', '#dropdown-avatar', '#profile-img']
        .map(s => $(s))
        .filter(Boolean);
      avatarEls.forEach(img => {
        img.src = logoSrc;
        img.alt = state.user.isAdmin ? 'Administrateur' : 'Invité';
      });

      // Status dot: green for admin, muted for guest
      const statusDot = document.querySelector('.avatar__status');
      if (statusDot){
        statusDot.style.background = state.user.isAdmin ? 'var(--success)' : 'rgba(148,163,184,.75)';
      }

      // In logo-mode we hide photo actions (but keep profile editing for admin)
      const photoActions = $('.profile-image-actions');
      if (photoActions) photoActions.classList.add('is-hidden');

      // Update profile values
      if (state.user.isAdmin){
        $('#profile-name').value = profile.name || 'Administrateur SDMFPIPPDC';
        $('#profile-email').value = profile.email || 'admin@sdmfpippdc.gov';
        $('#profile-phone').value = profile.phone || '';
      }

      $('#dropdown-logout').classList.toggle('is-hidden', !state.user.isAdmin);
      const dLogin = $('#dropdown-login');
      if (dLogin){
        dLogin.style.display = state.user.isAdmin ? 'none' : 'flex';
      }

      // --- Mode Invité: masquer les formulaires dans le sidebar et le bouton "Nouveau" ---
      const shouldHideForms = !state.user.isAdmin;
      $$(`.nav__link[data-section]`).forEach(link => {
        const section = link.getAttribute('data-section');
        if (!section) return;
        if (FORM_SECTIONS.includes(section)){
          const li = link.closest('li');
          if (li) li.classList.toggle('is-hidden', shouldHideForms);
        }
      });
      const btnNew = $('#btn-new');
      if (btnNew) btnNew.classList.toggle('is-hidden', shouldHideForms);
    }

    function openLogin(){
      const screen = $('#login-screen');
      const card = $('.login-card', screen);
      document.body.classList.add('modal-open');
      screen.classList.remove('is-hidden');
      $('#login-error').textContent = '';
      if (card) card.classList.remove('shake');
      setTimeout(() => $('#login-username').focus(), 0);
    }

    function closeLogin(){
      const screen = $('#login-screen');
      const card = $('.login-card', screen);
      document.body.classList.remove('modal-open');
      screen.classList.add('is-hidden');
      $('#login-form').reset();
      $('#login-error').textContent = '';
      if (card) card.classList.remove('shake');
    }

    function login(username, password){
      if ((username || '').trim().toLowerCase() !== 'admin') return false;
      if (password !== getAdminPassword()) return false;
      state.user = { role: 'Administrateur', email: 'admin@sdmfpippdc.gov', name: 'Administrateur', isAdmin: true };
      // Auth NON persistée (Firebase hosting friendly)
      // saveJSON(STORAGE.auth, state.user);
      applyAuthToUI();
      addActivity('Connexion', 'Connexion administrateur réussie');
      toast('success', 'Connecté', 'Bienvenue, administrateur.', { variant: 'update' });
      return true;
    }

    function logout(){
      state.user = { role: 'Invité', email: 'invite@sdmfpippdc.gov', name: 'Invité', isAdmin: false };
      // Auth non persistée: rien à supprimer côté stockage
      applyAuthToUI();
      addActivity('Déconnexion', 'Session administrateur terminée');
      toast('info', 'Déconnecté', 'Vous êtes maintenant en mode invité.', { variant: 'update' });
    }

    // --- Data ---
    function loadAllData(){
      state.data.imputations = loadJSON(STORAGE.imputations, []);
      state.data.arrivals = loadJSON(STORAGE.arrivals, []);
      state.data.conventions = loadJSON(STORAGE.conventions, []);
      state.data.commissions = loadJSON(STORAGE.commissions, []);
    }

    function persistAllData(){
      saveJSON(STORAGE.imputations, state.data.imputations);
      saveJSON(STORAGE.arrivals, state.data.arrivals);
      saveJSON(STORAGE.conventions, state.data.conventions);
      saveJSON(STORAGE.commissions, state.data.commissions);
      // Flush immédiat pour éviter de perdre les données si l’utilisateur recharge rapidement.
      // On force un flush non-silencieux pour que l’utilisateur voie l’erreur si le stockage distant n'est pas configuré.
      try{ if (__dbConn) remoteFlush(false); }catch(e){}
      // Si la connexion existe mais l'écriture échoue temporairement, on retente silencieusement.
      try{
        if (__dbConn && !__dbReady){
          setTimeout(() => { try{ remoteFlush(true); }catch(e){} }, 1800);
        }
      }catch(e){}
    }

    function seedIfEmpty(){
      // En production, on ne seed pas.
      if (!ENABLE_DEMO_SEED){
        // Aucune donnée d'exemple en production.
        return;
      }

      // IMPORTANT: on reseed si les données sont vides, même si le flag `seeded` existe.
      // (utile uniquement en mode démo)
      const haveData = [STORAGE.imputations, STORAGE.arrivals, STORAGE.conventions, STORAGE.commissions]
        .some(k => {
          const arr = loadJSON(k, []);
          return Array.isArray(arr) && arr.length > 0;
        });

      if (haveData){
        if (!lsGet(STORAGE.seeded)) lsSet(STORAGE.seeded, '1');
        return;
      }

      const today = new Date();
      const daysAgo = (n) => {
        const d = new Date();
        d.setDate(today.getDate() - n);
        return dateKey(d);
      };

      const imputations = [
        { id: uuid(), number:'IMP-2025-001', imputationDate: daysAgo(2), mailNumber:'SDM-001-25', arrivalDate: daysAgo(4), mailObject:'Demande d’informations', imputationObject:'Analyse et traitement', structure:'CABINET', type:'ETATIQUE', agent:'Mr KONE', attachment:'', createdAt: nowIso() },
        { id: uuid(), number:'IMP-2025-002', imputationDate: daysAgo(5), mailNumber:'SDM-014-25', arrivalDate: daysAgo(6), mailObject:'Réclamation', imputationObject:'Évaluation et réponse', structure:'DUDU', type:'CONTENTIEUX', agent:'Mme TRAORE', attachment:'', createdAt: nowIso() },
        { id: uuid(), number:'IMP-2025-003', imputationDate: daysAgo(9), mailNumber:'SDM-020-25', arrivalDate: daysAgo(10), mailObject:'Partenariat', imputationObject:'Préparer note', structure:'PCE', type:'PRIVE', agent:'Mr OUATTARA', attachment:'', createdAt: nowIso() },
      ];

      const arrivals = [
        { id: uuid(), number:'ARR-2025-004', date: daysAgo(1), sender:'Préfecture', object:'Transmission dossier', cabNumber:'CAB-013', cabDate: daysAgo(1), duduNumber:'', duduDate:'', pceNumber:'', attachment:'', createdAt: nowIso() },
        { id: uuid(), number:'ARR-2025-003', date: daysAgo(7), sender:'Société X', object:'Demande audience', cabNumber:'', cabDate:'', duduNumber:'DUDU-009', duduDate: daysAgo(6), pceNumber:'PCE-002', attachment:'', createdAt: nowIso() },
      ];

      const conventions = [
        { id: uuid(), number:'CONV-2025-001', designation:'Convention agro-foresterie', ville:'Abidjan', village:'', superficie: 120, type:'PRIVE', projet:'Développement agro-foresterie.', attachment:'', createdAt: nowIso() },
        { id: uuid(), number:'CONV-2025-002', designation:'Convention étatique — réhabilitation', ville:'Bouaké', village:'N’Gatta', superficie: 60, type:'ETATIQUE', projet:'Réhabilitation d’infrastructures.', attachment:'', createdAt: nowIso() },
      ];

      const commissions = [
        { id: uuid(), number:'COMM-2025-001', designation:'Commission foncière', locality:'Yamoussoukro', date: daysAgo(-4), description:'Commission administrative pour étude dossier.', members:'Mr KONE, Mme TRAORE, Mr BONI', attachment:'', createdAt: nowIso() },
        { id: uuid(), number:'COMM-2025-002', designation:'Commission contentieux', locality:'Abengourou', date: daysAgo(12), description:'Analyse et arbitrage.', members:'Mr OUATTARA, Mr BONI', attachment:'', createdAt: nowIso() },
      ];

      saveJSON(STORAGE.imputations, imputations);
      saveJSON(STORAGE.arrivals, arrivals);
      saveJSON(STORAGE.conventions, conventions);
      saveJSON(STORAGE.commissions, commissions);
      saveJSON(STORAGE.activities, [
        { id: uuid(), at: nowIso(), title:'Initialisation', message:'Jeu de données de démonstration chargé.' }
      ]);
      lsSet(STORAGE.seeded, '1');
    }

    // --- Navigation ---
    function sectionIdFromKey(key){
      return `${key}-section`;
    }

    function activateSection(key){
      // Mode invité: rediriger les sections de saisie vers les listes
      if (!state.user.isAdmin && FORM_SECTIONS.includes(key)){
        const redirected = FORM_TO_LIST[key] || 'dashboard';
        toast('warn', 'Accès limité', 'En mode invité, seuls les écrans de liste sont accessibles.');
        key = redirected;
      }

      const id = sectionIdFromKey(key);
      $$('.section').forEach(s => s.classList.remove('active-section'));
      const target = document.getElementById(id);
      if (target) target.classList.add('active-section');

      $$('.nav__link').forEach(a => {
        const k = a.getAttribute('data-section');
        a.classList.toggle('active', k === key);
      });

      // render relevant views
      if (key === 'dashboard') renderDashboard();
      if (key === 'imputation-list') renderImputationsTable();
      if (key === 'arrival-list') renderArrivalsTable();
      if (key === 'convention-list') renderConventionsTable();
      if (key === 'commission-list') renderCommissionsTable();

      closeMobileSidebar();
      // close dropdowns (robust reset)
      try{ closeHeaderDropdowns(); }catch(e){}

      // scroll top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- Sidebar (mobile/desktop) ---
    function openMobileSidebar(){
      $('#sidebar').classList.add('open');
      $('#sidebar-backdrop').classList.add('open');
    }

    function closeMobileSidebar(){
      $('#sidebar').classList.remove('open');
      $('#sidebar-backdrop').classList.remove('open');
    }

    // Robust close for header dropdowns (Profil/Notifications) even when they were positioned via inline styles.
    // Needed because some flows (navigation) removed only the `.open` class, leaving `display:flex` inline.
    function closeHeaderDropdowns(){
      const notifDrop = $('#notifications-dropdown');
      const profileDrop = $('#profile-dropdown');
      const ddBackdrop = $('#dropdown-backdrop');

      const reset = (el) => {
        if (!el) return;
        el.classList.remove('open');
        el.classList.remove('dropdown-sheet');
        el.style.display = '';
        el.style.visibility = '';
        el.style.position = '';
        el.style.left = '';
        el.style.top = '';
        el.style.right = '';
        el.style.bottom = '';
        el.style.width = '';
        el.style.maxWidth = '';
        el.style.maxHeight = '';
      };

      reset(notifDrop);
      reset(profileDrop);

      if (ddBackdrop){
        ddBackdrop.classList.remove('open');
        ddBackdrop.setAttribute('aria-hidden','true');
      }
      document.body.classList.remove('dropdown-open');
    }

    function syncSidebarToggleVar(){
      const sb = $('#sidebar');
      const w = sb && sb.classList.contains('sidebar--collapsed') ? '88px' : '290px';
      document.body.style.setProperty('--sb-w', w);
    }

    // Le toggle desktop est désormais dans un "rail" entre le sidebar et le contenu.
    // Donc on n’a plus besoin de calculer sa position en JS.
    function positionSidebarToggle(){ /* no-op */ }

    function toggleDesktopSidebar(){
      const sb = $('#sidebar');
      const btn = $('#sidebar-desktop-toggle');
      sb.classList.toggle('sidebar--collapsed');
      if (btn) btn.classList.toggle('is-collapsed', sb.classList.contains('sidebar--collapsed'));
      syncSidebarToggleVar();
      // Le bouton est dans le rail (sticky) : aucun repositionnement JS nécessaire.
    }

    // --- Rendering: tables + dashboard ---
    function updateDashRangeUI(){
      const days = Number(state.ui.dashRangeDays || 30);
      const labelEl = $('#dash-range');
      if (labelEl){
        labelEl.textContent = `Période: ${days} derniers jours`;
      }
      const hint = $('#legend-hint');
      if (hint){
        hint.textContent = `Total global • Graph: ${days} jours`;
      }
      // mark active option
      const menu = $('#dash-range-menu');
      if (menu){
        $$('.range-option', menu).forEach(btn => {
          const d = Number(btn.getAttribute('data-days') || 0);
          btn.classList.toggle('is-active', d === days);
        });
      }
    }

    function updateBadgesAndStats(){
      const setText = (sel, value) => {
        const el = $(sel);
        if (el) el.textContent = String(value);
      };
      const setWidth = (sel, value) => {
        const el = $(sel);
        if (el) el.style.width = String(value);
      };

      const imp = state.data.imputations.length;
      const arr = state.data.arrivals.length;
      const conv = state.data.conventions.length;
      const comm = state.data.commissions.length;

      setText('#badge-imputations', imp);
      setText('#badge-arrivals', arr);
      setText('#badge-conventions', conv);
      setText('#badge-commissions', comm);

      setText('#total-imputations', imp);
      setText('#total-arrivals', arr);
      setText('#total-conventions', conv);
      setText('#total-commissions', comm);

      // Imputation type split
      const etatique = state.data.imputations.filter(x => x.type === 'ETATIQUE').length;
      const prive = state.data.imputations.filter(x => x.type === 'PRIVE').length;
      const contentieux = state.data.imputations.filter(x => x.type === 'CONTENTIEUX').length;
      const mobilisation = state.data.imputations.filter(x => x.type === 'MOBILISATION').length;

      setText('#total-etatique', etatique);
      setText('#total-prive', prive);
      setText('#total-contentieux', contentieux);
      setText('#total-mobilisation', mobilisation);

      // Mobilisation: barre + % + autres
      const mobDenom = Math.max(imp, 1);
      const mobPct = Math.round((mobilisation / mobDenom) * 100);
      setText('#mobilisation-pct', mobPct + '%');
      setWidth('#mobilisation-bar', mobPct + '%');

      const denom = Math.max(imp, 1);
      const pctEta = Math.round((etatique/denom)*100);
      const pctPri = Math.round((prive/denom)*100);
      setWidth('#progress-etatique', pctEta + '%');
      setWidth('#progress-prive', pctPri + '%');
      setText('#pct-etatique', pctEta + '%');
      setText('#pct-prive', pctPri + '%');
      setText('#doc-total', imp);

      // ===== Contentieux (simplifié) =====
      // Total contentieux = nombre d'imputations de type CONTENTIEUX
      // (La carte n'affiche plus Top agents / Agents / Structures)

      // Met à jour l'UI de période (texte + menu)
      updateDashRangeUI();

      // Totaux par jour / mois (date locale pour éviter les décalages UTC)
      const todayKey = dateKey(new Date());
      const monthKey = todayKey.slice(0,7); // YYYY-MM

      // Tous les compteurs "Aujourd'hui / Ce mois" sont désormais basés
      // UNIQUEMENT sur la date de saisie (createdAt), pour que les 4 cartes
      // réagissent immédiatement après enregistrement, quel que soit le champ date métier.
      const countDay = (items) => items.filter(x => {
        const v = x.createdAt;
        if (!v) return false;
        return dateKey(v) === todayKey;
      }).length;

      const countMonth = (items) => items.filter(x => {
        const v = x.createdAt;
        if (!v) return false;
        const dk = dateKey(v);
        return dk && dk.slice(0,7) === monthKey;
      }).length;

      // Imputations
      setText('#imp-day', countDay(state.data.imputations));
      setText('#imp-month', countMonth(state.data.imputations));

      // Arrivées
      setText('#arr-day', countDay(state.data.arrivals));
      setText('#arr-month', countMonth(state.data.arrivals));

      // Conventions
      setText('#conv-day', countDay(state.data.conventions));
      setText('#conv-month', countMonth(state.data.conventions));

      // Commissions
      setText('#comm-day', countDay(state.data.commissions));
      setText('#comm-month', countMonth(state.data.commissions));

      // ===== Références (Arrivées) — Totaux =====
      const norm = (v) => String(v || '').trim();
      const has = (v) => norm(v).length > 0;
      const cabTotal = state.data.arrivals.filter(a => has(a.cabNumber)).length;
      const duduTotal = state.data.arrivals.filter(a => has(a.duduNumber)).length;
      const pceTotal = state.data.arrivals.filter(a => has(a.pceNumber)).length;

      const dgufTotal = state.data.arrivals.filter(a => {
        const p = norm(a.pceNumber).toUpperCase();
        return p.includes('DGUF/');
      }).length;
      const dduTotal = state.data.arrivals.filter(a => {
        const p = norm(a.pceNumber).toUpperCase();
        return p.includes('DDU/');
      }).length;

      setText('#total-cab', cabTotal);
      setText('#total-dudu', duduTotal);
      setText('#total-pce', pceTotal);
      setText('#total-dguf', dgufTotal);
      setText('#total-ddu', dduTotal);

      // Conventions (createdAt en ISO)
      setText('#conv-day', countDay(state.data.conventions, 'createdAt'));
      setText('#conv-month', countMonth(state.data.conventions, 'createdAt'));

      // Commissions: compter par date de création (créée lors de l’enregistrement)
      // (la date de commission peut être future, donc non représentative de l’activité récente)
      setText('#comm-day', countDay(state.data.commissions, 'createdAt'));
      setText('#comm-month', countMonth(state.data.commissions, 'createdAt'));

      buildOrUpdateCharts();

      // Fallback legend update (even if Chart.js is blocked)
      try{
        const setLegend = (id, v) => { const el = $(id); if (el) el.textContent = String(v); };
        // Legend totals: total global (synchronisé avec les listes)
        setLegend('#legend-imp', state.data.imputations.length);
        setLegend('#legend-arr', state.data.arrivals.length);
        setLegend('#legend-conv', state.data.conventions.length);
        setLegend('#legend-comm', state.data.commissions.length);
        updateDashRangeUI();
      } catch(e){}
    }

    function renderDashboard(){
      updateBadgesAndStats();

      // recent imputations
      const imp = [...state.data.imputations]
        .sort((a,b) => String(b.imputationDate || b.createdAt).localeCompare(String(a.imputationDate || a.createdAt)))
        .slice(0, 4);
      const impCtn = $('#recent-imputations');
      impCtn.innerHTML = '';
      if (!imp.length){
        impCtn.innerHTML = '<div style="color:var(--muted2); font-size:13px;">Aucune imputation enregistrée.</div>';
      } else {
        for (const r of imp){
          const pill = r.type === 'ETATIQUE' ? 'etatique' : (r.type === 'PRIVE' ? 'prive' : 'contentieux');
          const div = document.createElement('div');
          div.className = 'recent-item';
          div.innerHTML = `
            <div class="recent-main">
              <div class="recent-title">${escapeHtml(r.number)} • ${escapeHtml(r.mailNumber)}</div>
              <div class="recent-sub">${escapeHtml(r.mailObject)} — ${escapeHtml(r.structure)} • ${fmtDate(r.imputationDate)}</div>
              <div><span class="pill ${pill}">${escapeHtml(r.type)}</span> <span class="pill" style="background:rgba(255,255,255,.05)">${escapeHtml(r.agent)}</span></div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn-icon" data-action="view" data-entity="imputation" data-id="${r.id}" title="Détails"><i class="ri-eye-line"></i></button>
            </div>
          `;
          impCtn.appendChild(div);
        }
      }

      // recent arrivals
      const arr = [...state.data.arrivals]
        .sort((a,b) => String(b.date || b.createdAt).localeCompare(String(a.date || a.createdAt)))
        .slice(0, 4);
      const arrCtn = $('#recent-arrivals');
      arrCtn.innerHTML = '';
      if (!arr.length){
        arrCtn.innerHTML = '<div style="color:var(--muted2); font-size:13px;">Aucun courrier arrivé enregistré.</div>';
      } else {
        for (const r of arr){
          const div = document.createElement('div');
          div.className = 'recent-item';
          div.innerHTML = `
            <div class="recent-main">
              <div class="recent-title">${escapeHtml(r.number)} • ${escapeHtml(r.sender)}</div>
              <div class="recent-sub">${escapeHtml(r.object)} • ${fmtDate(r.date)}</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                ${r.cabNumber ? `<span class="pill">CAB: ${escapeHtml(r.cabNumber)}</span>` : ''}
                ${r.duduNumber ? `<span class="pill">DUDU: ${escapeHtml(r.duduNumber)}</span>` : ''}
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn-icon" data-action="view" data-entity="arrival" data-id="${r.id}" title="Détails"><i class="ri-eye-line"></i></button>
            </div>
          `;
          arrCtn.appendChild(div);
        }
      }

      // Convention scroller
      renderConventionScroller();

      // Agent performance (imputations by agent)
      const map = new Map(AGENTS.map(a => [a, 0]));
      for (const i of state.data.imputations) map.set(i.agent, (map.get(i.agent) || 0) + 1);
      const list = Array.from(map.entries())
        .map(([agent, count]) => ({ agent, count }))
        .sort((a,b) => b.count - a.count);

      const agentCtn = $('#agent-performance-list');
      agentCtn.innerHTML = '';

      const agentIconHtml = (name) => {
        const n = String(name || '').trim();
        const lower = n.toLowerCase();

        // Simple, clean silhouettes using inline SVG (theme-friendly)
        const svgPerson = (variant) => {
          // variant: 'male' | 'female'
          // Using currentColor so it follows .agent-avatar color
          const headR = variant === 'female' ? 4.3 : 4.6;
          const yHead = variant === 'female' ? 7.0 : 6.8;
          const shoulderW = variant === 'female' ? 16.8 : 18.2;
          const shoulderH = variant === 'female' ? 9.0 : 9.6;
          const yShoulder = variant === 'female' ? 13.0 : 12.6;
          return `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="12" cy="${yHead}" r="${headR}" fill="currentColor" opacity="0.95"/>
              <path d="M4.8 ${yShoulder}c1.9-3.6 5-5.4 7.2-5.4s5.3 1.8 7.2 5.4c.7 1.3.4 2.8-.7 3.6-1.3.9-3.4 1.7-6.5 1.7s-5.2-.8-6.5-1.7c-1.1-.8-1.4-2.3-.7-3.6z" fill="currentColor" opacity="0.78"/>
              <path d="M5.6 ${yShoulder + shoulderH}c2.3-2.2 4.8-3.1 6.4-3.1s4.1.9 6.4 3.1" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.55"/>
            </svg>
          `;
        };

        if (lower === 'secretariat' || lower === 'secrétariat'){
          // 3 femmes superposées (stacked silhouettes)
          return `
            <span class="agent-avatar agent-avatar--secretariat" aria-hidden="true">
              <span style="position:absolute; left:6px; top:6px; opacity:.95; transform: scale(.86)">${svgPerson('female')}</span>
              <span style="position:absolute; left:9px; top:7px; opacity:.90; transform: scale(.86)">${svgPerson('female')}</span>
              <span style="position:absolute; left:7px; top:9px; opacity:.85; transform: scale(.86)">${svgPerson('female')}</span>
            </span>
          `;
        }

        if (lower.startsWith('mme')){
          return `<span class="agent-avatar agent-avatar--female" aria-hidden="true">${svgPerson('female')}</span>`;
        }

        return `<span class="agent-avatar agent-avatar--male" aria-hidden="true">${svgPerson('male')}</span>`;
      };

      for (const a of list){
        const div = document.createElement('div');
        div.className = 'agent-row';
        div.innerHTML = `
          <div class="agent-meta">
            <div class="agent-name-row">
              ${agentIconHtml(a.agent)}
              <div class="agent-name">${escapeHtml(a.agent)}</div>
            </div>
            <div class="agent-sub">Imputations traitées</div>
          </div>
          <div class="agent-score">${a.count}</div>
        `;
        agentCtn.appendChild(div);
      }

      // Commission summary
      $('#dashboard-commission-total').textContent = String(state.data.commissions.length);
      const todayKey = dateKey(new Date());
      const upcoming = [...state.data.commissions]
        .filter(c => c.date)
        .sort((a,b) => String(dateKey(a.date)).localeCompare(String(dateKey(b.date))))
        .find(c => dateKey(c.date) >= todayKey);
      $('#dashboard-commission-next').textContent = upcoming ? `${upcoming.number} (${fmtDate(upcoming.date)})` : '-';

      const cList = $('#dashboard-commission-list');
      cList.innerHTML = '';
      const topC = [...state.data.commissions]
        .sort((a,b) => String(b.date || b.createdAt).localeCompare(String(a.date || a.createdAt)))
        .slice(0, 4);
      if (!topC.length){
        cList.innerHTML = '<div style="color:var(--muted2); font-size:13px;">Aucune commission enregistrée.</div>';
      } else {
        for (const c of topC){
          const div = document.createElement('div');
          div.className = 'agent-row';
          div.innerHTML = `
            <div class="agent-meta">
              <div class="agent-name">${escapeHtml(c.number)}</div>
              <div class="agent-sub">${escapeHtml(c.designation)} • ${escapeHtml(c.locality)} • ${fmtDate(c.date)}</div>
            </div>
            <button class="btn-icon" data-action="view" data-entity="commission" data-id="${c.id}" title="Détails"><i class="ri-eye-line"></i></button>
          `;
          cList.appendChild(div);
        }
      }

      // action listeners for new buttons within dashboard
      $$('#dashboard-section [data-action="view"]').forEach(btn => {
        btn.onclick = (e) => {
          const entity = btn.getAttribute('data-entity');
          const id = btn.getAttribute('data-id');
          openDetail(entity, id);
        };
      });
    }

    function renderConventionScroller(){
      const items = [...state.data.conventions]
        .sort((a,b) => String(b.createdAt).localeCompare(String(a.createdAt)))
        .filter(c => {
          if (state.ui.conventionTab === 'all') return true;
          if (state.ui.conventionTab === 'prive') return c.type === 'PRIVE';
          if (state.ui.conventionTab === 'etatique') return c.type === 'ETATIQUE';
          return true;
        })
        .slice(0, 12);

      const scroller = $('#conventionScroller');
      scroller.innerHTML = '';
      if (!items.length){
        scroller.innerHTML = '<div style="color:var(--muted2); font-size:13px;">Aucune convention.</div>';
      } else {
        for (const c of items){
          const div = document.createElement('div');
          div.className = 'convention-card';
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                <h4>${escapeHtml(c.number)}</h4>
                <p>${escapeHtml(c.designation)}</p>
              </div>
              <span class="pill ${c.type === 'ETATIQUE' ? 'etatique' : 'prive'}">${escapeHtml(c.type)}</span>
            </div>
            <p style="margin-top:10px">${escapeHtml(c.ville)}${c.village ? ' — ' + escapeHtml(c.village) : ''}</p>
            <p>Superficie: <b style="color:var(--text)">${escapeHtml(c.superficie)}</b> ha</p>
            <div style="display:flex; justify-content:flex-end; margin-top:10px;">
              <button class="btn btn--sm btn--outline" data-action="view" data-entity="convention" data-id="${c.id}"><i class="ri-eye-line"></i><span>Détails</span></button>
            </div>
          `;
          scroller.appendChild(div);
        }
      }

      // stats
      const total = state.data.conventions.length;
      const priv = state.data.conventions.filter(c => c.type === 'PRIVE').length;
      const eta = state.data.conventions.filter(c => c.type === 'ETATIQUE').length;
      $('#convention-stats-total').textContent = `${total} conventions`;
      $('#convention-stats-prive').textContent = String(priv);
      $('#convention-stats-etatique').textContent = String(eta);

      $$('#conventionScroller [data-action="view"]').forEach(btn => {
        btn.onclick = () => openDetail('convention', btn.getAttribute('data-id'));
      });
    }

    function buildTableActions(entity, id){
      return `
        <div style="display:flex; gap:8px;">
          <button class="btn-icon" data-action="view" data-entity="${entity}" data-id="${id}" title="Détails"><i class="ri-eye-line"></i></button>
          <button class="btn-icon" data-action="edit" data-entity="${entity}" data-id="${id}" title="Modifier"><i class="ri-edit-line"></i></button>
          <button class="btn-icon" data-action="delete" data-entity="${entity}" data-id="${id}" title="Supprimer"><i class="ri-delete-bin-line"></i></button>
        </div>
      `;
    }

    function wireTableActionHandlers(root){
      $$('[data-action]', root).forEach(btn => {
        btn.onclick = () => {
          const action = btn.getAttribute('data-action');
          const entity = btn.getAttribute('data-entity');
          const id = btn.getAttribute('data-id');
          if (action === 'view') return openDetail(entity, id);
          if (action === 'edit') return openEdit(entity, id);
          if (action === 'delete') return confirmDelete(entity, id);
        };
      });
    }

    function paginate(items, page, perPage){
      const total = items.length;
      const pages = Math.max(1, Math.ceil(total/perPage));
      const p = clamp(page, 1, pages);
      const start = (p-1)*perPage;
      return { page: p, pages, total, slice: items.slice(start, start+perPage) };
    }

    function renderPagination(el, page, pages, total, onChange){
      el.innerHTML = '';
      if (total === 0){
        el.textContent = 'Aucune donnée pour le moment.';
        return;
      }
      const left = document.createElement('div');
      left.textContent = `Total: ${total} • Page ${page}/${pages}`;
      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '8px';

      const mk = (label, p, disabled=false) => {
        const b = document.createElement('button');
        b.className = 'btn btn--sm btn--outline';
        b.textContent = label;
        b.disabled = disabled;
        b.style.opacity = disabled ? .5 : 1;
        b.onclick = () => onChange(p);
        return b;
      };

      right.appendChild(mk('Précédent', page-1, page<=1));
      right.appendChild(mk('Suivant', page+1, page>=pages));

      el.style.display = 'flex';
      el.style.alignItems = 'center';
      el.style.justifyContent = 'space-between';
      el.appendChild(left);
      el.appendChild(right);
    }

    function renderImputationsTable(page=1){
      const search = ($('#imputation-search').value || '').toLowerCase().trim();
      const filter = $('#imputation-filter').value;

      let items = [...state.data.imputations];
      if (filter !== 'all') items = items.filter(i => i.type === filter);
      if (search){
        items = items.filter(i => [i.number, i.mailNumber, i.mailObject, i.structure, i.type, i.agent].some(v => String(v||'').toLowerCase().includes(search)));
      }
      items.sort((a,b) => String(b.imputationDate || b.createdAt).localeCompare(String(a.imputationDate || a.createdAt)));

      const perPage = 10;
      const pg = paginate(items, page, perPage);

      const tbody = $('#imputations-table-body');
      tbody.innerHTML = '';
      for (const r of pg.slice){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${escapeHtml(r.number)}</b></td>
          <td>${fmtDate(r.imputationDate)}</td>
          <td>${escapeHtml(r.mailObject)}</td>
          <td>${escapeHtml(r.structure)}</td>
          <td>${escapeHtml(r.type)}</td>
          <td>${escapeHtml(r.agent)}</td>
          <td>${buildTableActions('imputation', r.id)}</td>
        `;
        tbody.appendChild(tr);
      }
      wireTableActionHandlers(tbody);

      renderPagination($('#imputations-pagination'), pg.page, pg.pages, pg.total, (p) => renderImputationsTable(p));
    }

    function renderArrivalsTable(page=1){
      const search = ($('#arrival-search').value || '').toLowerCase().trim();
      let items = [...state.data.arrivals];
      if (search){
        items = items.filter(i => [i.number, i.sender, i.object, i.cabNumber, i.duduNumber].some(v => String(v||'').toLowerCase().includes(search)));
      }
      items.sort((a,b) => String(b.date || b.createdAt).localeCompare(String(a.date || a.createdAt)));

      const perPage = 10;
      const pg = paginate(items, page, perPage);

      const tbody = $('#arrivals-table-body');
      tbody.innerHTML = '';
      for (const r of pg.slice){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${escapeHtml(r.number)}</b></td>
          <td>${fmtDate(r.date)}</td>
          <td>${escapeHtml(r.sender)}</td>
          <td>${escapeHtml(r.object)}</td>
          <td>${escapeHtml(r.cabNumber || '-')}</td>
          <td>${escapeHtml(r.duduNumber || '-')}</td>
          <td>${buildTableActions('arrival', r.id)}</td>
        `;
        tbody.appendChild(tr);
      }
      wireTableActionHandlers(tbody);

      renderPagination($('#arrivals-pagination'), pg.page, pg.pages, pg.total, (p) => renderArrivalsTable(p));
    }

    function renderConventionsTable(page=1){
      const search = ($('#convention-search').value || '').toLowerCase().trim();
      const filter = $('#convention-filter').value;

      let items = [...state.data.conventions];
      if (filter !== 'all') items = items.filter(i => i.type === filter);
      if (search){
        items = items.filter(i => [i.number, i.designation, i.ville, i.village, i.type].some(v => String(v||'').toLowerCase().includes(search)));
      }
      items.sort((a,b) => String(b.createdAt).localeCompare(String(a.createdAt)));

      const perPage = 10;
      const pg = paginate(items, page, perPage);

      const tbody = $('#conventions-table-body');
      tbody.innerHTML = '';
      for (const r of pg.slice){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${escapeHtml(r.number)}</b></td>
          <td>${escapeHtml(r.designation)}</td>
          <td>${escapeHtml(r.ville)}</td>
          <td>${escapeHtml(r.village || '-')}</td>
          <td>${escapeHtml(r.superficie)}</td>
          <td>${escapeHtml(r.type)}</td>
          <td>${buildTableActions('convention', r.id)}</td>
        `;
        tbody.appendChild(tr);
      }
      wireTableActionHandlers(tbody);

      renderPagination($('#conventions-pagination'), pg.page, pg.pages, pg.total, (p) => renderConventionsTable(p));
    }

    function renderCommissionsTable(page=1){
      const search = ($('#commission-search').value || '').toLowerCase().trim();
      let items = [...state.data.commissions];
      if (search){
        items = items.filter(i => [i.number, i.designation, i.locality, i.date].some(v => String(v||'').toLowerCase().includes(search)));
      }
      items.sort((a,b) => String(b.date || b.createdAt).localeCompare(String(a.date || a.createdAt)));

      const perPage = 10;
      const pg = paginate(items, page, perPage);

      const tbody = $('#commissions-table-body');
      tbody.innerHTML = '';
      for (const r of pg.slice){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${escapeHtml(r.number)}</b></td>
          <td>${escapeHtml(r.designation)}</td>
          <td>${escapeHtml(r.locality)}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${buildTableActions('commission', r.id)}</td>
        `;
        tbody.appendChild(tr);
      }
      wireTableActionHandlers(tbody);

      renderPagination($('#commissions-pagination'), pg.page, pg.pages, pg.total, (p) => renderCommissionsTable(p));
    }

    // --- Detail modal / edit / delete ---
    function openDetail(entity, id){
      const record = getEntityById(entity, id);
      if (!record) return;
      const mapTitle = { imputation: 'Détails — Imputation', arrival: 'Détails — Courrier arrivé', convention: 'Détails — Convention', commission: 'Détails — Commission' };
      $('#detail-modal-title').textContent = mapTitle[entity] || 'Détails';

      const content = $('#detail-modal-content');
      content.innerHTML = buildDetailHtml(entity, record);

      $('#detail-modal-edit').onclick = () => {
        $('#detail-modal-backdrop').classList.remove('open');
        openEdit(entity, id);
      };

      $('#detail-modal-backdrop').classList.add('open');
      $('#detail-modal-backdrop').setAttribute('aria-hidden', 'false');
    }

    function closeDetail(){
      $('#detail-modal-backdrop').classList.remove('open');
      $('#detail-modal-backdrop').setAttribute('aria-hidden', 'true');
      // Ensure edit button is visible again for entity details
      const editBtn = $('#detail-modal-edit');
      if (editBtn) editBtn.classList.remove('is-hidden');
    }

    function buildDetailHtml(entity, r){
      const chipClass = (entity) => ({
        imputation: 'imp',
        arrival: 'arr',
        convention: 'conv',
        commission: 'comm'
      }[entity] || 'imp');

      const hero = ({ kicker, title, sub, chipsHtml }) => `
        <div class="detail-hero">
          <div style="min-width:0;">
            <div class="detail-hero__kicker">${escapeHtml(kicker)}</div>
            <div class="detail-hero__title">${escapeHtml(title)}</div>
            ${sub ? `<div class="detail-hero__sub">${escapeHtml(sub)}</div>` : ''}
          </div>
          <div class="detail-hero__chips">${chipsHtml || ''}</div>
        </div>
      `;

      const item = (label, value, full=false) => `
        <div class="detail-item ${full ? 'detail-item--full' : ''}">
          <div class="detail-label">${escapeHtml(label)}</div>
          <div class="detail-value">${escapeHtml(value || '—')}</div>
        </div>
      `;

      const mkChip = (cls, icon, text) => `
        <span class="detail-chip ${cls}"><i class="${escapeHtml(icon)}"></i><b>${escapeHtml(text)}</b></span>
      `;

      if (entity === 'imputation'){
        const chips = [
          mkChip(chipClass(entity), 'ri-mail-send-fill', r.number || '—'),
          r.type ? mkChip(chipClass(entity), 'ri-bookmark-3-line', r.type) : '',
          r.agent ? mkChip(chipClass(entity), 'ri-user-3-line', r.agent) : '',
          r.imputationDate ? mkChip(chipClass(entity), 'ri-calendar-2-line', fmtDate(r.imputationDate)) : ''
        ].join('');

        return `
          ${hero({
            kicker: 'Imputation',
            title: r.mailObject || r.number || 'Détails',
            sub: (r.structure ? `${r.structure}` : '') + (r.mailNumber ? ` • Courrier: ${r.mailNumber}` : ''),
            chipsHtml: chips
          })}
          <div class="detail-grid">
            ${item('Numéro d’imputation', r.number)}
            ${item('Date d’imputation', fmtDate(r.imputationDate))}
            ${item('Numéro du courrier', r.mailNumber)}
            ${item("Date d’arrivée", fmtDate(r.arrivalDate))}
            ${item('Structure', r.structure)}
            ${item('Type', r.type)}
            ${item('Agent', r.agent)}
            ${item('Objet du courrier', r.mailObject, true)}
            ${item("Objet de l’imputation", r.imputationObject, true)}
          </div>
        `;
      }

      if (entity === 'arrival'){
        const chips = [
          mkChip(chipClass(entity), 'ri-mail-open-fill', r.number || '—'),
          r.date ? mkChip(chipClass(entity), 'ri-calendar-2-line', fmtDate(r.date)) : '',
          r.sender ? mkChip(chipClass(entity), 'ri-user-3-line', r.sender) : ''
        ].join('');

        return `
          ${hero({
            kicker: 'Courrier arrivé',
            title: r.object || r.number || 'Détails',
            sub: r.sender ? `Expéditeur: ${r.sender}` : '',
            chipsHtml: chips
          })}
          <div class="detail-grid">
            ${item('Numéro d’arrivée', r.number)}
            ${item('Date d’arrivée', fmtDate(r.date))}
            ${item('Expéditeur', r.sender)}
            ${item('N° CAB', r.cabNumber || '—')}
            ${item('Date CAB', r.cabDate ? fmtDate(r.cabDate) : '—')}
            ${item('N° DUDU', r.duduNumber || '—')}
            ${item('Date DUDU', r.duduDate ? fmtDate(r.duduDate) : '—')}
            ${item('N° PCE', r.pceNumber || '—')}
            ${item('Date PCE', r.pceDate ? fmtDate(r.pceDate) : '—')}
            ${item('Objet du courrier', r.object, true)}
          </div>
        `;
      }

      if (entity === 'convention'){
        const chips = [
          mkChip(chipClass(entity), 'ri-contract-fill', r.number || '—'),
          r.type ? mkChip(chipClass(entity), 'ri-bookmark-3-line', r.type) : '',
          (r.superficie ? mkChip(chipClass(entity), 'ri-ruler-line', `${r.superficie} ha`) : '' )
        ].join('');

        return `
          ${hero({
            kicker: 'Convention',
            title: r.designation || r.number || 'Détails',
            sub: (r.ville ? `${r.ville}` : '') + (r.village ? ` • ${r.village}` : ''),
            chipsHtml: chips
          })}
          <div class="detail-grid">
            ${item('Numéro', r.number)}
            ${item('Type', r.type)}
            ${item('Ville', r.ville)}
            ${item('Village', r.village || '—')}
            ${item('Superficie (ha)', (r.superficie === null || r.superficie === undefined) ? '—' : String(r.superficie))}
            ${item('Désignation', r.designation, true)}
            ${item('Projet', r.projet, true)}
          </div>
        `;
      }

      if (entity === 'commission'){
        const chips = [
          mkChip(chipClass(entity), 'ri-organization-chart', r.number || '—'),
          r.date ? mkChip(chipClass(entity), 'ri-calendar-2-line', fmtDate(r.date)) : '',
          r.locality ? mkChip(chipClass(entity), 'ri-map-pin-line', r.locality) : ''
        ].join('');

        return `
          ${hero({
            kicker: 'Commission',
            title: r.designation || r.number || 'Détails',
            sub: r.locality ? `Localité: ${r.locality}` : '',
            chipsHtml: chips
          })}
          <div class="detail-grid">
            ${item('Numéro', r.number)}
            ${item('Date', fmtDate(r.date))}
            ${item('Localité', r.locality)}
            ${item('Désignation', r.designation, true)}
            ${item('Description', r.description, true)}
            ${item('Membres', r.members, true)}
          </div>
        `;
      }

      return '<div style="color:var(--muted2)">Aucun détail.</div>';
    }

    function getEntityById(entity, id){
      const map = {
        imputation: state.data.imputations,
        arrival: state.data.arrivals,
        convention: state.data.conventions,
        commission: state.data.commissions
      };
      return (map[entity] || []).find(x => x.id === id);
    }

    function openEdit(entity, id){
      const r = getEntityById(entity, id);
      if (!r) return;
      if (!requireAdmin('La modification')) return;

      if (entity === 'imputation'){
        $('#imputation-edit-id').value = r.id;
        $('#imputation-number').value = r.number || '';
        $('#imputation-date').value = r.imputationDate || '';
        $('#mail-number').value = r.mailNumber || '';
        $('#arrival-date').value = r.arrivalDate || '';
        $('#mail-object').value = r.mailObject || '';
        $('#imputation-object').value = r.imputationObject || '';
        $('#structure').value = r.structure || '';
        $('#imputation-type').value = r.type || '';
        $('#agent').value = r.agent || '';
        activateSection('imputation-form');
      }

      if (entity === 'arrival'){
        $('#arrival-edit-id').value = r.id;
        $('#arrival-number').value = r.number || '';
        $('#arrival-date-input').value = r.date || '';
        $('#cab-number').value = r.cabNumber || '';
        $('#cab-date').value = r.cabDate || '';
        $('#dudu-number').value = r.duduNumber || '';
        $('#dudu-date').value = r.duduDate || '';
        $('#pce-number').value = r.pceNumber || '';
        $('#pce-date').value = r.pceDate || '';
        $('#sender').value = r.sender || '';
        $('#arrival-object').value = r.object || '';
        activateSection('arrival-form');
      }

      if (entity === 'convention'){
        $('#convention-edit-id').value = r.id;
        $('#convention-number').value = r.number || '';
        $('#designation').value = r.designation || '';
        $('#ville').value = r.ville || '';
        $('#village').value = r.village || '';
        $('#superficie').value = (r.superficie === null || r.superficie === undefined) ? '' : r.superficie;
        $('#convention-type').value = r.type || '';
        $('#projet').value = r.projet || '';
        activateSection('convention-form');
      }

      if (entity === 'commission'){
        $('#commission-edit-id').value = r.id;
        $('#commission-number').value = r.number || '';
        $('#commission-designation').value = r.designation || '';
        $('#commission-locality').value = r.locality || '';
        $('#commission-date').value = r.date || '';
        $('#commission-description').value = r.description || '';
        $('#members').value = r.members || '';
        activateSection('commission-form');
      }
    }

    function confirmDelete(entity, id){
      if (!requireAdmin('La suppression')) return;
      const r = getEntityById(entity, id);
      if (!r) return;

      $('#confirm-modal-title').textContent = 'Confirmer la suppression';
      $('#confirm-modal-message').textContent = `Supprimer définitivement: ${r.number || r.designation || r.sender || id} ?`;
      state.confirmAction = () => {
        deleteEntity(entity, id);
        closeConfirm();
      };

      $('#confirm-modal-backdrop').classList.add('open');
      $('#confirm-modal-backdrop').setAttribute('aria-hidden','false');
    }

    function closeConfirm(){
      $('#confirm-modal-backdrop').classList.remove('open');
      $('#confirm-modal-backdrop').setAttribute('aria-hidden','true');
      state.confirmAction = null;
    }

    function deleteEntity(entity, id){
      const map = {
        imputation: 'imputations',
        arrival: 'arrivals',
        convention: 'conventions',
        commission: 'commissions'
      };
      const key = map[entity];
      if (!key) return;
      const before = state.data[key].length;
      state.data[key] = state.data[key].filter(x => x.id !== id);
      const after = state.data[key].length;
      if (after !== before){
        persistAllData();

        // Synchronisation des compteurs (jour/mois) + badges
        updateBadgesAndStats();

        // Rafraîchissement de la liste correspondante (si visible)
        if (entity === 'imputation') renderImputationsTable();
        if (entity === 'arrival') renderArrivalsTable();
        if (entity === 'convention') renderConventionsTable();
        if (entity === 'commission') renderCommissionsTable();

        // Rafraîchir le dashboard (cartes récentes + graphiques)
        renderDashboard();

        addActivity('Suppression', `Suppression d'un élément (${entity}).`);
        toastAction('delete', 'Supprimé', 'Suppression effectuée avec succès.');
      }
    }

    // --- Form submit handlers ---
    function resetImputationForm(){
      $('#imputation-edit-id').value = '';
      $('#imputation-form').reset();
    }

    function resetArrivalForm(){
      $('#arrival-edit-id').value = '';
      $('#arrival-form').reset();
    }

    function resetConventionForm(){
      $('#convention-edit-id').value = '';
      $('#convention-form').reset();
    }

    function resetCommissionForm(){
      $('#commission-edit-id').value = '';
      $('#commission-form').reset();
    }

    function upsertImputation(payload){
      const id = payload.id;
      const idx = state.data.imputations.findIndex(x => x.id === id);
      if (idx >= 0) state.data.imputations[idx] = { ...state.data.imputations[idx], ...payload };
      else state.data.imputations.unshift(payload);
    }

    function upsertArrival(payload){
      const id = payload.id;
      const idx = state.data.arrivals.findIndex(x => x.id === id);
      if (idx >= 0) state.data.arrivals[idx] = { ...state.data.arrivals[idx], ...payload };
      else state.data.arrivals.unshift(payload);
    }

    function upsertConvention(payload){
      const id = payload.id;
      const idx = state.data.conventions.findIndex(x => x.id === id);
      if (idx >= 0) state.data.conventions[idx] = { ...state.data.conventions[idx], ...payload };
      else state.data.conventions.unshift(payload);
    }

    function upsertCommission(payload){
      const id = payload.id;
      const idx = state.data.commissions.findIndex(x => x.id === id);
      if (idx >= 0) state.data.commissions[idx] = { ...state.data.commissions[idx], ...payload };
      else state.data.commissions.unshift(payload);
    }

    function normalizeNumber(n){
      return String(n || '').trim();
    }

    // Pièces jointes désactivées (UI supprimée)
    function fileNameFromInput(input){
      return '';
    }

    function handleImputationSubmit(e){
      e.preventDefault();
      if (!requireAdmin("L'enregistrement")) return;

      const editId = $('#imputation-edit-id').value;
      const payload = {
        id: editId || uuid(),
        number: normalizeNumber($('#imputation-number').value),
        imputationDate: $('#imputation-date').value,
        mailNumber: normalizeNumber($('#mail-number').value),
        arrivalDate: $('#arrival-date').value,
        mailObject: normalizeNumber($('#mail-object').value),
        imputationObject: normalizeNumber($('#imputation-object').value),
        structure: normalizeNumber($('#structure').value),
        type: $('#imputation-type').value,
        agent: $('#agent').value,
        attachment: '',
        createdAt: editId ? (((getEntityById('imputation', editId) || {}).createdAt) || nowIso()) : nowIso()
      };

      // Champs non obligatoires: on autorise l'enregistrement même si certains champs sont vides.
      // (Validation minimale: au moins un identifiant ou un objet, sinon on évite d'enregistrer une ligne totalement vide)
      const anyFieldFilled = Object.keys(payload).some(k => {
        if (k === 'id' || k === 'attachment' || k === 'createdAt') return false;
        return String(payload[k] || '').trim().length > 0;
      });
      if (!anyFieldFilled){
        toast('warn', 'Formulaire vide', 'Veuillez renseigner au moins un champ avant d’enregistrer.');
        return;
      }

      const isEdit = !!editId;

      upsertImputation(payload);
      persistAllData();
      addActivity(isEdit ? 'Imputation modifiée' : 'Imputation', `${payload.number} ${isEdit ? 'modifiée' : 'enregistrée'} (${payload.type}, ${payload.agent}).`);
      toastAction(isEdit ? 'update' : 'save', isEdit ? 'Modification' : 'Enregistré', isEdit ? 'Imputation modifiée avec succès.' : 'Imputation enregistrée avec succès.');
      resetImputationForm();

      // Synchronisation immédiate: compteurs (jour/mois) + badges AVANT affichage de la liste
      updateBadgesAndStats();

      activateSection('imputation-list');
      // Force re-render pour éviter tout décalage visuel (pagination/recherche)
      renderImputationsTable();
      // Garder le dashboard prêt (au prochain retour)
      // renderDashboard() sera appelé automatiquement quand on revient sur le dashboard
    }

    function handleArrivalSubmit(e){
      e.preventDefault();
      if (!requireAdmin("L'enregistrement")) return;

      const editId = $('#arrival-edit-id').value;
      const payload = {
        id: editId || uuid(),
        number: normalizeNumber($('#arrival-number').value),
        date: $('#arrival-date-input').value,
        cabNumber: normalizeNumber($('#cab-number').value),
        cabDate: $('#cab-date').value,
        duduNumber: normalizeNumber($('#dudu-number').value),
        duduDate: $('#dudu-date').value,
        pceNumber: normalizeNumber($('#pce-number').value),
        pceDate: $('#pce-date').value,
        sender: normalizeNumber($('#sender').value),
        object: normalizeNumber($('#arrival-object').value),
        attachment: '',
        createdAt: editId ? (((getEntityById('arrival', editId) || {}).createdAt) || nowIso()) : nowIso()
      };

      // Champs non obligatoires: on autorise l'enregistrement même si certains champs sont vides.
      const anyFieldFilled = Object.keys(payload).some(k => {
        if (k === 'id' || k === 'attachment' || k === 'createdAt') return false;
        return String(payload[k] || '').trim().length > 0;
      });
      if (!anyFieldFilled){
        toast('warn', 'Formulaire vide', 'Veuillez renseigner au moins un champ avant d’enregistrer.');
        return;
      }

      const isEdit = !!editId;

      upsertArrival(payload);
      persistAllData();
      addActivity(isEdit ? 'Courrier arrivé modifié' : 'Courrier arrivé', `${payload.number} ${isEdit ? 'modifié' : 'enregistré'} (${payload.sender}).`);
      toastAction(isEdit ? 'update' : 'save', isEdit ? 'Modification' : 'Enregistré', isEdit ? 'Courrier arrivé modifié avec succès.' : 'Courrier arrivé enregistré avec succès.');
      resetArrivalForm();

      // Synchronisation immédiate: compteurs (jour/mois) + badges AVANT affichage de la liste
      updateBadgesAndStats();

      activateSection('arrival-list');
      // Force re-render pour éviter tout décalage visuel (pagination/recherche)
      renderArrivalsTable();
      // renderDashboard() sera appelé automatiquement au retour sur le dashboard
    }

    function handleConventionSubmit(e){
      e.preventDefault();
      if (!requireAdmin("L'enregistrement")) return;

      const editId = $('#convention-edit-id').value;
      const payload = {
        id: editId || uuid(),
        number: normalizeNumber($('#convention-number').value),
        designation: normalizeNumber($('#designation').value),
        ville: normalizeNumber($('#ville').value),
        village: normalizeNumber($('#village').value),
        superficie: Number($('#superficie').value),
        type: $('#convention-type').value,
        projet: normalizeNumber($('#projet').value),
        attachment: '',
        createdAt: editId ? (((getEntityById('convention', editId) || {}).createdAt) || nowIso()) : nowIso()
      };

      // Champs non obligatoires: on autorise l'enregistrement même si certains champs sont vides.
      const anyFieldFilled = Object.keys(payload).some(k => {
        if (k === 'id' || k === 'attachment' || k === 'createdAt') return false;
        // superficie: considérer 0 comme vide
        if (k === 'superficie') return Number(payload.superficie) > 0;
        return String(payload[k] || '').trim().length > 0;
      });
      if (!anyFieldFilled){
        toast('warn', 'Formulaire vide', 'Veuillez renseigner au moins un champ avant d’enregistrer.');
        return;
      }

      // Superficie optionnelle: si vide, on stocke null (pas d’erreur)
      if (!Number.isFinite(payload.superficie) || payload.superficie <= 0){
        payload.superficie = null;
      }

      const isEdit = !!editId;

      upsertConvention(payload);
      persistAllData();
      addActivity(isEdit ? 'Convention modifiée' : 'Convention', `${payload.number} ${isEdit ? 'modifiée' : 'enregistrée'} (${payload.type}).`);
      toastAction(isEdit ? 'update' : 'save', isEdit ? 'Modification' : 'Enregistré', isEdit ? 'Convention modifiée avec succès.' : 'Convention enregistrée avec succès.');
      resetConventionForm();

      // Synchronisation immédiate: compteurs (jour/mois) + badges AVANT affichage de la liste
      updateBadgesAndStats();

      activateSection('convention-list');
      // Force re-render pour éviter tout décalage visuel (pagination/recherche)
      renderConventionsTable();
      // renderDashboard() sera appelé automatiquement au retour sur le dashboard
    }

    function handleCommissionSubmit(e){
      e.preventDefault();
      if (!requireAdmin("L'enregistrement")) return;

      const editId = $('#commission-edit-id').value;
      const payload = {
        id: editId || uuid(),
        number: normalizeNumber($('#commission-number').value),
        designation: normalizeNumber($('#commission-designation').value),
        locality: normalizeNumber($('#commission-locality').value),
        date: $('#commission-date').value,
        description: normalizeNumber($('#commission-description').value),
        members: normalizeNumber($('#members').value),
        attachment: '',
        createdAt: editId ? (((getEntityById('commission', editId) || {}).createdAt) || nowIso()) : nowIso()
      };

      // Champs non obligatoires: on autorise l'enregistrement même si certains champs sont vides.
      const anyFieldFilled = Object.keys(payload).some(k => {
        if (k === 'id' || k === 'attachment' || k === 'createdAt') return false;
        return String(payload[k] || '').trim().length > 0;
      });
      if (!anyFieldFilled){
        toast('warn', 'Formulaire vide', 'Veuillez renseigner au moins un champ avant d’enregistrer.');
        return;
      }

      const isEdit = !!editId;

      upsertCommission(payload);
      persistAllData();
      addActivity(isEdit ? 'Commission modifiée' : 'Commission', `${payload.number} ${isEdit ? 'modifiée' : 'enregistrée'} (${fmtDate(payload.date)}).`);
      toastAction(isEdit ? 'update' : 'save', isEdit ? 'Modification' : 'Enregistré', isEdit ? 'Commission modifiée avec succès.' : 'Commission enregistrée avec succès.');
      resetCommissionForm();

      // Synchronisation immédiate: compteurs (jour/mois) + badges AVANT affichage de la liste
      updateBadgesAndStats();

      activateSection('commission-list');
      // Force re-render pour éviter tout décalage visuel (pagination/recherche)
      renderCommissionsTable();
      // renderDashboard() sera appelé automatiquement au retour sur le dashboard
    }

    // --- Export/Import ---
    function exportData(){
      const payload = {
        version: 1,
        exportedAt: nowIso(),
        theme: getTheme(),
        adminPw: getAdminPassword(),
        profile: loadJSON(STORAGE.profile, null),
        data: {
          imputations: state.data.imputations,
          arrivals: state.data.arrivals,
          conventions: state.data.conventions,
          commissions: state.data.commissions,
        },
        activities: loadJSON(STORAGE.activities, [])
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sdmfpippdc-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      toast('success', 'Export', 'Export JSON généré.');
    }

    function importDataFromFile(file, done){
      // Compat: utiliser FileReader plutôt que file.text() (pas supporté partout)
      done = typeof done === 'function' ? done : function(){};
      try{
        const fr = new FileReader();
        fr.onload = function(){
          let json;
          try{ json = JSON.parse(fr.result); }
          catch(e){ toast('error', 'Import', 'Fichier JSON invalide.'); done(false); return; }

          if (!json || !json.data){
            toast('error', 'Import', 'Structure de fichier non reconnue.');
            done(false);
            return;
          }

          // Apply
          if (json.theme) setTheme(json.theme);
          if (json.adminPw) setAdminPassword(json.adminPw);
          if (json.profile) saveJSON(STORAGE.profile, json.profile);

          state.data.imputations = json.data.imputations || [];
          state.data.arrivals = json.data.arrivals || [];
          state.data.conventions = json.data.conventions || [];
          state.data.commissions = json.data.commissions || [];
          persistAllData();

          if (Array.isArray(json.activities)) saveJSON(STORAGE.activities, json.activities);

          addActivity('Import', 'Import des données effectué.');
          toast('success', 'Import', 'Données importées avec succès.');
          applyAuthToUI();

          // Synchronisation immédiate des compteurs (jour/mois) + badges + dashboard
          updateBadgesAndStats();
          renderDashboard();

          done(true);
        };
        fr.onerror = function(){
          toast('error', 'Import', 'Impossible de lire le fichier.');
          done(false);
        };
        fr.readAsText(file);
      } catch(e){
        toast('error', 'Import', 'Import impossible dans ce navigateur.');
        done(false);
      }
    }

    // --- Print ---
    function printTable(title, tableEl){
      const w = window.open('', '_blank');
      if (!w){
        toast('error', 'Impression', 'Impossible d’ouvrir la fenêtre d’impression (pop-up bloquée).');
        return;
      }

      // Clone + remove action columns/buttons for a clean print
      const table = tableEl.cloneNode(true);
      try{
        const headerRow = table.querySelector('thead tr');
        const idxs = [];
        if (headerRow){
          const ths = Array.from(headerRow.children);
          ths.forEach((th, i) => {
            const t = (th.textContent || '').trim().toLowerCase();
            if (t === 'actions' || t.includes('action')) idxs.push(i);
          });
        }

        const removeIdxs = (idxList) => {
          const rows = Array.from(table.querySelectorAll('tr'));
          const sorted = [...idxList].sort((a,b) => b-a);
          rows.forEach(row => {
            sorted.forEach(i => {
              if (row.children && row.children[i]) row.children[i].remove();
            });
          });
        };

        if (idxs.length){
          removeIdxs(idxs);
        } else {
          // Fallback: if last column contains buttons/data-action, remove last column
          const firstBodyRow = table.querySelector('tbody tr');
          if (firstBodyRow && firstBodyRow.children.length){
            const lastIdx = firstBodyRow.children.length - 1;
            const maybeActions = firstBodyRow.children[lastIdx];
            if (maybeActions && maybeActions.querySelector && (maybeActions.querySelector('button') || maybeActions.querySelector('[data-action]'))){
              removeIdxs([lastIdx]);
            }
          }
        }

        // Extra safety: remove interactive remnants
        table.querySelectorAll('button, .btn-icon, [data-action]').forEach(el => el.remove());
      } catch(e){
        // If anything goes wrong, still print the table (worst case)
        try{ console.warn('[SDMFPIPPDC] print cleanup failed:', e); }catch(_e){}
      }

      const html = `
        <html>
          <head>
            <title>${escapeHtml(title)}</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <style>
              body{font-family: Arial, sans-serif; padding: 18px;}
              h1{font-size: 18px; margin:0 0 12px;}
              table{width:100%; border-collapse: collapse;}
              th, td{border: 1px solid #ddd; padding: 8px; font-size: 12px; vertical-align: top;}
              th{background:#f3f4f6; text-align:left;}
              @media print{
                a[href]{ color: #111; text-decoration: none; }
              }
            </style>
          </head>
          <body>
            <h1>${escapeHtml(title)}</h1>
            ${table.outerHTML}
          </body>
        </html>
      `;

      w.document.open();
      w.document.write(html);
      w.document.close();

      // Déclencher l'impression après chargement
      w.onload = () => {
        try{
          w.focus();
          w.print();
        } finally {
          setTimeout(() => w.close(), 250);
        }
      };
    }

    // --- Charts ---
    function getCssVar(name){
      // IMPORTANT: nos variables de thème (light/dark) sont sur body.light-theme,
      // donc il faut lire d'abord sur <body> (sinon on récupère les valeurs dark du :root).
      const fromBody = getComputedStyle(document.body).getPropertyValue(name).trim();
      if (fromBody) return fromBody;
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function destroyChart(key){
      if (state.ui.charts[key]){
        state.ui.charts[key].destroy();
        state.ui.charts[key] = null;
      }
    }

    function buildOrUpdateCharts(){
      // Ne jamais bloquer le rendu du dashboard si Chart.js n'est pas chargé
      if (typeof Chart === 'undefined') return;

      try{
        // Defaults Chart.js : améliorer la lisibilité (notamment en thème clair)
        try{
          const isLightTheme = document.body.classList.contains('light-theme');
          if (typeof Chart !== 'undefined' && Chart.defaults){
            Chart.defaults.color = isLightTheme ? 'rgba(2,6,23,.86)' : 'rgba(255,255,255,.82)';
            Chart.defaults.borderColor = isLightTheme ? 'rgba(15,23,42,.18)' : 'rgba(255,255,255,.14)';
          }
        }catch(e){}

        // if canvases not present, skip
        const impCanvas = $('#imputationsChart');
        const arrCanvas = $('#arrivalsChart');
        const convCanvas = $('#conventionsChart');
        const commCanvas = $('#commissionsChart');
        if (!impCanvas || !arrCanvas || !convCanvas || !commCanvas) return;

        // Colors based on theme
        const text = getCssVar('--text');
        const muted2 = getCssVar('--muted2');
        const stroke = getCssVar('--stroke');
        const primary = getCssVar('--primary2');
        const secondary = getCssVar('--secondary');
        const tertiary = getCssVar('--tertiary');
        const quaternary = getCssVar('--quaternary');
        const warning = getCssVar('--warning');
        const success = getCssVar('--success');

        const sparkOpts = (color) => ({
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display:false }, tooltip: { enabled:false } },
          scales: { x: { display:false }, y: { display:false } },
          elements: { point: { radius: 0 } }
        });

        const last7 = (items, field) => {
          const msDay = 24*60*60*1000;
          const now = new Date();
          const labels = [];
          const values = [];
          for (let i=6; i>=0; i--){
            const d = new Date(now.getTime() - i*msDay);
            const key = dateKey(d);
            labels.push(d.toLocaleDateString('fr-FR', { weekday:'short' }));
            values.push(items.filter(x => dateKey(x[field]) === key).length);
          }
          return { labels, values };
        };

        const imp7 = last7(state.data.imputations, 'imputationDate');
        const arr7 = last7(state.data.arrivals, 'date');
        const conv7 = (function(){
          const msDay = 24*60*60*1000;
          const now = new Date();
          const labels = [];
          const values = [];
          for (let i=6; i>=0; i--){
            const d = new Date(now.getTime() - i*msDay);
            const key = dateKey(d);
            labels.push(d.toLocaleDateString('fr-FR', { weekday:'short' }));
            values.push(state.data.conventions.filter(x => dateKey(x.createdAt) === key).length);
          }
          return { labels, values };
        })();

        // Commissions sparkline: par date de création (activité de saisie)
        const comm7 = last7(state.data.commissions, 'createdAt');

        const toRgba = (color, alpha) => {
          alpha = (alpha === undefined ? .12 : alpha);
          const c = String(color || '').trim();

          // rgb/rgba
          if (c.indexOf('rgb') === 0){
            const parts = c.match(/\d+/g) || [];
            const r = Number(parts[0] || 124);
            const g = Number(parts[1] || 58);
            const b = Number(parts[2] || 237);
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
          }

          // hex: #rgb or #rrggbb
          if (c[0] === '#'){
            let hex = c.slice(1);
            if (hex.length === 3){
              hex = hex.split('').map(ch => ch + ch).join('');
            }
            if (hex.length === 6){
              const r = parseInt(hex.slice(0,2), 16);
              const g = parseInt(hex.slice(2,4), 16);
              const b = parseInt(hex.slice(4,6), 16);
              if ([r,g,b].every(n => Number.isFinite(n))){
                return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
              }
            }
          }

          // fallback
          return 'rgba(37,99,235,' + alpha + ')';
        };

        const createSpark = (key, canvas, data, strokeColor, fillColor) => {
          if (!canvas || !canvas.getContext) return;
          destroyChart(key);
          const ctx = canvas.getContext('2d');
          if (!ctx) return;
          state.ui.charts[key] = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.values,
                borderColor: strokeColor,
                borderWidth: 2,
                tension: .35,
                fill: true,
                backgroundColor: fillColor
              }]
            },
            options: sparkOpts(strokeColor)
          });
        };

        createSpark('impSpark', impCanvas, imp7, primary, toRgba(primary, .18));
        createSpark('arrSpark', arrCanvas, arr7, secondary, toRgba(secondary, .16));
        createSpark('convSpark', convCanvas, conv7, tertiary, toRgba(tertiary, .16));
        createSpark('commSpark', commCanvas, comm7, quaternary, toRgba(quaternary, .16));

        // contentieux doughnut supprimé (nouvelle carte sans cercle)
        destroyChart('contentieux');

        // mobilisation doughnut supprimé (nouvelle carte sans cercle)
        destroyChart('mobilisation');

        // activity chart (synchronisé avec les LISTES)
        // 4 séries distinctes: imputations / arrivées / conventions / commissions
        const activityCanvas = $('#activityChart');
        if (activityCanvas && activityCanvas.getContext){
          const ctx = activityCanvas.getContext('2d');
          if (ctx){
            destroyChart('activity');
            const msDay = 24*60*60*1000;
            const now = new Date();
            const labels = [];

            const series = {
              imp: [],
              arr: [],
              conv: [],
              comm: []
            };

            const days = Number(state.ui.dashRangeDays || 30);
            for (let i=days-1; i>=0; i--){
              const d = new Date(now.getTime() - i*msDay);
              const key = dateKey(d);
              labels.push(d.toLocaleDateString('fr-FR', { day:'2-digit', month:'short' }));

              series.imp.push(state.data.imputations.filter(x => dateKey(x.imputationDate) === key).length);
              series.arr.push(state.data.arrivals.filter(x => dateKey(x.date) === key).length);
              series.conv.push(state.data.conventions.filter(x => dateKey(x.createdAt) === key).length);
              // Graph commissions: activité récente par date de création (cohérent avec les compteurs jour/mois)
              series.comm.push(state.data.commissions.filter(x => dateKey(x.createdAt) === key).length);
            }

            // Legend totals: total global (synchronisé avec les listes)
            const setLegend = (id, v) => { const el = $(id); if (el) el.textContent = String(v); };
            setLegend('#legend-imp', state.data.imputations.length);
            setLegend('#legend-arr', state.data.arrivals.length);
            setLegend('#legend-conv', state.data.conventions.length);
            setLegend('#legend-comm', state.data.commissions.length);

            // Premium style: lines + gradient fills + distinct styles
            const maxXTicks = days <= 14 ? 14 : (days <= 30 ? 10 : 8);
            const suggestedMax = Math.max(3, ...series.imp, ...series.arr, ...series.conv, ...series.comm);
            const isLightTheme = document.body.classList.contains('light-theme');
            // Lisibilité: en thème clair, on augmente le contraste des ticks/grilles
            const tickColor = toRgba(text, isLightTheme ? 0.86 : 0.78);
            const gridColor = toRgba(stroke, isLightTheme ? 0.34 : 0.20);

            const mk = (label, data, colorVar, fillAlpha, dash=[]) => {
              const c = getCssVar(colorVar) || primary;
              const grad = ctx.createLinearGradient(0, 0, 0, 320);
              grad.addColorStop(0, toRgba(c, fillAlpha));
              grad.addColorStop(1, toRgba(c, 0));
              const showPoints = days <= 30;
              return {
                label,
                data,
                borderColor: toRgba(c, .95),
                backgroundColor: grad,
                fill: true,
                tension: .36,
                borderWidth: 2.5,
                borderDash: dash,
                pointRadius: showPoints ? 1.6 : 0,
                pointHoverRadius: 4,
                pointHitRadius: 10,
                pointBackgroundColor: toRgba(c, .95),
                pointBorderColor: toRgba(c, 1),
                pointBorderWidth: 0
              };
            };

            state.ui.charts.activity = new Chart(ctx, {
              type: 'line',
              data: {
                labels,
                datasets: [
                  mk('Imputations', series.imp, '--primary2', .20, []),
                  mk('Arrivées', series.arr, '--secondary', .18, []),
                  mk('Conventions', series.conv, '--tertiary', .18, [6,4]),
                  mk('Commissions', series.comm, '--quaternary', .18, [2,4])
                ]
              },
              options: {
                responsive:true,
                maintainAspectRatio:false,
                animation: { duration: 650, easing: 'easeOutQuart' },
                interaction: { mode: 'index', intersect: false },
                layout: { padding: { left: 8, right: 10, top: 8, bottom: 0 } },
                plugins:{
                  legend:{ display:false },
                  tooltip:{
                    enabled:true,
                    // Tooltip lisible dans les 2 thèmes
                    backgroundColor: (document.body.classList.contains('light-theme')
                      ? 'rgba(15,23,42,.94)'
                      : toRgba(getCssVar('--panel2') || '#12233b', .97)
                    ),
                    titleColor: document.body.classList.contains('light-theme') ? 'rgba(255,255,255,.95)' : toRgba(text, .96),
                    bodyColor: document.body.classList.contains('light-theme') ? 'rgba(255,255,255,.90)' : toRgba(text, .92),
                    borderColor: document.body.classList.contains('light-theme') ? 'rgba(15,23,42,.20)' : toRgba(stroke, .55),
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    usePointStyle: true
                  }
                },
                scales:{
                  x:{
                    ticks:{
                      color: tickColor,
                      font: { size: 11, weight: '800' },
                      autoSkip: true,
                      maxTicksLimit: maxXTicks,
                      maxRotation: 0,
                      padding: 6
                    },
                    grid:{ color: gridColor, drawBorder:false, tickLength: 0 }
                  },
                  y:{
                    beginAtZero:true,
                    suggestedMax,
                    ticks:{
                      color: tickColor,
                      font: { size: 11, weight: '800' },
                      precision: 0,
                      padding: 6,
                      callback: (v) => String(Math.round(v))
                    },
                    grid:{ color: gridColor, drawBorder:false }
                  }
                }
              }
            });

            // Update hint to match range
            updateDashRangeUI();
          }
        }
      } catch (e){
        // Ne jamais casser le dashboard à cause d'un graphique
        try{ console.warn('[SDMFPIPPDC] Charts skipped:', e); }catch(_e){}
      }
    }

    // --- Global search ---
    function runGlobalSearch(q){
      const query = String(q || '').trim();
      if (!query) return;

      // heuristic: if starts with IMP/ARR/CONV/COMM, go to right list
      const up = query.toUpperCase();
      if (up.startsWith('IMP')){
        activateSection('imputation-list');
        $('#imputation-search').value = query;
        renderImputationsTable();
        return;
      }
      if (up.startsWith('ARR')){
        activateSection('arrival-list');
        $('#arrival-search').value = query;
        renderArrivalsTable();
        return;
      }
      if (up.startsWith('CONV')){
        activateSection('convention-list');
        $('#convention-search').value = query;
        renderConventionsTable();
        return;
      }
      if (up.startsWith('COMM')){
        activateSection('commission-list');
        $('#commission-search').value = query;
        renderCommissionsTable();
        return;
      }

      // fallback: imputation list
      activateSection('imputation-list');
      $('#imputation-search').value = query;
      renderImputationsTable();
    }

    // --- Profile ---
    function setProfilePhoto(file, done){
      done = typeof done === 'function' ? done : function(){};
      try{
        const fr = new FileReader();
        fr.onload = function(){
          const dataUrl = fr.result;
          const profile = loadJSON(STORAGE.profile, { name:'', email:'', phone:'', avatar:'' });
          profile.avatar = dataUrl;
          saveJSON(STORAGE.profile, profile);
          applyAuthToUI();
          toast('success', 'Profil', 'Photo de profil mise à jour.');
          done(true);
        };
        fr.onerror = function(){
          toast('error', 'Profil', 'Impossible de lire l’image.');
          done(false);
        };
        fr.readAsDataURL(file);
      } catch(e){
        toast('error', 'Profil', 'Mise à jour impossible dans ce navigateur.');
        done(false);
      }
    }

    function saveProfile(){
      if (!requireAdmin('La modification du profil')) return;
      const profile = loadJSON(STORAGE.profile, { name:'', email:'', phone:'', avatar:'' });
      profile.name = $('#profile-name').value.trim() || profile.name;
      profile.email = $('#profile-email').value.trim() || profile.email;
      profile.phone = $('#profile-phone').value.trim();
      saveJSON(STORAGE.profile, profile);
      applyAuthToUI();
      addActivity('Profil', 'Profil mis à jour');
      toast('success', 'Profil', 'Profil enregistré.');
    }

    function updatePassword(e){
      e.preventDefault();
      if (!requireAdmin('La mise à jour du mot de passe')) return;

      const current = $('#current-password').value;
      const next = $('#new-password').value;
      const confirm = $('#confirm-password').value;
      if (!current || !next || !confirm){
        toast('error', 'Mot de passe', 'Veuillez remplir tous les champs.');
        return;
      }
      if (current !== getAdminPassword()){
        toast('error', 'Mot de passe', 'Mot de passe actuel incorrect.');
        return;
      }
      if (next.length < 6){
        toast('warn', 'Mot de passe', 'Utilisez au moins 6 caractères (démo).');
        return;
      }
      if (next !== confirm){
        toast('error', 'Mot de passe', 'La confirmation ne correspond pas.');
        return;
      }
      setAdminPassword(next);
      $('#security-form').reset();
      addActivity('Sécurité', 'Mot de passe administrateur mis à jour');
      toast('success', 'Mot de passe', 'Mot de passe mis à jour.');
    }

    // --- Init bindings ---
    // Sécurité: si une erreur survient, ne pas rester bloqué sur l'overlay
    window.addEventListener('error', (e) => {
      const ov = $('#loadingOverlay');
      if (ov) ov.classList.add('is-hidden');
      console.error('Global error:', e.error || e.message);
    });
    window.addEventListener('unhandledrejection', (e) => {
      const ov = $('#loadingOverlay');
      if (ov) ov.classList.add('is-hidden');
      console.error('Unhandled promise rejection:', e.reason);
    });

    function bindUI(){
      // Prevent double-binding (important when fallback boot triggers)
      if (state.ui.__bound) return;
      state.ui.__bound = true;
      try{
      // Navigation
      $$('.nav__link[data-section]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          activateSection(a.getAttribute('data-section'));
        });
      });

      $$('.btn.btn--link[data-section]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          activateSection(a.getAttribute('data-section'));
        });
      });

      $$('.dropdown__link[data-section]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          activateSection(a.getAttribute('data-section'));
          $('#profile-dropdown').classList.remove('open');
        });
      });

      // Sidebar toggles
      $('#menu-toggle').addEventListener('click', openMobileSidebar);
      $('#sidebar-toggle-mobile').addEventListener('click', closeMobileSidebar);
      $('#sidebar-backdrop').addEventListener('click', closeMobileSidebar);

      // Desktop: init + toggle
      const sb = $('#sidebar');
      const sbBtn = $('#sidebar-desktop-toggle');
      if (sb && sbBtn){
        sbBtn.classList.toggle('is-collapsed', sb.classList.contains('sidebar--collapsed'));
        syncSidebarToggleVar();
        sbBtn.addEventListener('click', toggleDesktopSidebar);
      }

      // Selects: chevrons + native color-scheme (dark/light)
      enhanceSelects();
      initCustomSelects();
      syncColorSchemeToControls();

      // Dropdowns (robuste): placement fixed, hauteur calculée, mode "sheet" sur mobile
      const positionDropdown = (triggerEl, dropdownEl, opts={}) => {
        if (!triggerEl || !dropdownEl) return;
        const gap = Number.isFinite(opts.gap) ? opts.gap : 10;
        const align = opts.align || 'right';
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const isMobile = vw <= 880;

        // Make sure it's measurable
        dropdownEl.style.visibility = 'hidden';
        dropdownEl.style.display = 'flex';
        dropdownEl.style.flexDirection = 'column';

        // Reset any previous sheet/inline styles that can cause clipping
        dropdownEl.classList.remove('dropdown-sheet');
        dropdownEl.style.position = 'fixed';
        dropdownEl.style.left = '';
        dropdownEl.style.top = '';
        dropdownEl.style.right = '';
        dropdownEl.style.bottom = '';
        dropdownEl.style.width = '';
        dropdownEl.style.maxWidth = '';
        dropdownEl.style.maxHeight = '';

        // Mobile: open as a bottom-sheet for perfect fit
        if (isMobile){
          dropdownEl.classList.add('dropdown-sheet');
          dropdownEl.style.visibility = '';
          return;
        }

        const tr = triggerEl.getBoundingClientRect();
        const safePad = 10;

        // Width
        const maxW = Math.min(380, vw - safePad*2);
        dropdownEl.style.maxWidth = maxW + 'px';

        // Compute available space
        const belowTop = tr.bottom + gap;
        const aboveAvail = (tr.top - gap) - safePad;
        const belowAvail = (vh - safePad) - belowTop;
        const preferBelow = belowAvail >= 260 || belowAvail >= aboveAvail;

        // Max height based on available space (never less than 220)
        const avail = preferBelow ? belowAvail : aboveAvail;
        dropdownEl.style.maxHeight = Math.max(220, Math.min(560, avail)) + 'px';

        // Force reflow after constraints
        const dr = dropdownEl.getBoundingClientRect();

        // X position
        let left;
        if (align === 'left') left = tr.left;
        else left = tr.right - dr.width;
        left = clamp(left, safePad, vw - dr.width - safePad);

        // Y position
        let top;
        if (preferBelow){
          top = belowTop;
          top = Math.min(top, vh - dr.height - safePad);
          top = Math.max(safePad, top);
        } else {
          top = tr.top - gap - dr.height;
          top = Math.max(safePad, top);
        }

        dropdownEl.style.left = Math.round(left) + 'px';
        dropdownEl.style.top = Math.round(top) + 'px';
        dropdownEl.style.visibility = '';
      };

      const notifTrigger = $('#notifications-trigger');
      const notifDrop = $('#notifications-dropdown');
      const profileTrigger = $('#header-profile');
      const profileDrop = $('#profile-dropdown');
      const ddBackdrop = $('#dropdown-backdrop');

      // IMPORTANT: portal dropdowns/backdrop to <body> so they are never clipped by sticky/animated ancestors.
      const portalToBody = (el) => {
        if (!el || el._ported) return;
        el._ported = true;
        document.body.appendChild(el);
      };
      portalToBody(ddBackdrop);
      portalToBody(notifDrop);
      portalToBody(profileDrop);

      // Prevent clicks inside dropdown from toggling/closing
      if (notifDrop) notifDrop.addEventListener('click', (e) => e.stopPropagation());
      if (profileDrop) profileDrop.addEventListener('click', (e) => e.stopPropagation());

      const resetDropdownInlinePos = (el) => {
        if (!el) return;
        el.classList.remove('dropdown-sheet');
        el.style.position = '';
        el.style.left = '';
        el.style.top = '';
        el.style.right = '';
        el.style.bottom = '';
        el.style.width = '';
        el.style.maxWidth = '';
        el.style.maxHeight = '';
      };

      const closeAllDropdowns = () => {
        if (notifDrop){
          notifDrop.classList.remove('open');
          notifDrop.style.display = '';
          notifDrop.style.visibility = '';
          resetDropdownInlinePos(notifDrop);
        }
        if (profileDrop){
          profileDrop.classList.remove('open');
          profileDrop.style.display = '';
          profileDrop.style.visibility = '';
          resetDropdownInlinePos(profileDrop);
        }
        if (ddBackdrop){
          ddBackdrop.classList.remove('open');
          ddBackdrop.setAttribute('aria-hidden','true');
        }
        document.body.classList.remove('dropdown-open');
      };

      const openDropdown = (trigger, drop) => {
        if (!drop || !trigger) return;
        // Ensure visible for positioning
        drop.style.display = 'flex';
        drop.style.flexDirection = 'column';
        drop.style.visibility = '';
        drop.classList.add('open');

        if (ddBackdrop){
          ddBackdrop.classList.add('open');
          ddBackdrop.setAttribute('aria-hidden','false');
        }

        positionDropdown(trigger, drop, { align: 'right', gap: 10 });

        // In mobile sheet mode, lock background scroll
        if (window.innerWidth <= 880) document.body.classList.add('dropdown-open');
      };

      if (notifTrigger){
        notifTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          const willOpen = !notifDrop.classList.contains('open');
          closeAllDropdowns();
          if (willOpen){
            // When opening the dropdown, mark all as "seen" (decrease badge)
            (state.ui.notifications || []).forEach(n => { if (n.unread) n.unread = false; });
            renderNotifications();
            openDropdown(notifTrigger, notifDrop);
          }
        });
      }

      if (profileTrigger){
        profileTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          const willOpen = !profileDrop.classList.contains('open');
          closeAllDropdowns();
          if (willOpen) openDropdown(profileTrigger, profileDrop);
        });
      }

      if (ddBackdrop){
        ddBackdrop.addEventListener('click', () => closeAllDropdowns());
      }

      // Init notifications + badge
      initNotifications();

      // Delegated click handler for notifications items
      const notifListEl = $('#notifications-list');
      if (notifListEl){
        notifListEl.addEventListener('click', (e) => {
          const item = e.target.closest('.notification__item');
          if (!item) return;
          const id = item.getAttribute('data-id');
          if (id) openNotificationDetail(id);
        });
      }

      // Keep dropdowns positioned on resize (desktop only; mobile uses sheet)
      const repositionOpenDropdowns = () => {
        if (notifDrop && notifDrop.classList.contains('open')) positionDropdown(notifTrigger, notifDrop, { align: 'right', gap: 10 });
        if (profileDrop && profileDrop.classList.contains('open')) positionDropdown(profileTrigger, profileDrop, { align: 'right', gap: 10 });
      };
      window.addEventListener('resize', repositionOpenDropdowns);

      document.addEventListener('click', (e) => {
        if (notifDrop && notifTrigger){
          if (!notifDrop.contains(e.target) && !notifTrigger.contains(e.target)){
            closeAllDropdowns();
          }
        }
        if (profileDrop && profileTrigger){
          if (!profileDrop.contains(e.target) && !profileTrigger.contains(e.target)){
            closeAllDropdowns();
          }
        }
      });

      $('#mark-notifications-read').addEventListener('click', () => {
        markAllNotificationsRead();
      });

      // Theme
      // Fix: éviter le double toggle (clic sur le switch déclenchait aussi le clic du conteneur)
      const toggleTheme = () => setTheme(getTheme() === 'dark' ? 'light' : 'dark');

      const themeRow = $('#theme-toggle');
      if (themeRow) themeRow.addEventListener('click', () => toggleTheme());

      const sbSwitch = $('#sidebar-theme-switch');
      if (sbSwitch) sbSwitch.addEventListener('click', (e) => { e.stopPropagation(); toggleTheme(); });

      const dmSwitch = $('#dark-mode-toggle');
      if (dmSwitch) dmSwitch.addEventListener('click', (e) => { e.stopPropagation(); toggleTheme(); });

      // Auth toggles
      $('#auth-toggle-btn').addEventListener('click', () => {
        if (state.user.isAdmin) logout();
        else openLogin();
      });
      $('#dropdown-logout').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
        closeAllDropdowns();
      });

      const dropLogin = $('#dropdown-login');
      if (dropLogin){
        dropLogin.addEventListener('click', (e) => {
          e.preventDefault();
          closeAllDropdowns();
          openLogin();
        });
      }

      // CapsLock hint (UX)
      const pwInput = $('#login-password');
      const capsHint = $('#caps-hint');
      if (pwInput && capsHint){
        const updateCaps = (e) => {
          try{
            const on = e && typeof e.getModifierState === 'function' ? e.getModifierState('CapsLock') : false;
            capsHint.style.display = on ? 'block' : 'none';
          } catch(err){
            capsHint.style.display = 'none';
          }
        };
        pwInput.addEventListener('keyup', updateCaps);
        pwInput.addEventListener('keydown', updateCaps);
        pwInput.addEventListener('focus', (e) => updateCaps(e));
        pwInput.addEventListener('blur', () => { capsHint.style.display = 'none'; });
      }

      $('#login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const u = $('#login-username').value;
        const p = $('#login-password').value;
        const ok = login(u, p);
        if (!ok){
          $('#login-error').textContent = 'Identifiant ou mot de passe incorrect.';
          const card = $('.login-card', $('#login-screen'));
          if (card){
            card.classList.remove('shake');
            // restart animation
            void card.offsetWidth;
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 520);
          }
          toast('error', 'Connexion', 'Échec de connexion.');
          return;
        }
        closeLogin();
      });

      const loginCancel = $('#login-cancel');
      if (loginCancel){
        loginCancel.addEventListener('click', () => {
          closeLogin();
          toast('info', 'Mode invité', 'Vous restez en mode invité.');
        });
      }

      // Close login on backdrop click (only if clicking outside card)
      $('#login-screen').addEventListener('click', (e) => {
        if (e.target.id === 'login-screen') closeLogin();
      });

      // Toast close
      $('#toast-close').addEventListener('click', () => $('#toast-notification').classList.remove('show'));

      // Detail modal
      $('#detail-modal-close').addEventListener('click', closeDetail);
      $('#detail-modal-close-footer').addEventListener('click', closeDetail);
      $('#detail-modal-backdrop').addEventListener('click', (e) => {
        if (e.target.id === 'detail-modal-backdrop') closeDetail();
      });

      // Confirm modal
      $('#confirm-cancel-btn').addEventListener('click', closeConfirm);
      $('#confirm-modal-backdrop').addEventListener('click', (e) => {
        if (e.target.id === 'confirm-modal-backdrop') closeConfirm();
      });
      $('#confirm-validate-btn').addEventListener('click', () => {
        if (typeof state.confirmAction === 'function') state.confirmAction();
      });

      // Activity feed
      $('#activity-feed-trigger').addEventListener('click', () => {
        const feed = $('#activity-feed');
        const willOpen = !feed.classList.contains('open');
        feed.classList.toggle('open');
        renderActivities();
        // When opening the feed, mark all as seen (badge decreases)
        if (willOpen) markAllActivitiesRead(true);
      });
      $('#open-activity-feed').addEventListener('click', () => {
        const feed = $('#activity-feed');
        feed.classList.add('open');
        renderActivities();
        markAllActivitiesRead(true);
      });
      $('#activity-feed-close').addEventListener('click', () => $('#activity-feed').classList.remove('open'));

      // Click on activity to open details
      $('#activity-feed-content').addEventListener('click', (e) => {
        const item = e.target.closest('.activity-item');
        if (!item) return;
        const id = item.getAttribute('data-id');
        if (id) openActivityDetail(id);
      });

      $('#clear-activities').addEventListener('click', () => {
        if (!requireAdmin('La suppression des activités')) return;
        saveJSON(STORAGE.activities, []);
        renderActivities();
        toast('success', 'Activités', 'Historique effacé.');
      });

      // Dashboard range selector
      const rangeTrigger = $('#dash-range-trigger');
      const rangeMenu = $('#dash-range-menu');
      const openRangeMenu = () => {
        if (!rangeTrigger || !rangeMenu) return;
        // Close header dropdowns to avoid overlap
        try{ closeHeaderDropdowns(); }catch(e){}

        rangeMenu.classList.add('open');
        // position under trigger
        const r = rangeTrigger.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const safe = 10;

        // Make measurable
        rangeMenu.style.visibility = 'hidden';
        rangeMenu.style.display = 'block';
        const mr = rangeMenu.getBoundingClientRect();

        let left = r.right - mr.width;
        left = clamp(left, safe, vw - mr.width - safe);
        let top = r.bottom + 10;
        if (top + mr.height > vh - safe){
          top = Math.max(safe, r.top - 10 - mr.height);
        }
        rangeMenu.style.left = Math.round(left) + 'px';
        rangeMenu.style.top = Math.round(top) + 'px';
        rangeMenu.style.visibility = '';

        updateDashRangeUI();
      };
      const closeRangeMenu = () => {
        if (!rangeMenu) return;
        rangeMenu.classList.remove('open');
        rangeMenu.style.left = '';
        rangeMenu.style.top = '';
        rangeMenu.style.visibility = '';
        rangeMenu.style.display = '';
      };

      if (rangeTrigger && rangeMenu){
        rangeTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          const willOpen = !rangeMenu.classList.contains('open');
          closeRangeMenu();
          if (willOpen) openRangeMenu();
        });
        rangeTrigger.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            const willOpen = !rangeMenu.classList.contains('open');
            closeRangeMenu();
            if (willOpen) openRangeMenu();
          }
        });

        $$('.range-option', rangeMenu).forEach(btn => {
          btn.addEventListener('click', () => {
            const days = Number(btn.getAttribute('data-days') || 30);
            state.ui.dashRangeDays = days;
            updateDashRangeUI();
            closeRangeMenu();
            // Update charts + dashboard views (legend/graph)
            buildOrUpdateCharts();
          });
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!rangeMenu.classList.contains('open')) return;
          if (rangeMenu.contains(e.target) || rangeTrigger.contains(e.target)) return;
          closeRangeMenu();
        }, true);

        window.addEventListener('resize', () => {
          if (rangeMenu.classList.contains('open')) openRangeMenu();
        });
      }

      // Dashboard buttons
      $('#btn-refresh-dashboard').addEventListener('click', () => {
        loadAllData();
        renderDashboard();
        toast('success', 'Tableau de bord', 'Données actualisées.');
      });
      $('#btn-new').addEventListener('click', () => {
        if (!state.user.isAdmin){
          toast('warn', 'Connexion requise', 'Connectez-vous en administrateur pour créer de nouvelles saisies.');
          openLogin();
          return;
        }
        // quick action: go to imputation form
        activateSection('imputation-form');
        toast('info', 'Nouveau', "Remplissez le formulaire pour créer une nouvelle imputation.");
      });

      // dashboard recent refresh
      $('#refresh-recent-imputations').addEventListener('click', () => renderDashboard());
      $('#refresh-recent-arrivals').addEventListener('click', () => renderDashboard());
      $('#refresh-dashboard-commissions').addEventListener('click', () => renderDashboard());
      $('#more-imputations').addEventListener('click', () => activateSection('imputation-list'));
      $('#more-arrivals').addEventListener('click', () => activateSection('arrival-list'));

      // Convention tabs
      $$('.tab-btn[data-type]').forEach(btn => {
        btn.addEventListener('click', () => {
          $$('.tab-btn[data-type]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.ui.conventionTab = btn.getAttribute('data-type');
          renderConventionScroller();
        });
      });

      // Forms submit buttons (fallback si requestSubmit n'existe pas)
      const safeRequestSubmit = (form) => {
        if (!form) return;
        if (typeof form.requestSubmit === 'function') return form.requestSubmit();
        // fallback
        const btn = form.querySelector('button[type="submit"], input[type="submit"]');
        if (btn) btn.click();
        else form.submit();
      };
      $('#submit-imputation-form').addEventListener('click', () => safeRequestSubmit($('#imputation-form')));
      $('#submit-arrival-form').addEventListener('click', () => safeRequestSubmit($('#arrival-form')));
      $('#submit-convention-form').addEventListener('click', () => safeRequestSubmit($('#convention-form')));
      $('#submit-commission-form').addEventListener('click', () => safeRequestSubmit($('#commission-form')));

      // Forms reset
      $('#reset-imputation-form').addEventListener('click', resetImputationForm);
      $('#reset-arrival-form').addEventListener('click', resetArrivalForm);
      $('#reset-convention-form').addEventListener('click', resetConventionForm);
      $('#reset-commission-form').addEventListener('click', resetCommissionForm);

      // Form submit handlers
      $('#imputation-form').addEventListener('submit', handleImputationSubmit);
      $('#arrival-form').addEventListener('submit', handleArrivalSubmit);
      $('#convention-form').addEventListener('submit', handleConventionSubmit);
      $('#commission-form').addEventListener('submit', handleCommissionSubmit);

      // List actions
      $('#refresh-imputations').addEventListener('click', () => { loadAllData(); renderImputationsTable(); toast('success','Imputations','Liste actualisée.'); });
      $('#refresh-arrivals').addEventListener('click', () => { loadAllData(); renderArrivalsTable(); toast('success','Arrivées','Liste actualisée.'); });
      $('#refresh-conventions').addEventListener('click', () => { loadAllData(); renderConventionsTable(); toast('success','Conventions','Liste actualisée.'); });
      $('#refresh-commissions').addEventListener('click', () => { loadAllData(); renderCommissionsTable(); toast('success','Commissions','Liste actualisée.'); });

      // Search/filter listeners
      $('#imputation-search').addEventListener('input', () => renderImputationsTable());
      $('#imputation-filter').addEventListener('change', () => renderImputationsTable());
      $('#arrival-search').addEventListener('input', () => renderArrivalsTable());
      $('#convention-search').addEventListener('input', () => renderConventionsTable());
      $('#convention-filter').addEventListener('change', () => renderConventionsTable());
      $('#commission-search').addEventListener('input', () => renderCommissionsTable());

      // Print
      $('#print-imputations').addEventListener('click', () => printTable('Liste des imputations', $('#imputations-table')));
      $('#print-arrivals').addEventListener('click', () => printTable('Liste des courriers arrivés', $('#arrivals-table')));
      $('#print-conventions').addEventListener('click', () => printTable('Liste des conventions', $('#conventions-table')));
      $('#print-commissions').addEventListener('click', () => printTable('Liste des commissions', $('#commissions-table')));

      // Settings export/import/reset
      $('#export-data').addEventListener('click', exportData);
      $('#import-data').addEventListener('click', () => $('#import-file').click());
      $('#import-file').addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        importDataFromFile(f, function(){
          e.target.value = '';
        });
      });

      $('#reset-data').addEventListener('click', () => {
        if (!requireAdmin('La réinitialisation')) return;
        $('#confirm-modal-title').textContent = 'Effacer toutes les données';
        $('#confirm-modal-message').textContent = 'Cette action supprimera toutes les données (imputations, arrivées, conventions, commissions, activités).';
        state.confirmAction = () => {
          // Vider le store en mémoire (et synchroniser Firestore si activé)
          lsRemove(STORAGE.imputations);
          lsRemove(STORAGE.arrivals);
          lsRemove(STORAGE.conventions);
          lsRemove(STORAGE.commissions);
          lsRemove(STORAGE.activities);
          lsRemove(STORAGE.profile);
          lsRemove(STORAGE.theme);
          lsRemove(STORAGE.seeded);

          loadAllData();
          renderActivities();
          updateBadgesAndStats();
          renderDashboard();
          closeConfirm();
          toast('success', 'Réinitialisation', __dbReady ? 'Données effacées (Firebase synchronisé).' : 'Données effacées (mode mémoire).');
        };
        $('#confirm-modal-backdrop').classList.add('open');
      });

      // Deploy checklist refresh (Firebase card hidden when Firebase is disabled)
      const deployBtn = $('#deploy-check-refresh');
      if (deployBtn) deployBtn.addEventListener('click', () => updateDeployChecklist());

      // Profile photo (désactivé : avatars remplacés par des logos Invité/Admin)
      // Les boutons sont masqués dans applyAuthToUI().
      const changeBtn = $('#profile-change-photo');
      const deleteBtn = $('#profile-delete-photo');
      const photoInput = $('#profile-photo-input');
      if (changeBtn) changeBtn.addEventListener('click', () => {
        toast('info', 'Profil', 'La photo de profil est désactivée (logos Invité/Admin).');
      });
      if (deleteBtn) deleteBtn.addEventListener('click', () => {
        toast('info', 'Profil', 'La photo de profil est désactivée (logos Invité/Admin).');
      });
      if (photoInput) photoInput.addEventListener('change', (e) => { e.target.value = ''; });

      $('#save-profile').addEventListener('click', saveProfile);
      $('#security-form').addEventListener('submit', updatePassword);

      // Global search
      $('#global-search').addEventListener('keydown', (e) => {
        if (e.key === 'Enter'){
          e.preventDefault();
          runGlobalSearch($('#global-search').value);
        }
      });

      // Storage pill (Vercel KV)
      const pill = $('#firebase-pill');
      if (pill){
        const onPill = async () => {
          try{
            // If storage is active, go to settings
            if (__dbReady){
              activateSection('settings');
              toast('info', 'Stockage', 'Stockage Vercel actif.');
              return;
            }

            // Retry init
            toast('info', 'Stockage', 'Vérification du stockage…');
            await initRemoteStore();
            updateRemotePill();
            if (__dbReady) toast('success', 'Stockage', 'Synchronisation Vercel active (Postgres).');
            else toast('warn', 'Stockage', 'Persistance non configurée (Vercel Postgres/Neon).');
          }catch(e){
            try{ updateRemotePill(); }catch(_e){}
            toast('error', 'Stockage', 'Vérification impossible.');
          }
        };
        pill.addEventListener('click', onPill);
        pill.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            onPill();
          }
        });
      }
      try{ updateRemotePill(); }catch(e){}

      // Quick: Esc closes overlays
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape'){
          closeMobileSidebar();
          closeDetail();
          closeConfirm();
          closeAllDropdowns();
          $('#activity-feed').classList.remove('open');
          closeLogin();
        }
      });
      } catch(e){
        try{ console.error('[SDMFPIPPDC] bindUI error:', e); }catch(_e){}
      }
    }

    function updateFirebaseAlert(){
      // Firebase disabled.
      return;
    }

    function updateDeployChecklist(){
      // Firebase deploy card is hidden when Firebase is disabled.
      // Keep function for compatibility; do nothing.
      return;

      const set = (id, cls, text) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('ok','warn','err');
        if (cls) el.classList.add(cls);
        el.textContent = text;
      };

      // 1) Firebase config
      const hasCfg = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId);
      set('deploy-firebase-config', hasCfg ? 'ok' : 'warn', hasCfg ? 'OK' : 'DÉSACTIVÉ');

      // 2) Firestore status (écriture testée)
      if (!hasCfg){
        set('deploy-firestore', 'warn', 'INACTIF');
      } else {
        // __dbReady == écriture OK (self-test)
        if (__dbReady){
          set('deploy-firestore', 'ok', 'ACTIF');
        } else {
          // Si l'anonyme échoue, les règles demandent souvent request.auth != null
          const hint = (__remoteLastError && (__remoteLastError.code || __remoteLastError.message))
            ? String(__remoteLastError.code || __remoteLastError.message)
            : 'Règles/Firestore';

          // Erreur d'auth anonyme (cas le plus fréquent en prod)
          if (hint === 'auth/configuration-not-found' || hint.indexOf('auth/configuration-not-found') >= 0){
            set('deploy-firestore', 'err', 'AUTH');
            const el = document.getElementById('deploy-firestore');
            if (el) el.title = 'Activez Authentication > Anonymous dans Firebase Console.';
          } else {
            set('deploy-firestore', 'err', 'ERREUR');
            const el = document.getElementById('deploy-firestore');
            if (el) el.title = hint;
          }

          // Log + hint explicite
          try{ console.warn('[SDMFPIPPDC] Firestore inactive:', hint); }catch(e){}
        }
      }

      // Keep banner in sync
      try{ updateFirebaseAlert(); }catch(e){}

      // 3) Storage mode check (no localStorage)
      // We intentionally do NOT use localStorage in the app; verify by heuristic.
      let usesLocalStorage = false;
      try{
        const scripts = Array.from(document.querySelectorAll('script'));
        const inline = scripts.map(s => s.textContent || '').join('\n');
        usesLocalStorage = inline.includes('localStorage.');
      } catch(e){
        usesLocalStorage = false;
      }
      set('deploy-storage', usesLocalStorage ? 'err' : 'ok', usesLocalStorage ? 'LOCALSTORAGE' : (__dbReady ? 'FIRESTORE' : 'MÉMOIRE'));

      // Hint: si Firestore est KO, donner un indice en console
      if (hasCfg && !__dbReady && __remoteLastError){
        try{ console.warn('[SDMFPIPPDC] Firestore seems disabled by rules/config:', __remoteLastError); }catch(e){}
      }

      // 4) Security warning (demo admin auth)
      // Admin password is client-side demo; for production you should use Firebase Auth.
      const hasDemoAuth = true;
      set('deploy-security', hasDemoAuth ? 'warn' : 'ok', hasDemoAuth ? 'DÉMO' : 'OK');

      // 5) Scale warning (single doc storage)
      // This app stores everything in one Firestore doc when enabled -> 1MiB limit.
      const singleDoc = true;
      set('deploy-scale', singleDoc ? 'warn' : 'ok', singleDoc ? 'DOC UNIQUE' : 'COLLECTIONS');
    }

    function selfCheck(){
      // Non-blocking diagnostics (console only)
      try{
        const requiredIds = [
          'sidebar','sidebar-desktop-toggle','dashboard-section','loadingOverlay','loadingText',
          'notifications-trigger','notifications-dropdown','header-profile','profile-dropdown',
          'imputations-table','arrivals-table','conventions-table','commissions-table'
        ];

        const missing = requiredIds.filter(id => !document.getElementById(id));

        // Detect duplicate IDs
        const dup = [];
        const seen = Object.create(null);
        document.querySelectorAll('[id]').forEach(el => {
          const id = el.id;
          if (!id) return;
          seen[id] = (seen[id] || 0) + 1;
        });
        Object.keys(seen).forEach(id => { if (seen[id] > 1) dup.push({ id, count: seen[id] }); });

        // External libs health
        const libs = {
          chartJs: (typeof Chart !== 'undefined'),
          firebase: (typeof firebase !== 'undefined')
        };

        // Dropdown portal sanity (should be appended to body by bindUI)
        const notif = document.getElementById('notifications-dropdown');
        const prof = document.getElementById('profile-dropdown');
        const ddOk = (!!notif && notif.parentElement === document.body) && (!!prof && prof.parentElement === document.body);

        // Basic overflow-x detector (helps debug horizontal scrolling)
        let overflowX = false;
        try{
          const docW = document.documentElement.scrollWidth;
          const winW = window.innerWidth;
          overflowX = docW > winW + 2;
        }catch(e){}

        // Detect residual file inputs (pièces jointes) — should be removed in production
        const fileInputs = document.querySelectorAll('input[type="file"]');

        // Detect residual modern syntax in inline script (rough heuristic)
        let modernSyntax = false;
        try{
          const scripts = Array.from(document.querySelectorAll('script'));
          const inline = scripts.map(s => s.textContent || '').join('\n');
          modernSyntax = inline.includes('?.') || inline.includes('??');
        }catch(e){}

        const problems = (missing.length || dup.length || !libs.chartJs || overflowX || !ddOk || fileInputs.length || modernSyntax);

        if (problems){
          console.groupCollapsed('[SDMFPIPPDC] Self-check');
          if (missing.length) console.warn('IDs manquants:', missing);
          if (dup.length) console.warn('IDs dupliqués:', dup);
          if (!libs.chartJs) console.warn('Chart.js non chargé (CDN bloqué ?). Les graphiques seront désactivés.');
          if (!libs.firebase) console.info('Firebase non chargé (normal si vous n’utilisez pas Firestore).');
          if (!ddOk) console.warn('Dropdowns pas portés dans <body> (risque de clipping).');
          if (overflowX) console.warn('Overflow horizontal détecté: scrollWidth=', document.documentElement.scrollWidth, 'innerWidth=', window.innerWidth);
          if (fileInputs.length) console.warn('Inputs file détectés (pièces jointes) :', fileInputs.length);
          if (modernSyntax) console.warn('Syntaxe moderne détectée (?. ou ??). Risque sur navigateurs anciens.');
          console.groupEnd();
        } else {
          console.log('[SDMFPIPPDC] Self-check OK');
        }
      }catch(e){
        try{ console.warn('[SDMFPIPPDC] Self-check failed:', e); }catch(_e){}
      }
    }

    function init(){
      // Failsafe: ne jamais rester bloqué sur l'overlay si une erreur survient
      const failSafeTimer = setTimeout(() => {
        const ov = $('#loadingOverlay');
        if (ov && !ov.classList.contains('is-hidden')){
          ov.classList.add('is-hidden');
          try{ toast('error', 'Erreur de chargement', 'Initialisation trop longue. Vérifiez la console (F12) et la configuration Firebase/Firestore.'); }
          catch(e){}
        }
      }, 25000);

      try{
        // Debug minimal: confirme que le JS s’exécute
        try{ console.log('[SDMFPIPPDC] init()'); }catch(e){}

        // Afficher l’overlay pendant l’initialisation
        const ov0 = $('#loadingOverlay');
        const loadingText = $('#loadingText');
        if (ov0) ov0.classList.remove('is-hidden');
        if (loadingText) loadingText.textContent = 'Initialisation…';

        // Fallback: ensure boot class is removed even if something goes wrong
        setTimeout(() => { try{ document.body.classList.remove('app-boot'); }catch(e){} }, 2200);

        // 1) Démarrer le store distant (Firebase) si configuré
        initRemoteStore().then(() => {
          // Debug important: afficher la cause réelle dans la console
          try{
            console.log('[SDMFPIPPDC] Firebase cfg:', !!(FIREBASE_CONFIG && FIREBASE_CONFIG.projectId), FIREBASE_CONFIG && FIREBASE_CONFIG.projectId);
            console.log('[SDMFPIPPDC] Firestore conn:', __dbConn, 'writable:', __dbReady);
            if (__remoteLastError) console.warn('[SDMFPIPPDC] Firebase last error:', __remoteLastError);
            if (__authError) console.warn('[SDMFPIPPDC] Firebase auth error:', __authError);
          }catch(e){}

          if (loadingText) loadingText.textContent = __dbReady ? 'Connexion au stockage…' : 'Mode mémoire (Firestore indisponible)…';

          // 2) Thème (persisté si Firebase est configuré)
          setTheme(getTheme());
          syncColorSchemeToControls();

          if (loadingText) loadingText.textContent = 'Chargement des données…';

          // 3) Seed demo data (désactivé en production via ENABLE_DEMO_SEED)
          seedIfEmpty();

          // 4) Auth (non persisté)
          loadAuth();

          // 5) Charger les données métier
          loadAllData();
          renderActivities();

          if (loadingText) loadingText.textContent = 'Construction de l’interface…';

          // 6) Bind UI
          bindUI();
          selfCheck();
          updateDeployChecklist();

          // 7) Hide loading overlay (fade-out)
          setTimeout(() => {
            clearTimeout(failSafeTimer);
            const ov = $('#loadingOverlay');
            if (loadingText) loadingText.textContent = 'Prêt.';
            if (ov) ov.classList.add('is-hidden');

            // Trigger elegant page-load animation (remove boot class)
            document.body.classList.remove('app-boot');

            // Force l'affichage du tableau de bord
            activateSection('dashboard');

            try{
              renderDashboard();
            } catch(e){
              try{ console.error('[SDMFPIPPDC] renderDashboard error:', e); }catch(_e){}
              // Fallback visuel
              var dbg = document.getElementById('dashboard-section');
              if (dbg){
                var box = document.createElement('div');
                box.className = 'card';
                box.style.marginTop = '14px';
                box.innerHTML = '<div class="card__content"><b>Erreur dashboard</b><div style="color:var(--muted2); font-size:13px; margin-top:6px;">Le tableau de bord a rencontré une erreur JavaScript. Ouvrez la console (F12) pour le détail.</div></div>';
                dbg.appendChild(box);
              }
            }

            // Info mode de stockage
            try{ updateRemotePill(); }catch(e){}
            if (__dbReady){
              toast('success', 'Stockage', 'Synchronisation Vercel active.');
            } else {
              // Message clair: les données ne persisteront pas sans KV
              const codeOrMsg = (__remoteLastError && (__remoteLastError.code || __remoteLastError.message))
                ? String(__remoteLastError.code || __remoteLastError.message)
                : '';

              if (codeOrMsg.indexOf('pg_not_configured') >= 0){
                toast('warn', 'Stockage', 'Persistance désactivée: connectez Vercel Postgres (Neon) ou définissez DATABASE_URL / POSTGRES_URL.');
              } else if (codeOrMsg.indexOf('timeout') >= 0){
                toast('warn', 'Stockage', 'Timeout réseau (API /api/storage).');
              } else {
                const hint = codeOrMsg ? ('API /api/storage indisponible: ' + codeOrMsg) : 'Mode mémoire (persistance non configurée).';
                toast('warn', 'Stockage', hint);
              }
            }

            // Mode utilisateur
            toast('info', 'Mode invité', 'Connectez-vous en administrateur pour créer/modifier/supprimer.');
          }, 650);
        }).catch((err) => {
          clearTimeout(failSafeTimer);
          const ov = $('#loadingOverlay');
          if (ov) ov.classList.add('is-hidden');
          console.error('Init error:', err);
          try{ toast('error', 'Erreur', 'Initialisation impossible. Voir console (F12).'); } catch(e){}
        });
      } catch (err){
        clearTimeout(failSafeTimer);
        const ov = $('#loadingOverlay');
        if (ov) ov.classList.add('is-hidden');
        console.error('Init error:', err);
        try{ toast('error', 'Erreur', 'Initialisation impossible. Voir console (F12).'); } catch(e){}
      }
    }

    // --- Welcome screen orchestration ---
    function runWelcomeThenInit(){
      const ws = document.getElementById('welcome-screen');
      // If welcome is missing, just init.
      if (!ws){
        init();
        return;
      }

      // Lock UI behind welcome
      document.body.classList.add('welcome-active');

      let started = false;
      const startApp = () => {
        if (started) return;
        started = true;

        // Smooth exit
        ws.classList.add('is-hidden');
        // Ensure app is visible
        document.body.classList.remove('welcome-active');

        // Start the real app after small delay (let fade-out begin)
        setTimeout(() => {
          try{ ws.remove(); }catch(e){}
          init();
        }, 380);
      };

      // Auto start after a short welcome
      const autoT = setTimeout(startApp, 1700);
      ws.addEventListener('click', () => { clearTimeout(autoT); startApp(); }, { once:true });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'Escape'){
          clearTimeout(autoT);
          startApp();
        }
      }, { once:true });
    }

    runWelcomeThenInit();
  </script>
</body>
</html>
